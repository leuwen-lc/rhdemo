pipeline {
    agent any
    
    tools {
        jdk 'JDK21'  // Nom configur√© dans Jenkins Global Tool Configuration
        maven 'Maven3' // Nom configur√© dans Jenkins Global Tool Configuration
    }
    
    environment {
        // Configuration du pipeline
        APP_NAME = 'rhdemo-api'
        APP_VERSION = '0.0.1-SNAPSHOT'
        JAR_FILE = "rhDemo/target/rhdemoAPI-${APP_VERSION}.jar"
        
        // Configuration Docker
        DOCKER_IMAGE_NAME = "rhdemo-api"
        DOCKER_IMAGE_TAG = "${APP_VERSION}"
        DOCKER_REGISTRY = "" // Laisser vide pour Docker Hub ou sp√©cifier registry priv√©
        
        // Configuration des tests
        TEST_PORT = '9000'
        TEST_PROJECT_PATH = 'rhDemoAPITestIHM'
        
        // Fichiers de secrets SOPS
        SECRETS_FILE = 'rhDemo/secrets/secrets-staging.yml'
        SECRETS_DECRYPTED = 'rhDemo/secrets/secrets-decrypted.yml'
        
        // Configuration environnement staging (Docker Compose)
        STAGING_INFRA_PATH = 'rhDemo/infra/staging'
        KEYCLOAK_INIT_PATH = 'rhDemoInitKeycloak'
        TEST_DOMAIN = 'rhdemo.staging.local'
        KEYCLOAK_DOMAIN = 'keycloak.staging.local'
        COMPOSE_PROJECT_NAME = "rhdemo-staging-${env.BUILD_NUMBER}"
        RHDEMO_IMAGE = "${DOCKER_IMAGE_NAME}:build-${env.BUILD_NUMBER}"
    }
    
    parameters {
        choice(name: 'DEPLOY_ENV', choices: ['staging', 'production', 'none'], description: 'Environnement de d√©ploiement (staging par d√©faut)')
        booleanParam(name: 'RUN_SELENIUM_TESTS', defaultValue: true, description: 'Ex√©cuter les tests Selenium')
        booleanParam(name: 'RUN_SONAR', defaultValue: false, description: 'Ex√©cuter l\'analyse SonarQube')
        booleanParam(name: 'SKIP_MANUAL_APPROVAL', defaultValue: false, description: 'Ignorer l\'approbation manuelle pour la production')
    }
    
    stages {
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 1 : PR√âPARATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('üõ†Ô∏è Checkout') {
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 1 : PR√âPARATION'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                }
                checkout scm
                sh 'git log -1 --pretty=format:"%h - %an : %s"'
            }
        }
        
        stage('ÔøΩ D√©chiffrement Secrets SOPS') {
            steps {
                script {
                    echo '‚ñ∂ V√©rification SOPS et YQ...'
                }
                sh '''
                    sops --version
                    yq --version
                '''
                
                script {
                    echo '‚ñ∂ D√©chiffrement du fichier de secrets...'
                }
                
                // Utiliser le credential sops-age-key de mani√®re s√©curis√©e
                withCredentials([file(credentialsId: 'sops-age-key', variable: 'SOPS_AGE_KEY_FILE')]) {
                    sh '''
                        # Cr√©er le r√©pertoire secrets s'il n'existe pas
                        mkdir -p rhDemo/secrets
                        
                        # D√©chiffrer le fichier de secrets
                        echo "D√©chiffrement de ${SECRETS_FILE}..."
                        sops -d ${SECRETS_FILE} > ${SECRETS_DECRYPTED}
                        
                        # V√©rifier que le fichier a √©t√© d√©chiffr√©
                        if [ ! -f ${SECRETS_DECRYPTED} ]; then
                            echo "‚ùå √âchec du d√©chiffrement"
                            exit 1
                        fi
                        
                        echo "‚úÖ Secrets d√©chiffr√©s avec succ√®s"
                        
                        # Extraire les valeurs pour les variables d'environnement
                        # Exporter les secrets comme variables d'environnement pour les stages suivants
                        echo "export RHDEMO_DATASOURCE_PASSWORD_PG=$(yq eval '.rhdemo.datasource.password.pg' ${SECRETS_DECRYPTED})" > rhDemo/secrets/env-vars.sh
                        echo "export RHDEMO_DATASOURCE_PASSWORD_H2=$(yq eval '.rhdemo.datasource.password.h2' ${SECRETS_DECRYPTED})" >> rhDemo/secrets/env-vars.sh
                        echo "export RHDEMO_CLIENT_REGISTRATION_KEYCLOAK_CLIENT_SECRET=$(yq eval '.rhdemo.client.registration.keycloak.client.secret' ${SECRETS_DECRYPTED})" >> rhDemo/secrets/env-vars.sh
                        
                        # Mots de passe Keycloak pour environnement staging
                        echo "export KEYCLOAK_DB_PASSWORD=$(yq eval '.keycloak.db.password' ${SECRETS_DECRYPTED})" >> rhDemo/secrets/env-vars.sh
                        echo "export KEYCLOAK_ADMIN_PASSWORD=$(yq eval '.keycloak.admin.password' ${SECRETS_DECRYPTED})" >> rhDemo/secrets/env-vars.sh
                        echo "export KEYCLOAK_ADMIN_USER=$(yq eval '.keycloak.admin.user // "admin"' ${SECRETS_DECRYPTED})" >> rhDemo/secrets/env-vars.sh
                        
                        # Exporter les URLs des serveurs si elles existent dans le fichier de secrets
                        if yq eval '.rhdemo.servers.staging' ${SECRETS_DECRYPTED} > /dev/null 2>&1; then
                            echo "export STAGING_SERVER=$(yq eval '.rhdemo.servers.staging' ${SECRETS_DECRYPTED})" >> rhDemo/secrets/env-vars.sh
                        fi
                        
                        if yq eval '.rhdemo.servers.production' ${SECRETS_DECRYPTED} > /dev/null 2>&1; then
                            echo "export PROD_SERVER=$(yq eval '.rhdemo.servers.production' ${SECRETS_DECRYPTED})" >> rhDemo/secrets/env-vars.sh
                        fi
                        
                        # Afficher (sans montrer les valeurs)
                        echo "‚úÖ Variables d'environnement pr√©par√©es"
                    '''
                }
            }
            post {
                always {
                    script {
                        // Supprimer le fichier d√©chiffr√© pour la s√©curit√©
                        sh 'rm -f ${SECRETS_DECRYPTED} || true'
                    }
                }
            }
        }
        
        stage('ÔøΩüîç V√©rification Environnement') {
            steps {
                script {
                    echo '‚ñ∂ V√©rification de l\'environnement...'
                    // Charger les variables d'environnement depuis le fichier
                    sh '''
                        # Charger les secrets
                        . rhDemo/secrets/env-vars.sh
                        
                        echo "Java version:"
                        java -version
                        echo "\nMaven version:"
                        cd rhDemo && ./mvnw -version
                        echo "\nVariables d'environnement:"
                        env | grep RHDEMO || echo "Variables RHDEMO configur√©es"
                    '''
                }
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 2 : BUILD
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('üì¶ Compilation Backend') {
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 2 : BUILD'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '‚ñ∂ Compilation du backend Spring Boot...'
                }
                sh '''
                    # Charger les secrets pour la compilation
                    . rhDemo/secrets/env-vars.sh
                    cd rhDemo && ./mvnw clean compile -DskipTests
                '''
            }
        }
        
        stage('üé® Build Frontend Vue.js') {
            steps {
                script {
                    echo '‚ñ∂ Build du frontend Vue.js via Maven...'
                }
                sh '''
                    echo "Installation Node.js et build Vue.js automatique via frontend-maven-plugin"
                    cd rhDemo/frontend
                    ls -la node/ || echo "Node.js sera install√© par Maven"
                '''
            }
        }
        
        stage('üî® Build') {
            steps {
                script {
                    echo "üî® Compilation et packaging de l'application..."
                    sh """
                        . rhDemo/secrets/env-vars.sh
                        cd rhDemo && ./mvnw clean package -DskipTests
                    """
                }
            }
        }
        
        stage('üê≥ Build Docker Image (Paketo)') {
            steps {
                script {
                    echo "üê≥ Construction de l'image Docker avec Paketo Buildpacks..."
                    sh """
                        . rhDemo/secrets/env-vars.sh
                        cd rhDemo && ./mvnw spring-boot:build-image \
                            -Dspring-boot.build-image.imageName=${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} \
                            -DskipTests
                    """
                    
                    echo "‚úÖ Image Docker cr√©√©e: ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"
                    
                    // Lister les images cr√©√©es
                    sh "docker images | grep ${DOCKER_IMAGE_NAME} || true"
                }
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 3 : QUALIT√â DU CODE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('üß™ Tests Unitaires') {
            steps {
                script {
                    echo "üß™ Ex√©cution des tests unitaires..."
                    sh """
                        . rhDemo/secrets/env-vars.sh
                        cd rhDemo && ./mvnw test
                    """
                }
            }
        }
        
        stage('üîç Analyse SonarQube') {
            when {
                expression { params.RUN_SONAR == true }
            }
            steps {
                script {
                    echo '‚ñ∂ Analyse de qualit√© du code avec SonarQube...'
                }
                withSonarQubeEnv('SonarQube') {
                    sh '''
                        # Charger les secrets pour l'analyse
                        . rhDemo/secrets/env-vars.sh
                        cd rhDemo && ./mvnw sonar:sonar \
                            -Dsonar.projectKey=rhdemo-api \
                            -Dsonar.projectName="RHDemo API" \
                            -Dsonar.java.binaries=target/classes
                    '''
                }
            }
        }
        
        stage('üìä Quality Gate') {
            when {
                expression { params.RUN_SONAR == true }
            }
            steps {
                script {
                    echo '‚ñ∂ Attente du Quality Gate SonarQube...'
                }
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }
        
        stage('üìà Couverture de Code') {
            steps {
                script {
                    echo '‚ñ∂ G√©n√©ration du rapport de couverture JaCoCo...'
                }
                sh '''
                    # Charger les secrets pour le rapport
                    . rhDemo/secrets/env-vars.sh
                    cd rhDemo && ./mvnw jacoco:report
                '''
                jacoco(
                    execPattern: '**/rhDemo/target/jacoco.exec',
                    classPattern: '**/rhDemo/target/classes',
                    sourcePattern: '**/rhDemo/src/main/java'
                )
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 4 : ENVIRONNEMENT STAGING (DOCKER COMPOSE)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('‚öôÔ∏è Configuration Environnement Test') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 4 : ENVIRONNEMENT STAGING (DOCKER COMPOSE)'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '‚ñ∂ Configuration de l\'environnement de test Docker Compose...'
                    
                    // Nettoyer l'environnement pr√©c√©dent si existant
                    sh """
                        cd ${STAGING_INFRA_PATH}
                        
                        # Arr√™ter et supprimer les conteneurs du build pr√©c√©dent
                        docker-compose -p ${COMPOSE_PROJECT_NAME} down -v 2>/dev/null || true
                        
                        # Supprimer les volumes orphelins (cr√©√©s par builds pr√©c√©dents avec noms diff√©rents)
                        docker volume rm keycloak-staging-db-data rhdemo-staging-db-data rhdemo-staging-nginx-cache 2>/dev/null || true
                        
                        # Nettoyer les r√©seaux orphelins
                        docker network prune -f
                    """
                    
                    // Configuration du fichier hosts (si Jenkins tourne localement)
                    sh """
                        # V√©rifier si les entr√©es hosts existent
                        if ! grep -q "${TEST_DOMAIN}" /etc/hosts 2>/dev/null; then
                            echo "‚ö†Ô∏è  ATTENTION: Ajouter '127.0.0.1 ${TEST_DOMAIN} ${KEYCLOAK_DOMAIN}' √† /etc/hosts"
                        fi
                    """
                }
            }
        }
        
        stage('üîê G√©n√©ration Certificats SSL') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ñ∂ G√©n√©ration des certificats SSL auto-sign√©s...'
                }
                sh """
                    cd ${STAGING_INFRA_PATH}
                    ./generate-certs.sh --domain ${TEST_DOMAIN} --domain ${KEYCLOAK_DOMAIN}
                """
            }
        }
        
        stage('üè∑Ô∏è Tag Image Docker') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo "‚ñ∂ Tag de l'image Docker: ${RHDEMO_IMAGE}..."
                }
                sh """
                    docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} ${RHDEMO_IMAGE}
                """
            }
        }
        
        stage('üê≥ D√©marrage Environnement Docker') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ñ∂ D√©marrage de l\'environnement Docker Compose (5 services)...'
                }
                sh """
                    # Source les secrets SOPS
                    . rhDemo/secrets/env-vars.sh
                    cd ${STAGING_INFRA_PATH}
                    
                    # Variables d'environnement pour Docker Compose
                    export RHDEMO_IMAGE=${RHDEMO_IMAGE}
                    export WORKSPACE=\$(pwd)
                    
                    # Alias pour les variables attendues par docker-compose.yml
                    export RHDEMO_DB_PASSWORD="\${RHDEMO_DATASOURCE_PASSWORD_PG}"
                    export RHDEMO_CLIENT_SECRET="\${RHDEMO_CLIENT_REGISTRATION_KEYCLOAK_CLIENT_SECRET}"
                    
                    # Les variables Keycloak sont d√©j√† dans env-vars.sh avec les bons noms:
                    # KEYCLOAK_DB_PASSWORD, KEYCLOAK_ADMIN_PASSWORD, KEYCLOAK_ADMIN_USER
                    
                    docker-compose -f docker-compose.yml -f docker-compose.jenkins.yml -p ${COMPOSE_PROJECT_NAME} up -d
                    
                    echo "‚úÖ Services d√©marr√©s:"
                    docker-compose -p ${COMPOSE_PROJECT_NAME} ps
                """
            }
        }
        
        stage('üè• V√©rification Healthchecks') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ñ∂ Attente healthcheck des services...'
                }
                sh """
                    cd ${STAGING_INFRA_PATH}
                    
                    echo "‚è≥ Attente des bases de donn√©es (30s)..."
                    sleep 30
                    
                    echo "‚è≥ Attente Keycloak (60s max)..."
                    timeout=60
                    while [ \$timeout -gt 0 ]; do
                        if curl -k -f https://${KEYCLOAK_DOMAIN}/health/ready 2>/dev/null; then
                            echo "‚úÖ Keycloak ready"
                            break
                        fi
                        sleep 2
                        timeout=\$((timeout - 2))
                    done
                    
                    if [ \$timeout -le 0 ]; then
                        echo "‚ùå Keycloak timeout"
                        exit 1
                    fi
                    
                    echo "‚è≥ Attente RHDemo App (60s max)..."
                    timeout=60
                    while [ \$timeout -gt 0 ]; do
                        if curl -k -f https://${TEST_DOMAIN}/actuator/health 2>/dev/null; then
                            echo "‚úÖ RHDemo App ready"
                            break
                        fi
                        sleep 2
                        timeout=\$((timeout - 2))
                    done
                    
                    if [ \$timeout -le 0 ]; then
                        echo "‚ùå RHDemo App timeout"
                        exit 1
                    fi
                """
            }
        }
        
        stage('üîë Initialisation Keycloak') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ñ∂ Initialisation du realm Keycloak...'
                }
                sh """
                    cd ${STAGING_INFRA_PATH}
                    ./init-keycloak.sh --non-interactive
                    
                    if [ \$? -ne 0 ]; then
                        echo "‚ùå √âchec de l'initialisation Keycloak"
                        exit 1
                    fi
                    
                    echo "‚úÖ Keycloak initialis√© (realm RHDemo, 3 utilisateurs)"
                """
            }
        }
        
        stage('üíæ Initialisation Base de Donn√©es') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ñ∂ Initialisation de la base de donn√©es PostgreSQL...'
                }
                sh """
                    cd ${STAGING_INFRA_PATH}
                    ./init-database.sh --force
                    
                    if [ \$? -ne 0 ]; then
                        echo "‚ùå √âchec de l'initialisation de la base"
                        exit 1
                    fi
                    
                    echo "‚úÖ Base de donn√©es initialis√©e (303 employ√©s)"
                """
            }
        }
        
        stage('‚è±Ô∏è Stabilisation Environnement') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ñ∂ Stabilisation de l\'environnement (15s)...'
                }
                sh 'sleep 15'
                script {
                    echo '‚úÖ Environnement pr√™t pour les tests'
                }
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 5 : TESTS FONCTIONNELS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('üåê Tests Selenium IHM') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 5 : TESTS FONCTIONNELS'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '‚ñ∂ Ex√©cution des tests Selenium sur environnement Docker Compose...'
                }
                dir(TEST_PROJECT_PATH) {
                    sh """
                        . \${WORKSPACE}/rhDemo/secrets/env-vars.sh
                        
                        # Utilisation du wrapper Maven du projet principal
                        cd \${WORKSPACE}/rhDemo && ./mvnw clean test -f ../\${TEST_PROJECT_PATH}/pom.xml \\
                            -Dtest.baseurl=https://${TEST_DOMAIN} \\
                            -Dselenium.headless=true \\
                            -Dtest.keycloak.url=https://${KEYCLOAK_DOMAIN} \\
                            -Dtest.admin.user=admin \\
                            -Dtest.admin.password=\${KEYCLOAK_ADMIN_PASSWORD:-admin123} \\
                            -Dtest.consult.user=consultant \\
                            -Dtest.consult.password=consult123 \\
                            -Dtest.manager.user=manager \\
                            -Dtest.manager.password=manager123
                    """
                }
            }
            post {
                always {
                    script {
                        // Archivage des screenshots en cas d'√©chec
                        dir(TEST_PROJECT_PATH) {
                            archiveArtifacts artifacts: '**/screenshots/**/*.png', allowEmptyArchive: true
                            junit '**/target/surefire-reports/*.xml'
                        }
                    }
                }
            }
        }
        
        stage('üõë Arr√™t App Test') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ñ∂ Arr√™t de l\'application test...'
                    sh '''
                        if [ -f app-test.container ]; then
                            CONTAINER=$(cat app-test.container)
                            echo "Arr√™t du container: $CONTAINER"
                            docker stop $CONTAINER || echo "Container d√©j√† arr√™t√©"
                            docker rm $CONTAINER || echo "Container d√©j√† supprim√©"
                            rm app-test.container
                        fi
                    '''
                }
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 6 : S√âCURIT√â
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('üîí Scan Vuln√©rabilit√©s') {
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 6 : S√âCURIT√â'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '‚ñ∂ Analyse des vuln√©rabilit√©s des d√©pendances...'
                }
                sh '''
                    # Charger les secrets pour l'analyse de s√©curit√©
                    . rhDemo/secrets/env-vars.sh
                    cd rhDemo && ./mvnw org.owasp:dependency-check-maven:check
                '''
            }
            post {
                always {
                    publishHTML([
                        reportDir: 'rhDemo/target',
                        reportFiles: 'dependency-check-report.html',
                        reportName: 'OWASP Dependency Check',
                        allowMissing: true,
                        keepAll: true,
                        alwaysLinkToLastBuild: true
                    ])
                }
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 7 : ARCHIVAGE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('üìö Archivage Artifacts') {
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 7 : ARCHIVAGE'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '‚ñ∂ Archivage du JAR et des rapports...'
                }
                archiveArtifacts artifacts: "${JAR_FILE}", fingerprint: true
                archiveArtifacts artifacts: '**/target/surefire-reports/**', allowEmptyArchive: true
            }
        }
        
        stage('üìù G√©n√©ration Rapports') {
            steps {
                script {
                    echo '‚ñ∂ Publication des rapports...'
                }
                publishHTML([
                    reportDir: 'target/site/jacoco',
                    reportFiles: 'index.html',
                    reportName: 'Code Coverage',
                    allowMissing: true,
                    keepAll: true,
                    alwaysLinkToLastBuild: true
                ])
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 8 : D√âPLOIEMENT STAGING
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('üé≠ D√©ploiement Staging') {
            when {
                expression { params.DEPLOY_ENV == 'staging' || params.DEPLOY_ENV == 'production' }
            }
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 8 : D√âPLOIEMENT STAGING'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '‚ñ∂ D√©ploiement sur l\'environnement de staging...'
                }
                sh '''
                    # Charger les secrets et URLs de serveurs
                    . rhDemo/secrets/env-vars.sh
                    
                    # D√©ploiement via SSH ou script de d√©ploiement
                    echo "Copie du JAR vers le serveur de staging..."
                    # scp ${JAR_FILE} user@${STAGING_SERVER}:/opt/rhdemo/
                    
                    echo "Red√©marrage de l'application sur staging..."
                    # ssh user@${STAGING_SERVER} "systemctl restart rhdemo-api"
                    
                    echo "‚úÖ D√©ploiement staging simul√© (d√©commenter les commandes SSH)"
                '''
            }
        }
        
        stage('üí® Tests de Fum√©e Staging') {
            when {
                expression { params.DEPLOY_ENV == 'staging' || params.DEPLOY_ENV == 'production' }
            }
            steps {
                script {
                    echo '‚ñ∂ V√©rification du d√©ploiement staging...'
                }
                sh '''
                    # Charger les secrets et URLs de serveurs
                    . rhDemo/secrets/env-vars.sh
                    
                    echo "V√©rification du healthcheck..."
                    # curl -f http://${STAGING_SERVER}/actuator/health || exit 1
                    
                    echo "Test de l'authentification Keycloak..."
                    # Tests de base sur les endpoints critiques
                    
                    echo "‚úÖ Tests de fum√©e r√©ussis (d√©commenter pour activer)"
                '''
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 9 : PRODUCTION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('‚úã Validation Manuelle') {
            when {
                expression { 
                    params.DEPLOY_ENV == 'production' && params.SKIP_MANUAL_APPROVAL == false 
                }
            }
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 9 : PRODUCTION'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '‚ñ∂ Approbation manuelle requise pour la production...'
                }
                timeout(time: 30, unit: 'MINUTES') {
                    input message: 'D√©ployer en production ?', 
                          ok: 'D√©ployer',
                          submitter: 'admin,deploy-team'
                }
            }
        }
        
        stage('üíæ Backup Base de Donn√©es') {
            when {
                expression { params.DEPLOY_ENV == 'production' }
            }
            steps {
                script {
                    echo '‚ñ∂ Sauvegarde de la base de donn√©es de production...'
                }
                sh '''
                    # Charger les secrets
                    . rhDemo/secrets/env-vars.sh
                    
                    BACKUP_FILE="db-backup-$(date +%Y%m%d-%H%M%S).sql"
                    echo "Cr√©ation du backup: ${BACKUP_FILE}"
                    # pg_dump -h ${PROD_SERVER} -U rhdemo rhdemo > ${BACKUP_FILE}
                    echo "‚úÖ Backup cr√©√© (d√©commenter pour activer)"
                '''
            }
        }
        
        stage('üåê D√©ploiement Production') {
            when {
                expression { params.DEPLOY_ENV == 'production' }
            }
            steps {
                script {
                    echo '‚ñ∂ D√©ploiement en PRODUCTION...'
                    echo 'üöÄ D√©ploiement Blue-Green...'
                }
                sh '''
                    # Charger les secrets et URLs de serveurs
                    . rhDemo/secrets/env-vars.sh
                    
                    # Strat√©gie Blue-Green deployment
                    echo "1. D√©ploiement sur le serveur Green..."
                    # scp ${JAR_FILE} user@${PROD_SERVER}-green:/opt/rhdemo/
                    
                    echo "2. D√©marrage du nouveau service..."
                    # ssh user@${PROD_SERVER}-green "systemctl start rhdemo-api"
                    
                    echo "3. V√©rification du healthcheck..."
                    # curl -f http://${PROD_SERVER}-green/actuator/health
                    
                    echo "4. Basculement du load balancer..."
                    # Commande pour basculer le trafic
                    
                    echo "5. Arr√™t de l'ancien service (Blue)..."
                    # ssh user@${PROD_SERVER}-blue "systemctl stop rhdemo-api"
                    
                    echo "‚úÖ D√©ploiement production simul√© (d√©commenter pour activer)"
                '''
            }
        }
        
        stage('‚úÖ V√©rification Post-D√©ploiement') {
            when {
                expression { params.DEPLOY_ENV == 'production' }
            }
            steps {
                script {
                    echo '‚ñ∂ V√©rification du d√©ploiement production...'
                }
                sh '''
                    # Charger les secrets et URLs de serveurs
                    . rhDemo/secrets/env-vars.sh
                    
                    echo "Healthcheck application..."
                    # curl -f http://${PROD_SERVER}/actuator/health
                    
                    echo "V√©rification des m√©triques Prometheus..."
                    # curl -f http://${PROD_SERVER}/actuator/prometheus
                    
                    echo "Test des endpoints critiques..."
                    # Tests automatis√©s sur la production
                    
                    echo "‚úÖ Application en production fonctionnelle"
                '''
            }
        }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // POST-ACTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    post {
        always {
            script {
                echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                echo '  NETTOYAGE ET NOTIFICATIONS'
                echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                
                // PHASE 6 : Nettoyage de l'environnement Docker Compose
                if (params.RUN_SELENIUM_TESTS == true) {
                    echo '‚ñ∂ Nettoyage de l\'environnement Docker Compose...'
                    
                    // Afficher les logs si le build a √©chou√©
                    def buildResult = currentBuild.result ?: 'SUCCESS'
                    if (buildResult != 'SUCCESS') {
                        echo "üìã R√©cup√©ration des logs Docker (build ${buildResult})..."
                        sh """
                            cd ${STAGING_INFRA_PATH} || exit 0
                            docker-compose -p ${COMPOSE_PROJECT_NAME} logs --tail=100 || true
                        """
                    }
                    
                    // Nettoyage de l'environnement
                    sh """
                        cd ${STAGING_INFRA_PATH} || exit 0
                        
                        # Arr√™t et suppression des containers/volumes/networks
                        docker-compose -p ${COMPOSE_PROJECT_NAME} down -v 2>/dev/null || true
                        
                        # Suppression de l'image de build tagu√©e
                        docker rmi ${RHDEMO_IMAGE} 2>/dev/null || true
                        
                        echo "‚úÖ Environnement nettoy√©"
                    """
                }
                
                echo 'Note: Le nettoyage du workspace se fait automatiquement entre les builds'
            }
        }
        
        success {
            script {
                def deployInfo = params.DEPLOY_ENV != 'none' ? " et d√©ploy√© en ${params.DEPLOY_ENV}" : ""
                echo "‚úÖ Pipeline r√©ussi${deployInfo} !"
            }
            
            // Email de notification
            emailext(
                subject: "‚úÖ BUILD SUCCESS - RHDemo API #${env.BUILD_NUMBER}",
                body: """
                    Le build de RHDemo API a r√©ussi !
                    
                    Branch: ${env.BRANCH_NAME}
                    Commit: ${env.GIT_COMMIT}
                    D√©ploiement: ${params.DEPLOY_ENV}
                    
                    Voir les d√©tails: ${env.BUILD_URL}
                """,
                to: "${env.NOTIFICATION_EMAIL}"
            )
        }
        
        failure {
            script {
                echo "‚ùå Pipeline √©chou√© !"
            }
            
            // Email d'alerte
            emailext(
                subject: "‚ùå BUILD FAILED - RHDemo API #${env.BUILD_NUMBER}",
                body: """
                    ‚ö†Ô∏è Le build de RHDemo API a √©chou√© !
                    
                    Branch: ${env.BRANCH_NAME}
                    Stage: ${env.STAGE_NAME}
                    
                    Voir les logs: ${env.BUILD_URL}console
                """,
                to: "${env.NOTIFICATION_EMAIL}",
                attachLog: true
            )
        }
        
        unstable {
            script {
                echo "‚ö†Ô∏è Pipeline instable (tests √©chou√©s mais build r√©ussi)"
            }
        }
    }
}
