{{- if index .Values "postgresql-rhdemo" "enabled" }}
{{- if and (index .Values "postgresql-rhdemo").metrics (index .Values "postgresql-rhdemo").metrics.enabled }}
# ═══════════════════════════════════════════════════════════════
# ConfigMap pour les requêtes personnalisées de postgres_exporter
# ═══════════════════════════════════════════════════════════════
# Collecte les métriques pg_stat_statements pour identifier
# les requêtes les plus lentes et consommatrices de ressources.
#
# Les métriques sont exposées sur /metrics du sidecar postgres_exporter
# et collectées par Prometheus via le ServiceMonitor.
# ═══════════════════════════════════════════════════════════════
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-exporter-queries
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "postgresql-rhdemo.labels" . | nindent 4 }}
    app: postgresql-rhdemo
data:
  queries.yaml: |
    # ═══════════════════════════════════════════════════════════════
    # Requêtes personnalisées pour postgres_exporter
    # ═══════════════════════════════════════════════════════════════

    # Métriques des requêtes via pg_stat_statements
    pg_stat_statements:
      query: |
        SELECT
          pg_get_userbyid(userid) as user,
          datname as database,
          queryid,
          LEFT(query, 100) as query_sample,
          calls,
          total_exec_time / 1000 as total_time_seconds,
          mean_exec_time / 1000 as mean_time_seconds,
          min_exec_time / 1000 as min_time_seconds,
          max_exec_time / 1000 as max_time_seconds,
          stddev_exec_time / 1000 as stddev_time_seconds,
          rows,
          shared_blks_hit,
          shared_blks_read,
          shared_blks_written,
          local_blks_hit,
          local_blks_read,
          temp_blks_read,
          temp_blks_written
        FROM pg_stat_statements pss
        JOIN pg_database pd ON pss.dbid = pd.oid
        WHERE datname = '{{ (index .Values "postgresql-rhdemo").database.name }}'
        ORDER BY total_exec_time DESC
        LIMIT 20
      master: true
      metrics:
        - user:
            usage: "LABEL"
            description: "User who executed the query"
        - database:
            usage: "LABEL"
            description: "Database name"
        - queryid:
            usage: "LABEL"
            description: "Query ID"
        - query_sample:
            usage: "LABEL"
            description: "First 100 chars of the query"
        - calls:
            usage: "COUNTER"
            description: "Number of times executed"
        - total_time_seconds:
            usage: "COUNTER"
            description: "Total time spent in the statement, in seconds"
        - mean_time_seconds:
            usage: "GAUGE"
            description: "Mean time spent in the statement, in seconds"
        - min_time_seconds:
            usage: "GAUGE"
            description: "Minimum time spent in the statement, in seconds"
        - max_time_seconds:
            usage: "GAUGE"
            description: "Maximum time spent in the statement, in seconds"
        - stddev_time_seconds:
            usage: "GAUGE"
            description: "Standard deviation of time spent in the statement, in seconds"
        - rows:
            usage: "COUNTER"
            description: "Total number of rows retrieved or affected"
        - shared_blks_hit:
            usage: "COUNTER"
            description: "Total number of shared block cache hits"
        - shared_blks_read:
            usage: "COUNTER"
            description: "Total number of shared blocks read"
        - shared_blks_written:
            usage: "COUNTER"
            description: "Total number of shared blocks written"
        - local_blks_hit:
            usage: "COUNTER"
            description: "Total number of local block cache hits"
        - local_blks_read:
            usage: "COUNTER"
            description: "Total number of local blocks read"
        - temp_blks_read:
            usage: "COUNTER"
            description: "Total number of temp blocks read"
        - temp_blks_written:
            usage: "COUNTER"
            description: "Total number of temp blocks written"

    # Connexions actives par état
    pg_stat_activity_connections:
      query: |
        SELECT
          datname as database,
          state,
          COUNT(*) as connections
        FROM pg_stat_activity
        WHERE datname IS NOT NULL
        GROUP BY datname, state
      master: true
      metrics:
        - database:
            usage: "LABEL"
            description: "Database name"
        - state:
            usage: "LABEL"
            description: "Connection state"
        - connections:
            usage: "GAUGE"
            description: "Number of connections in this state"

    # Requêtes longues en cours
    pg_stat_activity_long_running:
      query: |
        SELECT
          datname as database,
          usename as user,
          pid,
          state,
          EXTRACT(EPOCH FROM (now() - query_start)) as duration_seconds,
          LEFT(query, 100) as query_sample
        FROM pg_stat_activity
        WHERE state != 'idle'
          AND query_start IS NOT NULL
          AND EXTRACT(EPOCH FROM (now() - query_start)) > 5
        ORDER BY duration_seconds DESC
        LIMIT 10
      master: true
      metrics:
        - database:
            usage: "LABEL"
            description: "Database name"
        - user:
            usage: "LABEL"
            description: "User name"
        - pid:
            usage: "LABEL"
            description: "Process ID"
        - state:
            usage: "LABEL"
            description: "Query state"
        - duration_seconds:
            usage: "GAUGE"
            description: "Query duration in seconds"
        - query_sample:
            usage: "LABEL"
            description: "First 100 chars of the query"

    # Statistiques des tables
    pg_stat_user_tables:
      query: |
        SELECT
          schemaname as schema,
          relname as table,
          seq_scan,
          seq_tup_read,
          idx_scan,
          idx_tup_fetch,
          n_tup_ins as inserts,
          n_tup_upd as updates,
          n_tup_del as deletes,
          n_live_tup as live_tuples,
          n_dead_tup as dead_tuples,
          EXTRACT(EPOCH FROM last_vacuum) as last_vacuum_epoch,
          EXTRACT(EPOCH FROM last_autovacuum) as last_autovacuum_epoch,
          EXTRACT(EPOCH FROM last_analyze) as last_analyze_epoch
        FROM pg_stat_user_tables
      master: true
      metrics:
        - schema:
            usage: "LABEL"
            description: "Schema name"
        - table:
            usage: "LABEL"
            description: "Table name"
        - seq_scan:
            usage: "COUNTER"
            description: "Number of sequential scans"
        - seq_tup_read:
            usage: "COUNTER"
            description: "Number of tuples read by sequential scans"
        - idx_scan:
            usage: "COUNTER"
            description: "Number of index scans"
        - idx_tup_fetch:
            usage: "COUNTER"
            description: "Number of tuples fetched by index scans"
        - inserts:
            usage: "COUNTER"
            description: "Number of rows inserted"
        - updates:
            usage: "COUNTER"
            description: "Number of rows updated"
        - deletes:
            usage: "COUNTER"
            description: "Number of rows deleted"
        - live_tuples:
            usage: "GAUGE"
            description: "Estimated number of live tuples"
        - dead_tuples:
            usage: "GAUGE"
            description: "Estimated number of dead tuples"
        - last_vacuum_epoch:
            usage: "GAUGE"
            description: "Last vacuum time (epoch)"
        - last_autovacuum_epoch:
            usage: "GAUGE"
            description: "Last autovacuum time (epoch)"
        - last_analyze_epoch:
            usage: "GAUGE"
            description: "Last analyze time (epoch)"

    # Taille des bases de données
    pg_database_size:
      query: |
        SELECT
          datname as database,
          pg_database_size(datname) as size_bytes
        FROM pg_database
        WHERE datname NOT IN ('template0', 'template1')
      master: true
      metrics:
        - database:
            usage: "LABEL"
            description: "Database name"
        - size_bytes:
            usage: "GAUGE"
            description: "Database size in bytes"

    # Verrous (locks)
    pg_locks:
      query: |
        SELECT
          pg_database.datname as database,
          mode,
          COUNT(*) as count
        FROM pg_locks
        JOIN pg_database ON pg_locks.database = pg_database.oid
        GROUP BY pg_database.datname, mode
      master: true
      metrics:
        - database:
            usage: "LABEL"
            description: "Database name"
        - mode:
            usage: "LABEL"
            description: "Lock mode"
        - count:
            usage: "GAUGE"
            description: "Number of locks"
{{- end }}
{{- end }}
