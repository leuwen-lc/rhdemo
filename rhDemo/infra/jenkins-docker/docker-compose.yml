services:
  # ═══════════════════════════════════════════════════════════════════
  # JENKINS CONTROLLER (master) - Pilotage uniquement
  # ═══════════════════════════════════════════════════════════════════
  # Le master ne fait qu'orchestrer les pipelines et gérer l'interface.
  # Tous les builds sont délégués à l'agent "builder" (sécurité).
  # ═══════════════════════════════════════════════════════════════════
  jenkins:
    build:
      context: .
      dockerfile: Dockerfile.jenkins
    image: rhdemo-jenkins:latest
    container_name: rhdemo-jenkins
    restart: unless-stopped
    stop_grace_period: 60s

    ports:
      - "8080:8080"      # Interface Web Jenkins
      - "50000:50000"    # Port agents Jenkins (WebSocket/JNLP)

    volumes:
      # Persistance des données Jenkins
      - jenkins_home:/var/jenkins_home

      # Configuration as Code (JCasC)
      - ./jenkins-casc.yaml:/var/jenkins_home/casc_configs/jenkins.yaml:ro

    environment:
      # Désactiver le setup wizard
      - JAVA_OPTS=-Djenkins.install.runSetupWizard=false

      # Configuration as Code
      - CASC_JENKINS_CONFIG=/var/jenkins_home/casc_configs

      # Credentials depuis .env (tokens gérés dans l'interface Jenkins)
      - JENKINS_ADMIN_USER=${JENKINS_ADMIN_USER:-admin}
      - JENKINS_ADMIN_PASSWORD=${JENKINS_ADMIN_PASSWORD:-admin123}

      # Timezone
      - TZ=${TZ:-Europe/Paris}

    networks:
      - jenkins-network

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/login || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # ═══════════════════════════════════════════════════════════════════
  # JENKINS AGENT (builder) - Exécution des pipelines CI/CD
  # ═══════════════════════════════════════════════════════════════════
  # Image personnalisée avec tous les outils nécessaires :
  # Maven, JDK 25, Docker, SOPS, Trivy, kubectl, Helm, Cosign,
  # Firefox/Selenium, Node.js, etc.
  #
  # CONFIGURATION DU SECRET :
  #   1. Démarrer Jenkins master : docker-compose up -d jenkins
  #   2. Aller dans Jenkins > Manage Jenkins > Nodes > builder
  #   3. Copier le secret affiché
  #   4. Mettre à jour JENKINS_SECRET dans .env
  #   5. Démarrer l'agent : docker-compose up -d jenkins-agent
  # ═══════════════════════════════════════════════════════════════════
  jenkins-agent:
    build:
      context: .
      dockerfile: Dockerfile.agent
    image: rhdemo-jenkins-agent:latest
    container_name: rhdemo-jenkins-agent
    restart: on-failure
    stop_grace_period: 30s

    # Exécuter en tant qu'utilisateur jenkins (non-root pour sécurité)
    user: jenkins

    # Ajouter le groupe docker avec le bon GID de l'hôte (984)
    group_add:
      - 984

    environment:
      - JENKINS_URL=http://jenkins:8080
      - JENKINS_AGENT_NAME=builder
      - JENKINS_AGENT_WORKDIR=/home/jenkins/agent
      - JENKINS_SECRET=${JENKINS_SECRET}
      - JENKINS_WEB_SOCKET=true

      # Configuration Docker
      - DOCKER_HOST=unix:///var/run/docker.sock

      # Timezone
      - TZ=${TZ:-Europe/Paris}

    volumes:
      # Socket Docker pour Docker-in-Docker (DinD)
      - /var/run/docker.sock:/var/run/docker.sock

      # Binaire Docker CLI
      - /usr/bin/docker:/usr/bin/docker

      # Workspace de l'agent
      - jenkins_agent_workspace:/home/jenkins/agent

      # Maven local repository (cache)
      - maven_repository:/home/jenkins/.m2

      # Certificat du registry pour cosign et curl (HTTPS)
      - ./certs/registry/registry.crt:/etc/ssl/certs/registry.crt:ro

    networks:
      - jenkins-network

    depends_on:
      jenkins:
        condition: service_healthy

  # ═══════════════════════════════════════════════════════════════════
  # SONARQUBE - Analyse qualité du code
  # ═══════════════════════════════════════════════════════════════════
  sonarqube:
    image: sonarqube:26.2.0.119303-community
    container_name: rhdemo-sonarqube
    restart: unless-stopped
    stop_grace_period: 30s  # Temps d'arrêt gracieux

    ports:
      - "9020:9000"

    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_extensions:/opt/sonarqube/extensions
      - sonarqube_logs:/opt/sonarqube/logs

    environment:
      - SONAR_JDBC_URL=jdbc:postgresql://sonarqube-db:5432/sonar
      - SONAR_JDBC_USERNAME=sonar
      - SONAR_JDBC_PASSWORD=${SONAR_DB_PASSWORD:-sonar123}
      - SONAR_WEB_PORT=9000
    
      # Limiter Elasticsearch (Search)
      - SONAR_SEARCH_JAVAOPTS=-Xms512m -Xmx512m
      # Limiter le Web
      # SONAR_WEB_JAVAOPTS=-Xms512m -Xmx512m
      # Limiter le Compute Engine
      # SONAR_CE_JAVAOPTS=-Xms512m -Xmx512m

    networks:
      - jenkins-network

    depends_on:
      sonarqube-db:
        condition: service_healthy

    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:9000/api/system/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # ═══════════════════════════════════════════════════════════════════
  # SONARQUBE DATABASE - PostgreSQL
  # ═══════════════════════════════════════════════════════════════════
  sonarqube-db:
    image: postgres:16-alpine
    container_name: rhdemo-sonarqube-db
    restart: unless-stopped

    volumes:
      - sonarqube_db:/var/lib/postgresql/data

    environment:
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=${SONAR_DB_PASSWORD:-sonar123}
      - POSTGRES_DB=sonar

    networks:
      - jenkins-network

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U sonar"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ═══════════════════════════════════════════════════════════════════
  # DOCKER REGISTRY LOCAL (HTTPS - pour stocker les images)
  # ═══════════════════════════════════════════════════════════════════
  # Prérequis: Générer les certificats avec ./init-registry-certs.sh
  # puis configurer Docker daemon (voir instructions dans le script)
  # ═══════════════════════════════════════════════════════════════════
  registry:
    image: registry:2
    container_name: kind-registry
    restart: unless-stopped

    ports:
      - "5000:5000"

    volumes:
      - registry_data:/var/lib/registry
      # Certificats TLS pour HTTPS
      - ./certs/registry:/certs:ro

    environment:
      - REGISTRY_STORAGE_DELETE_ENABLED=true
      # Configuration TLS
      - REGISTRY_HTTP_TLS_CERTIFICATE=/certs/registry.crt
      - REGISTRY_HTTP_TLS_KEY=/certs/registry.key

    networks:
      - jenkins-network

    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider --no-check-certificate https://localhost:5000/v2/ || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s


# ═══════════════════════════════════════════════════════════════════
# VOLUMES PERSISTANTS
# ═══════════════════════════════════════════════════════════════════
volumes:
  jenkins_home:
    name: rhdemo-jenkins-home
    driver: local

  jenkins_agent_workspace:
    name: rhdemo-jenkins-agent-workspace
    driver: local

  maven_repository:
    name: rhdemo-maven-repository
    driver: local

  sonarqube_data:
    name: rhdemo-sonarqube-data
    driver: local

  sonarqube_extensions:
    name: rhdemo-sonarqube-extensions
    driver: local

  sonarqube_logs:
    name: rhdemo-sonarqube-logs
    driver: local

  sonarqube_db:
    name: rhdemo-sonarqube-db
    driver: local

  registry_data:
    name: kind-registry-data
    driver: local

# ═══════════════════════════════════════════════════════════════════
# RÉSEAU
# ═══════════════════════════════════════════════════════════════════
networks:
  jenkins-network:
    name: rhdemo-jenkins-network
    driver: bridge
