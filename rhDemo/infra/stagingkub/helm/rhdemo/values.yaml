# ═══════════════════════════════════════════════════════════════
# Configuration globale
# ═══════════════════════════════════════════════════════════════
global:
  namespace: rhdemo-stagingkub
  environment: stagingkub
  domain: stagingkub.intra.leuwen-lc.fr

  # ── Images externes épinglées par digest (sha256) ──
  # Source unique pour toutes les images tierces du chart.
  # Format : image:tag@sha256:digest (tag conservé pour lisibilité)
  images:
    postgres: "postgres:18.2-alpine3.22@sha256:198c924aa928fecac4bddada3bf4634430aa137a5b1fb577c0d4b6d89a2b1599"
    keycloak: "quay.io/keycloak/keycloak:26.5.0@sha256:24896bcb632fa37445c8ca979886f5b2370651335b92ed72724369f8e5f56b4f"
    busybox: "busybox:1.36@sha256:0ad610868746fa822202c2052bb37f61272524ff4a4a3921edeeec7cd0a88c10"
    postgresExporter: "quay.io/prometheuscommunity/postgres-exporter:v0.19.0@sha256:e8a170b85eab07c75c2b0f3aa2806be5c2fe5bba46fd0336914e1f36572cde08"
  imagePullPolicy: IfNotPresent

# ═══════════════════════════════════════════════════════════════
# Backups PostgreSQL (CronJobs)
# ═══════════════════════════════════════════════════════════════
postgresqlBackup:
  enabled: true
  retentionDays: 7  # Garder les backups pendant 7 jours

  rhdemo:
    schedule: "0 2 * * *"  # 2h du matin tous les jours

  keycloak:
    schedule: "0 3 * * *"  # 3h du matin tous les jours

# ═══════════════════════════════════════════════════════════════
# PostgreSQL pour RHDemo
# ═══════════════════════════════════════════════════════════════
postgresql-rhdemo:
  enabled: true

  database:
    name: rhdemo
    user: rhdemo
    # Le mot de passe sera fourni via secret externe ou --set
    password: ""  # À fournir via --set ou secret
    passwordSecret:
      name: rhdemo-db-secret
      key: password

  persistence:
    enabled: true
    storageClass: ""  # Utilise le default storage class
    size: 2Gi
    accessMode: ReadWriteOnce

  resources:
    requests:
      memory: "256Mi"
      cpu: "250m"
    limits:
      memory: "512Mi"
      cpu: "500m"

  service:
    name: postgresql-rhdemo
    type: ClusterIP
    port: 5432

  # Configuration des métriques PostgreSQL via postgres_exporter
  # Expose les métriques pg_stat_statements pour identifier les requêtes lentes
  metrics:
    enabled: true
    serviceMonitor:
      enabled: true
      namespace: monitoring
      interval: 30s
      scrapeTimeout: 10s

# ═══════════════════════════════════════════════════════════════
# PostgreSQL pour Keycloak
# ═══════════════════════════════════════════════════════════════
postgresql-keycloak:
  enabled: true

  database:
    name: keycloak
    user: keycloak
    password: ""  # À fournir via --set ou secret
    passwordSecret:
      name: keycloak-db-secret
      key: password

  persistence:
    enabled: true
    storageClass: ""
    size: 2Gi
    accessMode: ReadWriteOnce

  resources:
    requests:
      memory: "256Mi"
      cpu: "250m"
    limits:
      memory: "512Mi"
      cpu: "500m"

  service:
    name: postgresql-keycloak
    type: ClusterIP
    port: 5432

# ═══════════════════════════════════════════════════════════════
# Keycloak - Serveur d'authentification
# ═══════════════════════════════════════════════════════════════
keycloak:
  enabled: true

  replicaCount: 1

  admin:
    user: admin
    # Le mot de passe sera fourni via secret
    passwordSecret:
      name: keycloak-admin-secret
      key: password

  database:
    host: postgresql-keycloak
    port: 5432
    name: keycloak
    user: keycloak
    passwordSecret:
      name: keycloak-db-secret
      key: password

  # Configuration hostname v2 (KC_HOSTNAME au lieu de KC_HOSTNAME_URL/KC_HOSTNAME_ADMIN_URL)
  hostname: keycloak-stagingkub.intra.leuwen-lc.fr

  proxyHeaders: xforwarded
  httpEnabled: true
  healthEnabled: true
  metricsEnabled: true

  logLevel: info

  resources:
    requests:
      memory: "512Mi"
      cpu: "500m"
    limits:
      memory: "1Gi"
      cpu: "1000m"

  service:
    type: ClusterIP
    port: 8080

  livenessProbe:
    initialDelaySeconds: 60
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 15

  readinessProbe:
    initialDelaySeconds: 60
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 15

# ═══════════════════════════════════════════════════════════════
# Application RHDemo
# ═══════════════════════════════════════════════════════════════
rhdemo:
  enabled: true
  image:
    repository: rhdemo-api
    tag: "1.1.0-SNAPSHOT"
    pullPolicy: IfNotPresent

  replicaCount: 1

  springProfile: stagingkub
  serverPort: 9000

  database:
    host: postgresql-rhdemo
    port: 5432
    name: rhdemo
    user: rhdemo
    passwordSecret:
      name: rhdemo-db-secret
      key: password

  keycloak:
    # La configuration Keycloak (issuer-uri, client-secret, etc.)
    # sera injectée via le secret secrets-rhdemo
    secretsFile:
      secretName: rhdemo-app-secrets
      mountPath: /workspace/secrets
      fileName: secrets-rhdemo.yml

  actuator:
    endpoints:
      include: "health,info,metrics,prometheus"
    health:
      showDetails: when_authorized

  # Configuration des métriques Prometheus
  metrics:
    serviceMonitor:
      enabled: true
      namespace: monitoring  # Namespace où Prometheus Operator est installé
      interval: 30s
      scrapeTimeout: 10s

  # Configuration des niveaux de logs
  logging:
    level:
      root: INFO
      org_springframework_web: INFO
      org_springframework_security: INFO
      org_springframework_security_oauth2: INFO
      org_springframework_web_client: INFO

  jvm:
    threadCount: 50
    maxRamPercentage: 75.0
    gcType: G1GC

  resources:
    requests:
      memory: "512Mi"
      cpu: "500m"
    limits:
      memory: "1Gi"
      cpu: "1000m"

  service:
    type: ClusterIP
    port: 9000

  livenessProbe:
    initialDelaySeconds: 60
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 3

  readinessProbe:
    initialDelaySeconds: 60
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 3

# ═══════════════════════════════════════════════════════════════
# Gateway API - Exposition HTTPS (NGINX Gateway Fabric 2.4.0)
# ═══════════════════════════════════════════════════════════════
# Utilise le shared-gateway créé par init-stagingkub.sh.
# Les HTTPRoutes s'attachent au Gateway partagé via parentRefs cross-namespace.
# Les headers X-Forwarded-* sont configurés automatiquement par NGF.
#
# Documentation: https://docs.nginx.com/nginx-gateway-fabric/
# ═══════════════════════════════════════════════════════════════
gateway:
  enabled: true

  # Shared Gateway (créé par init-stagingkub.sh dans nginx-gateway)
  # Gère le certificat TLS wildcard et le NodePort (32616)
  sharedGateway:
    name: shared-gateway
    namespace: nginx-gateway
    sectionName: https  # Nom du listener dans shared-gateway.yaml

  # Routes HTTP vers les services backend
  routes:
    - name: rhdemo-route
      hostname: rhdemo-stagingkub.intra.leuwen-lc.fr
      rules:
        - path: /
          pathType: PathPrefix
          serviceName: rhdemo-app
          servicePort: 9000

    - name: keycloak-route
      hostname: keycloak-stagingkub.intra.leuwen-lc.fr
      rules:
        - path: /
          pathType: PathPrefix
          serviceName: keycloak
          servicePort: 8080

  # ProxySettingsPolicy : buffers proxy pour Keycloak (NGF 2.4+)
  # Les gros cookies OAuth2 nécessitent des buffers plus grands
  # Cible l'HTTPRoute keycloak-route directement (pas besoin de SnippetsFilter)
  proxySettings:
    enabled: true
    bufferSize: "128k"
    buffersNumber: 4
    busyBuffersSize: "256k"

# ═══════════════════════════════════════════════════════════════
# NGINX Gateway Fabric 2.4.0 (référence)
# ═══════════════════════════════════════════════════════════════
# NGF est installé par init-stagingkub.sh dans le namespace nginx-gateway.
# Cette section documente la configuration utilisée (non appliquée par Helm).
# ═══════════════════════════════════════════════════════════════
nginx-gateway-fabric:
  enabled: false  # Installé par init-stagingkub.sh, pas par ce chart

  # Référence: configuration utilisée par init-stagingkub.sh
  # - service.type: NodePort
  # - NodePort 32616 → listener 443 (HTTPS)
  # - ProxySettingsPolicy pour les proxy buffers (remplace SnippetsFilter)

# ═══════════════════════════════════════════════════════════════
# Network Policies - Sécurité réseau
# ═══════════════════════════════════════════════════════════════
# Active les NetworkPolicies pour isoler les pods et contrôler
# les flux réseau selon le principe du moindre privilège.
#
# Stratégie: Zero Trust / Default Deny
#   1. Tout trafic est bloqué par défaut (ingress + egress)
#   2. Chaque flux légitime est explicitement autorisé
#   3. L'accès Internet est bloqué (sauf DNS)
#
# Voir: docs/NETWORK_SECURITY_POLICY.md pour les détails des flux
# ═══════════════════════════════════════════════════════════════
networkPolicies:
  # Activer/désactiver toutes les NetworkPolicies
  # ATTENTION: Désactiver = pas d'isolation réseau
  enabled: true

  # Configuration spécifique Keycloak (accès externes optionnels)
  keycloak:
    # Autoriser l'envoi d'emails via SMTP
    # Nécessite de spécifier le CIDR du serveur SMTP
    allowSmtp: false
    smtpCidr: "0.0.0.0/32"  # À remplacer par l'IP du serveur SMTP

    # Autoriser la connexion LDAP/Active Directory
    # Nécessite de spécifier le CIDR du serveur LDAP
    allowLdap: false
    ldapCidr: "0.0.0.0/32"  # À remplacer par l'IP du serveur LDAP
