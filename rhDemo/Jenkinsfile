pipeline {
    agent any
    
    tools {
        jdk 'JDK21'  // Nom configur√© dans Jenkins Global Tool Configuration
        maven 'Maven3' // Nom configur√© dans Jenkins Global Tool Configuration
    }
    
    environment {
        // Configuration du pipeline
        APP_NAME = 'rhdemo-api'
        APP_VERSION = '0.0.1-SNAPSHOT'
        JAR_FILE = "target/rhdemoAPI-${APP_VERSION}.jar"
        
        // Configuration des tests
        TEST_PORT = '9000'
        TEST_PROJECT_PATH = '../rhDemoAPITestIHM'
        
        // Fichiers de secrets SOPS
        SECRETS_FILE = 'secrets/secrets-staging.yml'
        SECRETS_DECRYPTED = 'secrets/secrets-decrypted.yml'
        
        // Cl√© Age pour SOPS (credential Jenkins)
        SOPS_AGE_KEY_FILE = credentials('sops-age-key')
    }
    
    parameters {
        choice(name: 'DEPLOY_ENV', choices: ['none', 'staging', 'production'], description: 'Environnement de d√©ploiement')
        booleanParam(name: 'RUN_SELENIUM_TESTS', defaultValue: true, description: 'Ex√©cuter les tests Selenium')
        booleanParam(name: 'RUN_SONAR', defaultValue: false, description: 'Ex√©cuter l\'analyse SonarQube')
        booleanParam(name: 'SKIP_MANUAL_APPROVAL', defaultValue: false, description: 'Ignorer l\'approbation manuelle pour la production')
    }
    
    stages {
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 1 : PR√âPARATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('üõ†Ô∏è Checkout') {
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 1 : PR√âPARATION'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                }
                checkout scm
                sh 'git log -1 --pretty=format:"%h - %an : %s"'
            }
        }
        
        stage('ÔøΩ D√©chiffrement Secrets SOPS') {
            steps {
                script {
                    echo '‚ñ∂ Installation et configuration de SOPS...'
                }
                sh '''
                    # Installation de SOPS si n√©cessaire
                    if ! command -v sops &> /dev/null; then
                        echo "Installation de SOPS..."
                        SOPS_VERSION="3.8.1"
                        wget -q https://github.com/mozilla/sops/releases/download/v${SOPS_VERSION}/sops-v${SOPS_VERSION}.linux.amd64 -O /tmp/sops
                        chmod +x /tmp/sops
                        sudo mv /tmp/sops /usr/local/bin/sops
                    fi
                    
                    echo "SOPS version:"
                    sops --version
                '''
                
                script {
                    echo '‚ñ∂ D√©chiffrement du fichier de secrets...'
                }
                sh '''
                    # Configurer la cl√© Age pour SOPS
                    export SOPS_AGE_KEY_FILE="${SOPS_AGE_KEY_FILE}"
                    
                    # D√©chiffrer le fichier de secrets
                    echo "D√©chiffrement de ${SECRETS_FILE}..."
                    sops -d ${SECRETS_FILE} > ${SECRETS_DECRYPTED}
                    
                    # V√©rifier que le fichier a √©t√© d√©chiffr√©
                    if [ ! -f ${SECRETS_DECRYPTED} ]; then
                        echo "‚ùå √âchec du d√©chiffrement"
                        exit 1
                    fi
                    
                    echo "‚úÖ Secrets d√©chiffr√©s avec succ√®s"
                    
                    # Extraire les valeurs pour les variables d'environnement
                    # Utilisation de yq pour parser le YAML
                    if ! command -v yq &> /dev/null; then
                        echo "Installation de yq..."
                        wget -q https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /tmp/yq
                        chmod +x /tmp/yq
                        sudo mv /tmp/yq /usr/local/bin/yq
                    fi
                    
                    # Exporter les secrets comme variables d'environnement pour les stages suivants
                    echo "export RHDEMO_DATASOURCE_PASSWORD_PG=$(yq eval '.rhdemo.datasource.password.pg' ${SECRETS_DECRYPTED})" > secrets/env-vars.sh
                    echo "export RHDEMO_DATASOURCE_PASSWORD_H2=$(yq eval '.rhdemo.datasource.password.h2' ${SECRETS_DECRYPTED})" >> secrets/env-vars.sh
                    echo "export RHDEMO_CLIENT_REGISTRATION_KEYCLOAK_CLIENT_SECRET=$(yq eval '.rhdemo.client.registration.keycloak.client.secret' ${SECRETS_DECRYPTED})" >> secrets/env-vars.sh
                    
                    # Exporter les URLs des serveurs si elles existent dans le fichier de secrets
                    if yq eval '.rhdemo.servers.staging' ${SECRETS_DECRYPTED} > /dev/null 2>&1; then
                        echo "export STAGING_SERVER=$(yq eval '.rhdemo.servers.staging' ${SECRETS_DECRYPTED})" >> secrets/env-vars.sh
                    fi
                    
                    if yq eval '.rhdemo.servers.production' ${SECRETS_DECRYPTED} > /dev/null 2>&1; then
                        echo "export PROD_SERVER=$(yq eval '.rhdemo.servers.production' ${SECRETS_DECRYPTED})" >> secrets/env-vars.sh
                    fi
                    
                    # Afficher (sans montrer les valeurs)
                    echo "‚úÖ Variables d'environnement pr√©par√©es"
                '''
            }
            post {
                always {
                    script {
                        // Supprimer le fichier d√©chiffr√© pour la s√©curit√©
                        sh 'rm -f ${SECRETS_DECRYPTED} || true'
                    }
                }
            }
        }
        
        stage('ÔøΩüîç V√©rification Environnement') {
            steps {
                script {
                    echo '‚ñ∂ V√©rification de l\'environnement...'
                    // Charger les variables d'environnement depuis le fichier
                    sh '''
                        # Charger les secrets
                        source secrets/env-vars.sh
                        
                        echo "Java version:"
                        java -version
                        echo "\nMaven version:"
                        ./mvnw -version
                        echo "\nVariables d'environnement:"
                        env | grep RHDEMO || echo "Variables RHDEMO configur√©es"
                    '''
                }
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 2 : BUILD
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('üì¶ Compilation Backend') {
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 2 : BUILD'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '‚ñ∂ Compilation du backend Spring Boot...'
                }
                sh '''
                    # Charger les secrets pour la compilation
                    source secrets/env-vars.sh
                    ./mvnw clean compile -DskipTests
                '''
            }
        }
        
        stage('üé® Build Frontend Vue.js') {
            steps {
                script {
                    echo '‚ñ∂ Build du frontend Vue.js via Maven...'
                }
                sh '''
                    echo "Installation Node.js et build Vue.js automatique via frontend-maven-plugin"
                    cd frontend
                    ls -la node/ || echo "Node.js sera install√© par Maven"
                '''
            }
        }
        
        stage('üì¶ Package Complet') {
            steps {
                script {
                    echo '‚ñ∂ Package du JAR avec frontend int√©gr√©...'
                }
                sh '''
                    # Charger les secrets pour le package
                    source secrets/env-vars.sh
                    ./mvnw package -DskipTests
                    ls -lh ${JAR_FILE}
                '''
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 3 : QUALIT√â DU CODE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('üß™ Tests Unitaires') {
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 3 : QUALIT√â DU CODE'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '‚ñ∂ Ex√©cution des tests unitaires avec base H2...'
                }
                sh '''
                    # Charger les secrets pour les tests
                    source secrets/env-vars.sh
                    ./mvnw test
                '''
            }
            post {
                always {
                    junit '**/target/surefire-reports/*.xml'
                    script {
                        echo '‚úÖ Rapports de tests JUnit g√©n√©r√©s'
                    }
                }
            }
        }
        
        stage('üîç Analyse SonarQube') {
            when {
                expression { params.RUN_SONAR == true }
            }
            steps {
                script {
                    echo '‚ñ∂ Analyse de qualit√© du code avec SonarQube...'
                }
                withSonarQubeEnv('SonarQube') {
                    sh '''
                        # Charger les secrets pour l'analyse
                        source secrets/env-vars.sh
                        ./mvnw sonar:sonar \
                            -Dsonar.projectKey=rhdemo-api \
                            -Dsonar.projectName="RHDemo API" \
                            -Dsonar.java.binaries=target/classes
                    '''
                }
            }
        }
        
        stage('üìä Quality Gate') {
            when {
                expression { params.RUN_SONAR == true }
            }
            steps {
                script {
                    echo '‚ñ∂ Attente du Quality Gate SonarQube...'
                }
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }
        
        stage('üìà Couverture de Code') {
            steps {
                script {
                    echo '‚ñ∂ G√©n√©ration du rapport de couverture JaCoCo...'
                }
                sh '''
                    # Charger les secrets pour le rapport
                    source secrets/env-vars.sh
                    ./mvnw jacoco:report
                '''
                jacoco(
                    execPattern: '**/target/jacoco.exec',
                    classPattern: '**/target/classes',
                    sourcePattern: '**/src/main/java'
                )
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 4 : TESTS FONCTIONNELS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('üöÄ D√©marrage App Test') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 4 : TESTS FONCTIONNELS'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '‚ñ∂ D√©marrage de l\'application en mode test...'
                    
                    // D√©marrage en arri√®re-plan
                    sh '''
                        # Charger les secrets pour l'application test
                        source secrets/env-vars.sh
                        nohup java -jar ${JAR_FILE} \
                            --spring.profiles.active=test \
                            --server.port=${TEST_PORT} \
                            > app-test.log 2>&1 &
                        echo $! > app-test.pid
                    '''
                    
                    // Attente de disponibilit√©
                    sh '''
                        echo "Attente du d√©marrage de l'application..."
                        for i in {1..60}; do
                            if curl -s http://localhost:${TEST_PORT}/actuator/health > /dev/null; then
                                echo "‚úÖ Application d√©marr√©e avec succ√®s!"
                                exit 0
                            fi
                            echo "Tentative $i/60..."
                            sleep 2
                        done
                        echo "‚ùå √âchec du d√©marrage de l'application"
                        exit 1
                    '''
                }
            }
        }
        
        stage('üåê Tests Selenium IHM') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ñ∂ Ex√©cution des tests Selenium...'
                }
                dir(TEST_PROJECT_PATH) {
                    sh '''
                        # Utilisation du wrapper Maven du projet principal
                        /home/leno-vo/git/repository/rhdemo/mvnw clean test \
                            -Dtest.baseurl=http://localhost:${TEST_PORT} \
                            -Dselenium.headless=true
                    '''
                }
            }
            post {
                always {
                    script {
                        // Archivage des screenshots en cas d'√©chec
                        dir(TEST_PROJECT_PATH) {
                            archiveArtifacts artifacts: '**/screenshots/**/*.png', allowEmptyArchive: true
                            junit '**/target/surefire-reports/*.xml'
                        }
                    }
                }
            }
        }
        
        stage('üõë Arr√™t App Test') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ñ∂ Arr√™t de l\'application test...'
                    sh '''
                        if [ -f app-test.pid ]; then
                            PID=$(cat app-test.pid)
                            kill $PID || echo "Processus d√©j√† arr√™t√©"
                            rm app-test.pid
                        fi
                    '''
                }
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 5 : S√âCURIT√â
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('üîí Scan Vuln√©rabilit√©s') {
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 5 : S√âCURIT√â'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '‚ñ∂ Analyse des vuln√©rabilit√©s des d√©pendances...'
                }
                sh '''
                    # Charger les secrets pour l'analyse de s√©curit√©
                    source secrets/env-vars.sh
                    ./mvnw org.owasp:dependency-check-maven:check
                '''
            }
            post {
                always {
                    publishHTML([
                        reportDir: 'target',
                        reportFiles: 'dependency-check-report.html',
                        reportName: 'OWASP Dependency Check',
                        allowMissing: true,
                        keepAll: true,
                        alwaysLinkToLastBuild: true
                    ])
                }
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 6 : ARCHIVAGE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('üìö Archivage Artifacts') {
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 6 : ARCHIVAGE'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '‚ñ∂ Archivage du JAR et des rapports...'
                }
                archiveArtifacts artifacts: "${JAR_FILE}", fingerprint: true
                archiveArtifacts artifacts: '**/target/surefire-reports/**', allowEmptyArchive: true
            }
        }
        
        stage('üìù G√©n√©ration Rapports') {
            steps {
                script {
                    echo '‚ñ∂ Publication des rapports...'
                }
                publishHTML([
                    reportDir: 'target/site/jacoco',
                    reportFiles: 'index.html',
                    reportName: 'Code Coverage',
                    allowMissing: true,
                    keepAll: true,
                    alwaysLinkToLastBuild: true
                ])
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 7 : D√âPLOIEMENT STAGING
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('üé≠ D√©ploiement Staging') {
            when {
                expression { params.DEPLOY_ENV == 'staging' || params.DEPLOY_ENV == 'production' }
            }
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 7 : D√âPLOIEMENT STAGING'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '‚ñ∂ D√©ploiement sur l\'environnement de staging...'
                }
                sh '''
                    # Charger les secrets et URLs de serveurs
                    source secrets/env-vars.sh
                    
                    # D√©ploiement via SSH ou script de d√©ploiement
                    echo "Copie du JAR vers le serveur de staging..."
                    # scp ${JAR_FILE} user@${STAGING_SERVER}:/opt/rhdemo/
                    
                    echo "Red√©marrage de l'application sur staging..."
                    # ssh user@${STAGING_SERVER} "systemctl restart rhdemo-api"
                    
                    echo "‚úÖ D√©ploiement staging simul√© (d√©commenter les commandes SSH)"
                '''
            }
        }
        
        stage('üí® Tests de Fum√©e Staging') {
            when {
                expression { params.DEPLOY_ENV == 'staging' || params.DEPLOY_ENV == 'production' }
            }
            steps {
                script {
                    echo '‚ñ∂ V√©rification du d√©ploiement staging...'
                }
                sh '''
                    # Charger les secrets et URLs de serveurs
                    source secrets/env-vars.sh
                    
                    echo "V√©rification du healthcheck..."
                    # curl -f http://${STAGING_SERVER}/actuator/health || exit 1
                    
                    echo "Test de l'authentification Keycloak..."
                    # Tests de base sur les endpoints critiques
                    
                    echo "‚úÖ Tests de fum√©e r√©ussis (d√©commenter pour activer)"
                '''
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 8 : PRODUCTION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('‚úã Validation Manuelle') {
            when {
                expression { 
                    params.DEPLOY_ENV == 'production' && params.SKIP_MANUAL_APPROVAL == false 
                }
            }
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 8 : PRODUCTION'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '‚ñ∂ Approbation manuelle requise pour la production...'
                }
                timeout(time: 30, unit: 'MINUTES') {
                    input message: 'D√©ployer en production ?', 
                          ok: 'D√©ployer',
                          submitter: 'admin,deploy-team'
                }
            }
        }
        
        stage('üíæ Backup Base de Donn√©es') {
            when {
                expression { params.DEPLOY_ENV == 'production' }
            }
            steps {
                script {
                    echo '‚ñ∂ Sauvegarde de la base de donn√©es de production...'
                }
                sh '''
                    # Charger les secrets
                    source secrets/env-vars.sh
                    
                    BACKUP_FILE="db-backup-$(date +%Y%m%d-%H%M%S).sql"
                    echo "Cr√©ation du backup: ${BACKUP_FILE}"
                    # pg_dump -h ${PROD_SERVER} -U rhdemo rhdemo > ${BACKUP_FILE}
                    echo "‚úÖ Backup cr√©√© (d√©commenter pour activer)"
                '''
            }
        }
        
        stage('üåê D√©ploiement Production') {
            when {
                expression { params.DEPLOY_ENV == 'production' }
            }
            steps {
                script {
                    echo '‚ñ∂ D√©ploiement en PRODUCTION...'
                    echo 'üöÄ D√©ploiement Blue-Green...'
                }
                sh '''
                    # Charger les secrets et URLs de serveurs
                    source secrets/env-vars.sh
                    
                    # Strat√©gie Blue-Green deployment
                    echo "1. D√©ploiement sur le serveur Green..."
                    # scp ${JAR_FILE} user@${PROD_SERVER}-green:/opt/rhdemo/
                    
                    echo "2. D√©marrage du nouveau service..."
                    # ssh user@${PROD_SERVER}-green "systemctl start rhdemo-api"
                    
                    echo "3. V√©rification du healthcheck..."
                    # curl -f http://${PROD_SERVER}-green/actuator/health
                    
                    echo "4. Basculement du load balancer..."
                    # Commande pour basculer le trafic
                    
                    echo "5. Arr√™t de l'ancien service (Blue)..."
                    # ssh user@${PROD_SERVER}-blue "systemctl stop rhdemo-api"
                    
                    echo "‚úÖ D√©ploiement production simul√© (d√©commenter pour activer)"
                '''
            }
        }
        
        stage('‚úÖ V√©rification Post-D√©ploiement') {
            when {
                expression { params.DEPLOY_ENV == 'production' }
            }
            steps {
                script {
                    echo '‚ñ∂ V√©rification du d√©ploiement production...'
                }
                sh '''
                    # Charger les secrets et URLs de serveurs
                    source secrets/env-vars.sh
                    
                    echo "Healthcheck application..."
                    # curl -f http://${PROD_SERVER}/actuator/health
                    
                    echo "V√©rification des m√©triques Prometheus..."
                    # curl -f http://${PROD_SERVER}/actuator/prometheus
                    
                    echo "Test des endpoints critiques..."
                    # Tests automatis√©s sur la production
                    
                    echo "‚úÖ Application en production fonctionnelle"
                '''
            }
        }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // POST-ACTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    post {
        always {
            script {
                echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                echo '  NETTOYAGE ET NOTIFICATIONS'
                echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
            }
            // Nettoyage des fichiers sensibles
            sh '''
                # Supprimer les fichiers de secrets d√©chiffr√©s
                rm -f secrets/env-vars.sh secrets/secrets-decrypted.yml || true
                
                # Arr√™t de l'application test si elle tourne encore
                if [ -f app-test.pid ]; then
                    kill $(cat app-test.pid) 2>/dev/null || true
                    rm app-test.pid
                fi
                
                # Nettoyage des logs
                rm -f app-test.log
            '''
            
            // Nettoyage du workspace (optionnel)
            cleanWs(
                deleteDirs: true,
                patterns: [
                    [pattern: 'target/**', type: 'INCLUDE'],
                    [pattern: '**/node_modules/**', type: 'INCLUDE']
                ]
            )
        }
        
        success {
            script {
                def deployInfo = params.DEPLOY_ENV != 'none' ? " et d√©ploy√© en ${params.DEPLOY_ENV}" : ""
                echo "‚úÖ Pipeline r√©ussi${deployInfo} !"
            }
            
            // Email de notification
            emailext(
                subject: "‚úÖ BUILD SUCCESS - RHDemo API #${env.BUILD_NUMBER}",
                body: """
                    Le build de RHDemo API a r√©ussi !
                    
                    Branch: ${env.BRANCH_NAME}
                    Commit: ${env.GIT_COMMIT}
                    D√©ploiement: ${params.DEPLOY_ENV}
                    
                    Voir les d√©tails: ${env.BUILD_URL}
                """,
                to: 'team@example.com'
            )
        }
        
        failure {
            script {
                echo "‚ùå Pipeline √©chou√© !"
            }
            
            // Email d'alerte
            emailext(
                subject: "‚ùå BUILD FAILED - RHDemo API #${env.BUILD_NUMBER}",
                body: """
                    ‚ö†Ô∏è Le build de RHDemo API a √©chou√© !
                    
                    Branch: ${env.BRANCH_NAME}
                    Stage: ${env.STAGE_NAME}
                    
                    Voir les logs: ${env.BUILD_URL}console
                """,
                to: 'team@example.com',
                attachLog: true
            )
        }
        
        unstable {
            script {
                echo "‚ö†Ô∏è Pipeline instable (tests √©chou√©s mais build r√©ussi)"
            }
        }
    }
}
