{{- if (index .Values "postgresql-rhdemo").enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgresql-rhdemo-init
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "postgresql-rhdemo.labels" . | nindent 4 }}
    app: postgresql-rhdemo
data:
  # Script d'initialisation de la base de donnÃ©es (SCHÃ‰MA UNIQUEMENT)
  # Ce script sera exÃ©cutÃ© automatiquement par PostgreSQL au premier dÃ©marrage
  # Il crÃ©e la structure de la base (tables, index) UNIQUEMENT si elle n'existe pas
  # Cela prÃ©serve les donnÃ©es existantes en cas de redÃ©ploiement
  # Note: Correspond au fichier pgschema.sql du projet
  init-db.sql: |
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -- SchÃ©ma de base de donnÃ©es pour RHDemo
    -- DDL (Data Definition Language) - DÃ©finition des structures
    -- ExÃ©cutÃ© automatiquement au premier dÃ©marrage de PostgreSQL
    -- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    -- VÃ©rifier si la table existe dÃ©jÃ 
    DO $$
    BEGIN
      IF NOT EXISTS (
        SELECT FROM pg_tables
        WHERE schemaname = 'public' AND tablename = 'employes'
      ) THEN
        \echo 'ğŸ“‹ CrÃ©ation du schÃ©ma de la base de donnÃ©es RHDemo...'

        -- CrÃ©er la table employes
        CREATE TABLE employes (
          id BIGSERIAL PRIMARY KEY,
          prenom VARCHAR(250) NOT NULL,
          nom VARCHAR(250) NOT NULL,
          mail VARCHAR(250) NOT NULL,
          adresse VARCHAR(500)
        );

        -- CrÃ©ation des index pour optimiser les performances
        -- Index sur le mail pour les recherches rapides et l'unicitÃ©
        CREATE UNIQUE INDEX idx_employes_mail ON employes(mail);

        -- Index sur le nom pour les recherches alphabÃ©tiques
        CREATE INDEX idx_employes_nom ON employes(nom);

        -- Index sur le prÃ©nom pour les recherches par prÃ©nom
        CREATE INDEX idx_employes_prenom ON employes(prenom);

        -- Index composite sur nom + prÃ©nom pour les recherches combinÃ©es
        CREATE INDEX idx_employes_nom_prenom ON employes(nom, prenom);

        -- Index partiel sur l'adresse (seulement pour les adresses non-nulles)
        -- Utile si beaucoup de recherches par ville/localisation
        CREATE INDEX idx_employes_adresse ON employes(adresse) WHERE adresse IS NOT NULL;

        \echo 'âœ… SchÃ©ma de base de donnÃ©es RHDemo initialisÃ© (table + index crÃ©Ã©s)'
      ELSE
        \echo 'â„¹ï¸  Table employes existe dÃ©jÃ  - schÃ©ma non modifiÃ© (donnÃ©es prÃ©servÃ©es)'
      END IF;
    END
    $$;
{{- end }}
