# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Docker Compose Override pour OWASP ZAP (CI/CD - Environnement Jenkins)
#
# Ce fichier ajoute OWASP ZAP comme proxy de sÃ©curitÃ© entre
# les tests Selenium (exÃ©cutÃ©s dans Jenkins) et l'application RHDemo
# pour dÃ©tecter automatiquement les vulnÃ©rabilitÃ©s (XSS, CSRF, SQLi, etc.)
#
# Usage dans Jenkins:
#   cd infra/jenkins-docker
#   docker compose -f docker-compose.yml \
#                  -f docker-compose.zap.yml \
#                  up -d owasp-zap
#
# Architecture de test:
#   Jenkins et ZAP : Connexion dynamique multi-rÃ©seau
#
#   Jenkins :
#     - rhdemo-jenkins-network (permanent)
#     - rhdemo-staging-network (temporaire - connectÃ©/dÃ©connectÃ© par Jenkinsfile)
#
#   ZAP :
#     - rhdemo-jenkins-network (permanent - dÃ©fini dans ce fichier)
#     - rhdemo-staging-network (temporaire - connectÃ©/dÃ©connectÃ© par Jenkinsfile)
#
#   Jenkinsfile gÃ¨re le cycle de vie rÃ©seau :
#     1. Stage "ğŸ“¦ DÃ©ploiement" : Jenkins se connecte Ã  rhdemo-staging-network
#     2. Stage "ğŸ”’ DÃ©marrage OWASP ZAP" : ZAP se connecte Ã  rhdemo-staging-network
#     3. Stage "ğŸŒ Tests Selenium" : Tests avec accÃ¨s aux alias DNS staging
#     4. Post Selenium (always) : ZAP et Jenkins se dÃ©connectent de rhdemo-staging-network
#
#   Flux de donnÃ©es durant les tests :
#   Selenium (dans Jenkins) â†’ ZAP Proxy (8090) â†’
#                             Nginx (rhdemo.staging.local via alias DNS) â†’ RHDemo App
#                                        â†“
#                                Analyse passive
#                                + Spider
#                                + Active Scan
#                                        â†“
#                                Rapport HTML/JSON
#
# Variables attendues:
#   ZAP_API_KEY=your-secure-api-key (gÃ©nÃ©rÃ© automatiquement si absent)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

services:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # OWASP ZAP - Proxy de sÃ©curitÃ© pour analyse automatique
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  owasp-zap:
    image: ghcr.io/zaproxy/zaproxy:stable
    container_name: rhdemo-jenkins-zap
    restart: "no"  # Service temporaire pour CI/CD uniquement

    # DÃ©marrage en mode daemon avec API activÃ©e
    # Note: Le port principal (-port) est utilisÃ© pour le PROXY et l'API web
    # Il n'y a pas de sÃ©paration API/Proxy dans ZAP - un seul port pour les deux
    command: >
      zap.sh -daemon
      -host 0.0.0.0
      -port 8090
      -config api.addrs.addr.name=.*
      -config api.addrs.addr.regex=true
      -config api.key=${ZAP_API_KEY:-changeme}
      -config api.disablekey=false
      -config spider.maxDepth=5
      -config spider.maxChildren=10
      -config ajaxSpider.browserId=firefox

    environment:
      # Logging ZAP
      - ZAP_LOG_LEVEL=INFO

      # Configuration proxy
      - ZAP_PROXY_PORT=8090

      # Timeout scans
      - ZAP_TIMEOUT=60

    ports:
      # Port unique ZAP (API + Proxy sur le mÃªme port)
      # Port 8090 pour Ã©viter conflit avec Jenkins (8080)
      - "8090:8090"

    volumes:
      # Persistence des sessions ZAP (dans le mÃªme volume que Jenkins)
      - zap-sessions:/zap/session

      # Rapports gÃ©nÃ©rÃ©s (accessible depuis Jenkins pour archivage)
      - zap-reports:/zap/reports

      # Scripts personnalisÃ©s (optionnel)
      # - ./zap-scripts:/zap/scripts:ro

    networks:
      # RÃ©seau Jenkins (permanent)
      # Note: ZAP sera connectÃ© dynamiquement Ã  rhdemo-staging-network par le Jenkinsfile
      # lors du stage de dÃ©marrage ZAP, puis dÃ©connectÃ© aprÃ¨s les tests Selenium
      jenkins-network:
        aliases:
          - owasp-zap
          - zap-proxy

    # Healthcheck : vÃ©rifier que l'API ZAP rÃ©pond
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8090/JSON/core/view/version/?apikey=${ZAP_API_KEY:-changeme} || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

    # Limites ressources (Ã©viter surcharge CI)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# VOLUMES PERSISTANTS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
volumes:
  # Sessions ZAP (pour rÃ©utilisation entre builds)
  zap-sessions:
    external: true
    name: rhdemo-jenkins-zap-sessions

  # Rapports ZAP (montÃ©s dans Jenkins pour archivage)
  zap-reports:
    external: true
    name: rhdemo-jenkins-zap-reports

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RÃ‰SEAUX
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
networks:
  # RÃ©seau Jenkins (dÃ©jÃ  dÃ©fini dans docker-compose.yml principal)
  # ZAP dÃ©marre sur ce rÃ©seau uniquement
  #
  # Connexion dynamique Ã  rhdemo-staging-network gÃ©rÃ©e par Jenkinsfile :
  #   - Connexion : Stage "ğŸ”’ DÃ©marrage OWASP ZAP" (aprÃ¨s healthcheck)
  #   - DÃ©connexion : Post "ğŸŒ Tests Selenium IHM" (always block)
  jenkins-network:
    external: true
    name: rhdemo-jenkins-network
