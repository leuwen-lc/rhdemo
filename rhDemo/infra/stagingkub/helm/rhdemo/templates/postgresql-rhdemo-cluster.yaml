{{- if (index .Values "postgresql-rhdemo").cloudnativepg.enabled }}
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: postgresql-rhdemo
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "postgresql-rhdemo.labels" . | nindent 4 }}
    app: postgresql-rhdemo
spec:
  # ⭐ Mode Single Instance (recommandé pour staging)
  # Augmenter à 3 pour activer la haute disponibilité
  instances: {{ (index .Values "postgresql-rhdemo").cloudnativepg.instances }}

  # Image PostgreSQL 16 (CloudNativePG)
  imageName: {{ (index .Values "postgresql-rhdemo").cloudnativepg.imageName }}

  # Configuration du stockage
  storage:
    size: {{ (index .Values "postgresql-rhdemo").cloudnativepg.storage.size }}
    {{- if (index .Values "postgresql-rhdemo").cloudnativepg.storage.class }}
    storageClass: {{ (index .Values "postgresql-rhdemo").cloudnativepg.storage.class }}
    {{- end }}

  # Bootstrap: Initialisation de la base de données
  bootstrap:
    initdb:
      database: {{ (index .Values "postgresql-rhdemo").database.name }}
      owner: {{ (index .Values "postgresql-rhdemo").database.user }}
      secret:
        name: {{ (index .Values "postgresql-rhdemo").database.passwordSecret.name }}

      # ⭐ Initialisation du schéma via ConfigMap existant
      # CloudNativePG exécute ce SQL après création de la base
      {{- if (index .Values "postgresql-rhdemo").cloudnativepg.initdb.useConfigMap }}
      postInitApplicationSQL:
        - |
          -- ═══════════════════════════════════════════════════════════════
          -- Schéma de base de données pour RHDemo
          -- DDL (Data Definition Language) - Définition des structures
          -- Exécuté automatiquement au premier démarrage de PostgreSQL
          -- ═══════════════════════════════════════════════════════════════

          -- Créer la table employes (IF NOT EXISTS = idempotent)
          CREATE TABLE IF NOT EXISTS employes (
            id BIGSERIAL PRIMARY KEY,
            prenom VARCHAR(250) NOT NULL,
            nom VARCHAR(250) NOT NULL,
            mail VARCHAR(250) NOT NULL,
            adresse VARCHAR(500)
          );

          -- Création des index pour optimiser les performances
          -- Index sur le mail pour les recherches rapides et l'unicité
          CREATE UNIQUE INDEX IF NOT EXISTS idx_employes_mail ON employes(mail);

          -- Index sur le nom pour les recherches alphabétiques
          CREATE INDEX IF NOT EXISTS idx_employes_nom ON employes(nom);

          -- Index sur le prénom pour les recherches par prénom
          CREATE INDEX IF NOT EXISTS idx_employes_prenom ON employes(prenom);

          -- Index composite sur nom + prénom pour les recherches combinées
          CREATE INDEX IF NOT EXISTS idx_employes_nom_prenom ON employes(nom, prenom);

          -- Index partiel sur l'adresse (seulement pour les adresses non-nulles)
          CREATE INDEX IF NOT EXISTS idx_employes_adresse ON employes(adresse) WHERE adresse IS NOT NULL;

          -- Insérer des données de test (seulement si la table est vide)
          INSERT INTO employes (prenom, nom, mail, adresse)
          SELECT 'Jean', 'Dupont', 'jean.dupont@rhdemo.local', '1 Rue de Paris, 75001 Paris'
          WHERE NOT EXISTS (SELECT 1 FROM employes LIMIT 1);

          INSERT INTO employes (prenom, nom, mail, adresse)
          SELECT 'Marie', 'Martin', 'marie.martin@rhdemo.local', '2 Avenue des Champs, 75008 Paris'
          WHERE NOT EXISTS (SELECT 1 FROM employes WHERE mail = 'marie.martin@rhdemo.local');

          INSERT INTO employes (prenom, nom, mail, adresse)
          SELECT 'Pierre', 'Bernard', 'pierre.bernard@rhdemo.local', '3 Boulevard Saint-Germain, 75005 Paris'
          WHERE NOT EXISTS (SELECT 1 FROM employes WHERE mail = 'pierre.bernard@rhdemo.local');
      {{- end }}

  # Monitoring Prometheus (expose métriques sur port 9187)
  monitoring:
    enablePodMonitor: {{ (index .Values "postgresql-rhdemo").cloudnativepg.monitoring.enabled }}
    {{- if (index .Values "postgresql-rhdemo").cloudnativepg.monitoring.podMonitorLabels }}
    podMonitorMetricRelabelings:
      {{- toYaml (index .Values "postgresql-rhdemo").cloudnativepg.monitoring.podMonitorLabels | nindent 6 }}
    {{- end }}

  # Configuration des backups
  {{- if (index .Values "postgresql-rhdemo").cloudnativepg.backup.enabled }}
  backup:
    # Backup sur PVC local
    volumeSnapshot:
      className: {{ (index .Values "postgresql-rhdemo").cloudnativepg.backup.volumeSnapshotClassName | default "csi-hostpath-snapclass" }}

    # Rétention des backups
    retentionPolicy: {{ (index .Values "postgresql-rhdemo").cloudnativepg.backup.retentionPolicy | default "7d" }}

    # Configuration Barman (backup object store)
    {{- if (index .Values "postgresql-rhdemo").cloudnativepg.backup.barmanObjectStore }}
    barmanObjectStore:
      destinationPath: {{ (index .Values "postgresql-rhdemo").cloudnativepg.backup.barmanObjectStore.destinationPath }}
      {{- if (index .Values "postgresql-rhdemo").cloudnativepg.backup.barmanObjectStore.s3Credentials }}
      s3Credentials:
        {{- toYaml (index .Values "postgresql-rhdemo").cloudnativepg.backup.barmanObjectStore.s3Credentials | nindent 8 }}
      {{- end }}
      wal:
        compression: {{ (index .Values "postgresql-rhdemo").cloudnativepg.backup.barmanObjectStore.walCompression | default "gzip" }}
        maxParallel: {{ (index .Values "postgresql-rhdemo").cloudnativepg.backup.barmanObjectStore.walMaxParallel | default 2 }}
    {{- end }}
  {{- end }}

  # Ressources CPU/Memory
  {{- if (index .Values "postgresql-rhdemo").cloudnativepg.resources }}
  resources:
    {{- toYaml (index .Values "postgresql-rhdemo").cloudnativepg.resources | nindent 4 }}
  {{- end }}

  # Configuration PostgreSQL
  postgresql:
    parameters:
      # Performance tuning pour environnement staging
      max_connections: {{ (index .Values "postgresql-rhdemo").cloudnativepg.postgresql.maxConnections | default "100" | quote }}
      shared_buffers: {{ (index .Values "postgresql-rhdemo").cloudnativepg.postgresql.sharedBuffers | default "128MB" | quote }}
      effective_cache_size: {{ (index .Values "postgresql-rhdemo").cloudnativepg.postgresql.effectiveCacheSize | default "256MB" | quote }}
      maintenance_work_mem: {{ (index .Values "postgresql-rhdemo").cloudnativepg.postgresql.maintenanceWorkMem | default "64MB" | quote }}
      work_mem: {{ (index .Values "postgresql-rhdemo").cloudnativepg.postgresql.workMem | default "4MB" | quote }}

      # WAL configuration
      wal_level: {{ (index .Values "postgresql-rhdemo").cloudnativepg.postgresql.walLevel | default "replica" | quote }}
      max_wal_size: {{ (index .Values "postgresql-rhdemo").cloudnativepg.postgresql.maxWalSize | default "1GB" | quote }}
      min_wal_size: {{ (index .Values "postgresql-rhdemo").cloudnativepg.postgresql.minWalSize | default "80MB" | quote }}

      # Logging
      log_destination: {{ (index .Values "postgresql-rhdemo").cloudnativepg.postgresql.logDestination | default "stderr" | quote }}
      logging_collector: {{ (index .Values "postgresql-rhdemo").cloudnativepg.postgresql.loggingCollector | default "off" | quote }}
      log_statement: {{ (index .Values "postgresql-rhdemo").cloudnativepg.postgresql.logStatement | default "none" | quote }}

  # Affinity (optionnel, pour répartition des pods en mode HA)
  {{- if (index .Values "postgresql-rhdemo").cloudnativepg.affinity }}
  affinity:
    {{- toYaml (index .Values "postgresql-rhdemo").cloudnativepg.affinity | nindent 4 }}
  {{- end }}

  # NodeSelector (optionnel)
  {{- if (index .Values "postgresql-rhdemo").cloudnativepg.nodeSelector }}
  nodeSelector:
    {{- toYaml (index .Values "postgresql-rhdemo").cloudnativepg.nodeSelector | nindent 4 }}
  {{- end }}

  # Tolerations (optionnel)
  {{- if (index .Values "postgresql-rhdemo").cloudnativepg.tolerations }}
  tolerations:
    {{- toYaml (index .Values "postgresql-rhdemo").cloudnativepg.tolerations | nindent 4 }}
  {{- end }}
{{- end }}
