services:
  # ═══════════════════════════════════════════════════════════════
  # Base de données PostgreSQL pour l'application RHDemo (dev local)
  # ═══════════════════════════════════════════════════════════════
  rhdemo-db-dev:
    image: postgres:18.2-alpine3.22@sha256:198c924aa928fecac4bddada3bf4634430aa137a5b1fb577c0d4b6d89a2b1599
    container_name: rhdemo-dev-db
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: dbrhdemo
      POSTGRES_USER: dbrhdemo
      POSTGRES_PASSWORD: ${RHDEMO_DB_PASSWORD:-changeme}
    volumes:
      # PostgreSQL 18+ : monter sur /var/lib/postgresql (et non /data)
      # PG 18 gère ses propres sous-répertoires versionnés (18/docker/)
      - rhdemo-dev-db-data:/var/lib/postgresql
      # Scripts d'initialisation (exécutés uniquement sur volume vierge)
      # Ordre alphabétique : 1-schema puis 2-data
      - ../../pgschema.sql:/docker-entrypoint-initdb.d/01-schema.sql:ro
      - ../../pgdata.sql:/docker-entrypoint-initdb.d/02-data.sql:ro
    networks:
      - rhdemo-dev
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U dbrhdemo"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ═══════════════════════════════════════════════════════════════
  # Keycloak - Serveur d'authentification (dev local avec H2)
  # ═══════════════════════════════════════════════════════════════
  keycloak-dev:
    image: quay.io/keycloak/keycloak:26.5.0@sha256:24896bcb632fa37445c8ca979886f5b2370651335b92ed72724369f8e5f56b4f
    container_name: keycloak-dev
    restart: unless-stopped
    ports:
      - "6090:8080"
    command:
      - start-dev
      - --http-enabled=true
      - --health-enabled=true
      - --metrics-enabled=true
    environment:
      # Admin Keycloak
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN_USER:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}

      # Hostname configuration
      KC_HOSTNAME_URL: http://localhost:6090
      KC_HOSTNAME_ADMIN_URL: http://localhost:6090

      # Logging
      KC_LOG_LEVEL: info

      # H2 database (par défaut en mode dev)
      # Pas besoin de configuration explicite, H2 est utilisé automatiquement en mode start-dev
    networks:
      rhdemo-dev:
        aliases:
          - keycloak-dev
          - keycloak.dev.local
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/localhost/8080 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 60s

networks:
  rhdemo-dev:
    name: rhdemo-dev-network
    driver: bridge

volumes:
  rhdemo-dev-db-data:
    name: rhdemo-dev-db-data
