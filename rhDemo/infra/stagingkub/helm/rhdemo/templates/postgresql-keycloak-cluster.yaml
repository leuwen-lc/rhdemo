{{- if .Values.keycloak.cloudnativepg.enabled }}
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: postgresql-keycloak
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "postgresql-keycloak.labels" . | nindent 4 }}
    app: postgresql-keycloak
spec:
  # ⭐ Mode Single Instance (recommandé pour staging)
  # Augmenter à 3 pour activer la haute disponibilité
  instances: {{ .Values.keycloak.cloudnativepg.instances }}

  # Image PostgreSQL 16 (CloudNativePG)
  imageName: {{ .Values.keycloak.cloudnativepg.imageName }}

  # Configuration du stockage
  storage:
    size: {{ .Values.keycloak.cloudnativepg.storage.size }}
    {{- if .Values.keycloak.cloudnativepg.storage.class }}
    storageClass: {{ .Values.keycloak.cloudnativepg.storage.class }}
    {{- end }}

  # Bootstrap: Initialisation de la base de données
  bootstrap:
    initdb:
      database: {{ .Values.keycloak.database.name }}
      owner: {{ .Values.keycloak.database.user }}
      secret:
        name: {{ .Values.keycloak.database.passwordSecret.name }}

      # Keycloak crée automatiquement son schéma
      # Pas besoin de postInitSQL ou postInitApplicationSQL

  # Monitoring Prometheus (expose métriques sur port 9187)
  monitoring:
    enablePodMonitor: {{ .Values.keycloak.cloudnativepg.monitoring.enabled }}
    {{- if .Values.keycloak.cloudnativepg.monitoring.podMonitorLabels }}
    podMonitorMetricRelabelings:
      {{- toYaml .Values.keycloak.cloudnativepg.monitoring.podMonitorLabels | nindent 6 }}
    {{- end }}

  # Configuration des backups
  {{- if .Values.keycloak.cloudnativepg.backup.enabled }}
  backup:
    # Backup sur PVC local
    volumeSnapshot:
      className: {{ .Values.keycloak.cloudnativepg.backup.volumeSnapshotClassName | default "csi-hostpath-snapclass" }}

    # Rétention des backups
    retentionPolicy: {{ .Values.keycloak.cloudnativepg.backup.retentionPolicy | default "7d" }}

    # Configuration Barman (backup object store)
    {{- if .Values.keycloak.cloudnativepg.backup.barmanObjectStore }}
    barmanObjectStore:
      destinationPath: {{ .Values.keycloak.cloudnativepg.backup.barmanObjectStore.destinationPath }}
      {{- if .Values.keycloak.cloudnativepg.backup.barmanObjectStore.s3Credentials }}
      s3Credentials:
        {{- toYaml .Values.keycloak.cloudnativepg.backup.barmanObjectStore.s3Credentials | nindent 8 }}
      {{- end }}
      wal:
        compression: {{ .Values.keycloak.cloudnativepg.backup.barmanObjectStore.walCompression | default "gzip" }}
        maxParallel: {{ .Values.keycloak.cloudnativepg.backup.barmanObjectStore.walMaxParallel | default 2 }}
    {{- end }}
  {{- end }}

  # Ressources CPU/Memory
  {{- if .Values.keycloak.cloudnativepg.resources }}
  resources:
    {{- toYaml .Values.keycloak.cloudnativepg.resources | nindent 4 }}
  {{- end }}

  # Configuration PostgreSQL
  postgresql:
    parameters:
      # Performance tuning pour environnement staging
      max_connections: {{ .Values.keycloak.cloudnativepg.postgresql.maxConnections | default "100" | quote }}
      shared_buffers: {{ .Values.keycloak.cloudnativepg.postgresql.sharedBuffers | default "128MB" | quote }}
      effective_cache_size: {{ .Values.keycloak.cloudnativepg.postgresql.effectiveCacheSize | default "256MB" | quote }}
      maintenance_work_mem: {{ .Values.keycloak.cloudnativepg.postgresql.maintenanceWorkMem | default "64MB" | quote }}
      work_mem: {{ .Values.keycloak.cloudnativepg.postgresql.workMem | default "4MB" | quote }}

      # WAL configuration
      wal_level: {{ .Values.keycloak.cloudnativepg.postgresql.walLevel | default "replica" | quote }}
      max_wal_size: {{ .Values.keycloak.cloudnativepg.postgresql.maxWalSize | default "1GB" | quote }}
      min_wal_size: {{ .Values.keycloak.cloudnativepg.postgresql.minWalSize | default "80MB" | quote }}

      # Logging
      log_destination: {{ .Values.keycloak.cloudnativepg.postgresql.logDestination | default "stderr" | quote }}
      logging_collector: {{ .Values.keycloak.cloudnativepg.postgresql.loggingCollector | default "off" | quote }}
      log_statement: {{ .Values.keycloak.cloudnativepg.postgresql.logStatement | default "none" | quote }}

  # Affinity (optionnel, pour répartition des pods en mode HA)
  {{- if .Values.keycloak.cloudnativepg.affinity }}
  affinity:
    {{- toYaml .Values.keycloak.cloudnativepg.affinity | nindent 4 }}
  {{- end }}

  # NodeSelector (optionnel)
  {{- if .Values.keycloak.cloudnativepg.nodeSelector }}
  nodeSelector:
    {{- toYaml .Values.keycloak.cloudnativepg.nodeSelector | nindent 4 }}
  {{- end }}

  # Tolerations (optionnel)
  {{- if .Values.keycloak.cloudnativepg.tolerations }}
  tolerations:
    {{- toYaml .Values.keycloak.cloudnativepg.tolerations | nindent 4 }}
  {{- end }}
{{- end }}
