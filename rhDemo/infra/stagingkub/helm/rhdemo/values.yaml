# ═══════════════════════════════════════════════════════════════
# Configuration globale
# ═══════════════════════════════════════════════════════════════
global:
  namespace: rhdemo-stagingkub
  environment: stagingkub
  domain: stagingkub.intra.leuwen-lc.fr

# ═══════════════════════════════════════════════════════════════
# Backups PostgreSQL (CronJobs)
# ═══════════════════════════════════════════════════════════════
postgresqlBackup:
  enabled: true
  retentionDays: 7  # Garder les backups pendant 7 jours

  rhdemo:
    schedule: "0 2 * * *"  # 2h du matin tous les jours

  keycloak:
    schedule: "0 3 * * *"  # 3h du matin tous les jours

# ═══════════════════════════════════════════════════════════════
# PostgreSQL pour RHDemo
# ═══════════════════════════════════════════════════════════════
postgresql-rhdemo:
  enabled: true
  image:
    repository: postgres
    tag: "16-alpine"
    pullPolicy: IfNotPresent

  database:
    name: rhdemo
    user: rhdemo
    # Le mot de passe sera fourni via secret externe ou --set
    password: ""  # À fournir via --set ou secret
    passwordSecret:
      name: rhdemo-db-secret
      key: password

  persistence:
    enabled: true
    storageClass: ""  # Utilise le default storage class
    size: 2Gi
    accessMode: ReadWriteOnce

  resources:
    requests:
      memory: "256Mi"
      cpu: "250m"
    limits:
      memory: "512Mi"
      cpu: "500m"

  service:
    name: postgresql-rhdemo
    type: ClusterIP
    port: 5432

  # Configuration des métriques PostgreSQL via postgres_exporter
  # Expose les métriques pg_stat_statements pour identifier les requêtes lentes
  metrics:
    enabled: true
    exporter:
      image:
        repository: quay.io/prometheuscommunity/postgres-exporter
        tag: "v0.15.0"
        pullPolicy: IfNotPresent
    serviceMonitor:
      enabled: true
      namespace: monitoring
      interval: 30s
      scrapeTimeout: 10s

# ═══════════════════════════════════════════════════════════════
# PostgreSQL pour Keycloak
# ═══════════════════════════════════════════════════════════════
postgresql-keycloak:
  enabled: true
  image:
    repository: postgres
    tag: "16-alpine"
    pullPolicy: IfNotPresent

  database:
    name: keycloak
    user: keycloak
    password: ""  # À fournir via --set ou secret
    passwordSecret:
      name: keycloak-db-secret
      key: password

  persistence:
    enabled: true
    storageClass: ""
    size: 2Gi
    accessMode: ReadWriteOnce

  resources:
    requests:
      memory: "256Mi"
      cpu: "250m"
    limits:
      memory: "512Mi"
      cpu: "500m"

  service:
    name: postgresql-keycloak
    type: ClusterIP
    port: 5432

# ═══════════════════════════════════════════════════════════════
# Keycloak - Serveur d'authentification
# ═══════════════════════════════════════════════════════════════
keycloak:
  enabled: true
  image:
    repository: quay.io/keycloak/keycloak
    tag: "26.4.2"
    pullPolicy: IfNotPresent

  replicaCount: 1

  admin:
    user: admin
    # Le mot de passe sera fourni via secret
    passwordSecret:
      name: keycloak-admin-secret
      key: password

  database:
    host: postgresql-keycloak
    port: 5432
    name: keycloak
    user: keycloak
    passwordSecret:
      name: keycloak-db-secret
      key: password

  # Configuration hostname v2 (KC_HOSTNAME au lieu de KC_HOSTNAME_URL/KC_HOSTNAME_ADMIN_URL)
  hostname: keycloak-stagingkub.intra.leuwen-lc.fr

  proxyHeaders: xforwarded
  httpEnabled: true
  healthEnabled: true
  metricsEnabled: true

  logLevel: info

  resources:
    requests:
      memory: "512Mi"
      cpu: "500m"
    limits:
      memory: "1Gi"
      cpu: "1000m"

  service:
    type: ClusterIP
    port: 8080

  livenessProbe:
    initialDelaySeconds: 60
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 15

  readinessProbe:
    initialDelaySeconds: 60
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 15

# ═══════════════════════════════════════════════════════════════
# Application RHDemo
# ═══════════════════════════════════════════════════════════════
rhdemo:
  enabled: true
  image:
    repository: rhdemo-api
    tag: "1.1.0-SNAPSHOT"
    pullPolicy: IfNotPresent

  replicaCount: 1

  springProfile: stagingkub
  serverPort: 9000

  database:
    host: postgresql-rhdemo
    port: 5432
    name: rhdemo
    user: rhdemo
    passwordSecret:
      name: rhdemo-db-secret
      key: password

  keycloak:
    # La configuration Keycloak (issuer-uri, client-secret, etc.)
    # sera injectée via le secret secrets-rhdemo
    secretsFile:
      secretName: rhdemo-app-secrets
      mountPath: /workspace/secrets
      fileName: secrets-rhdemo.yml

  actuator:
    endpoints:
      include: "health,info,metrics,prometheus"
    health:
      showDetails: when_authorized

  # Configuration des métriques Prometheus
  metrics:
    serviceMonitor:
      enabled: true
      namespace: monitoring  # Namespace où Prometheus Operator est installé
      interval: 30s
      scrapeTimeout: 10s

  # Configuration des niveaux de logs
  logging:
    level:
      root: INFO
      org_springframework_web: INFO
      org_springframework_security: INFO
      org_springframework_security_oauth2: INFO
      org_springframework_web_client: INFO

  jvm:
    threadCount: 50
    maxRamPercentage: 75.0
    gcType: G1GC

  resources:
    requests:
      memory: "512Mi"
      cpu: "500m"
    limits:
      memory: "1Gi"
      cpu: "1000m"

  service:
    type: ClusterIP
    port: 9000

  livenessProbe:
    initialDelaySeconds: 60
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 3

  readinessProbe:
    initialDelaySeconds: 60
    periodSeconds: 30
    timeoutSeconds: 10
    failureThreshold: 3

# ═══════════════════════════════════════════════════════════════
# Gateway API - Exposition HTTPS (NGINX Gateway Fabric 2.3.0)
# ═══════════════════════════════════════════════════════════════
# Remplace l'ancien Ingress NGINX par Gateway API standard.
# Les headers X-Forwarded-* sont configurés automatiquement par NGF.
#
# Documentation: https://docs.nginx.com/nginx-gateway-fabric/
# ═══════════════════════════════════════════════════════════════
gateway:
  enabled: true

  # ═══════════════════════════════════════════════════════════════
  # Option 1: Utiliser le Gateway partagé (RECOMMANDÉ)
  # ═══════════════════════════════════════════════════════════════
  # Le shared-gateway est créé par init-stagingkub.sh dans nginx-gateway.
  # Il gère le certificat TLS et le NodePort automatiquement.
  # Les HTTPRoutes de ce namespace s'attachent au Gateway partagé.
  useSharedGateway: true
  sharedGateway:
    name: shared-gateway
    namespace: nginx-gateway
    sectionName: https  # Nom du listener dans shared-gateway.yaml

  # ═══════════════════════════════════════════════════════════════
  # Option 2: Créer un Gateway dédié (déconseillé)
  # ═══════════════════════════════════════════════════════════════
  # Mettre useSharedGateway: false pour créer un Gateway dans ce namespace.
  # Nécessite de configurer le certificat TLS et le NodePort manuellement.
  dedicatedGateway:
    name: rhdemo-gateway
    className: nginx
    listeners:
      - name: https-rhdemo
        hostname: rhdemo-stagingkub.intra.leuwen-lc.fr
        port: 443
        protocol: HTTPS
        tls:
          mode: Terminate
          # Certificat auto-signé (init-stagingkub.sh) ou Let's Encrypt (cert-manager)
          # Let's Encrypt: intra-wildcard-tls
          secretName: rhdemo-tls-cert
      - name: https-keycloak
        hostname: keycloak-stagingkub.intra.leuwen-lc.fr
        port: 443
        protocol: HTTPS
        tls:
          mode: Terminate
          # Let's Encrypt: intra-wildcard-tls
          secretName: rhdemo-tls-cert

  # Routes HTTP vers les services backend
  routes:
    - name: rhdemo-route
      listenerName: https-rhdemo
      hostname: rhdemo-stagingkub.intra.leuwen-lc.fr
      rules:
        - path: /
          pathType: PathPrefix
          serviceName: rhdemo-app
          servicePort: 9000

    - name: keycloak-route
      listenerName: https-keycloak
      hostname: keycloak-stagingkub.intra.leuwen-lc.fr
      rules:
        - path: /
          pathType: PathPrefix
          serviceName: keycloak
          servicePort: 8080

  # ClientSettingsPolicy : taille max du body (remplace proxy-body-size)
  clientSettings:
    enabled: true
    maxBodySize: 10m

  # SnippetsFilter : buffers proxy pour Keycloak
  # CRITIQUE: Les gros cookies OAuth2 nécessitent des buffers plus grands
  # PRÉREQUIS: nginxGateway.snippetsFilters.enable=true lors de l'install Helm
  snippetsFilter:
    enabled: true
    proxyBufferSize: "128k"
    proxyBuffersNumber: "4"
    proxyBusyBuffersSize: "256k"

# ═══════════════════════════════════════════════════════════════
# NGINX Gateway Fabric 2.3.0 (remplace nginx-ingress)
# ═══════════════════════════════════════════════════════════════
# Installation via Helm OCI: oci://ghcr.io/nginx/charts/nginx-gateway-fabric
# Les CRDs Gateway API doivent être installés au préalable.
#
# Note: NGF est installé dans le namespace 'nginx-gateway' par init-stagingkub.sh
# Cette section est documentative, l'installation réelle est dans le script.
# ═══════════════════════════════════════════════════════════════
nginx-gateway-fabric:
  # NGF est installé par init-stagingkub.sh, pas par ce chart
  # Cette section documente la configuration utilisée
  enabled: false  # Installé séparément

  # Configuration de référence pour init-stagingkub.sh
  nginxGateway:
    snippetsFilters:
      enable: true  # CRITIQUE pour les proxy buffers Keycloak

  nginx:
    service:
      type: NodePort
      externalTrafficPolicy: Local  # Préserve l'IP client source

      # NodePorts mappés dans kind-config.yaml
      # Format NGF: port = NodePort exposé, listenerPort = port Gateway
      nodePorts:
        - port: 31792        # NodePort HTTP (non utilisé, redirige vers HTTPS)
          listenerPort: 80
        - port: 32616        # NodePort HTTPS
          listenerPort: 443

    container:
      resources:
        requests:
          memory: "128Mi"
          cpu: "100m"
        limits:
          memory: "256Mi"
          cpu: "200m"

# ═══════════════════════════════════════════════════════════════
# Network Policies - Sécurité réseau
# ═══════════════════════════════════════════════════════════════
# Active les NetworkPolicies pour isoler les pods et contrôler
# les flux réseau selon le principe du moindre privilège.
#
# Stratégie: Zero Trust / Default Deny
#   1. Tout trafic est bloqué par défaut (ingress + egress)
#   2. Chaque flux légitime est explicitement autorisé
#   3. L'accès Internet est bloqué (sauf DNS)
#
# Voir: docs/NETWORK_SECURITY_POLICY.md pour les détails des flux
# ═══════════════════════════════════════════════════════════════
networkPolicies:
  # Activer/désactiver toutes les NetworkPolicies
  # ATTENTION: Désactiver = pas d'isolation réseau
  enabled: true

  # Configuration spécifique Keycloak (accès externes optionnels)
  keycloak:
    # Autoriser l'envoi d'emails via SMTP
    # Nécessite de spécifier le CIDR du serveur SMTP
    allowSmtp: false
    smtpCidr: "0.0.0.0/32"  # À remplacer par l'IP du serveur SMTP

    # Autoriser la connexion LDAP/Active Directory
    # Nécessite de spécifier le CIDR du serveur LDAP
    allowLdap: false
    ldapCidr: "0.0.0.0/32"  # À remplacer par l'IP du serveur LDAP
