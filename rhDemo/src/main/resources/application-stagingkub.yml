spring:
  # Surcharge de la configuration HikariCP pour stagingkub (environnement proche prod)
  datasource:
    hikari:
      # Pool plus grand pour stagingkub (proche production)
      maximum-pool-size: 20
      minimum-idle: 5

  security:
    oauth2:
      client:
        registration:
          keycloak:
            client-id: ${RHDEMO_CLIENT_REGISTRATION_KEYCLOAK_CLIENT_ID:RHDemo}
            client-secret: ${rhdemo.client.registration.keycloak.client.secret}
            client-authentication-method: client_secret_post
            scope: openid
            authorization-grant-type: authorization_code
            redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
        provider:
          keycloak:
            # URL publique HTTPS pour le navigateur (redirection login)
            authorization-uri: https://keycloak.stagingkub.intra.leuwen-lc.fr/realms/RHDemo/protocol/openid-connect/auth

            # URLs internes HTTP pour les appels serveur Spring Boot → Keycloak
            # (échange code→token, récupération JWKS)
            # Utilise le service Kubernetes "keycloak" pour accès réseau interne
            token-uri: http://keycloak:8080/realms/RHDemo/protocol/openid-connect/token
            jwk-set-uri: http://keycloak:8080/realms/RHDemo/protocol/openid-connect/certs

            # issuer-uri n'est PAS configuré car :
            # - Avec certificat auto-signé : Spring ne peut pas télécharger /.well-known/openid-configuration
            # - Avec Let's Encrypt : fonctionne, mais on garde la config manuelle pour compatibilité
            # L'issuer sera validé automatiquement depuis le token JWT reçu

            user-name-attribute: preferred_username
      resourceserver:
        jwt:
          # JWKS en HTTP interne pour validation des signatures JWT
          jwk-set-uri: http://keycloak:8080/realms/RHDemo/protocol/openid-connect/certs

          # NE PAS configurer issuer-uri ici non plus
          # Spring utilisera l'issuer présent dans le token JWT pour validation

# Configuration serveur pour reverse proxy
server:
  # Utiliser les headers X-Forwarded-* de nginx pour construire les URLs correctes
  forward-headers-strategy: framework

  # Configuration des cookies de session pour environnement HTTPS
  servlet:
    session:
      cookie:
        secure: true  # Flag Secure pour JSESSIONID (protection Trivy/ZAP)
        http-only: true  # Empêche l'accès JavaScript au cookie de session
        same-site: lax  # Protection CSRF supplémentaire

# Désactivation de la documentation API SpringDoc en stagingkub
springdoc:
  swagger-ui:
    enabled: false
  api-docs:
    enabled: false

# Logging
# Les niveaux de logs sont configurés via les variables d'environnement injectées par Helm
# Voir: infra/stagingkub/helm/rhdemo/values.yaml (section rhdemo.logging)

# Endpoints Actuator disponibles
management:
  endpoints:
    web:
      exposure:
        include: '*'
  endpoint:
    env:
      show-values:  ALWAYS  # Options: NEVER, WHEN_AUTHORIZED, ALWAYS
