# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# JENKINS CONFIGURATION AS CODE (JCasC)
# Configuration automatique de Jenkins au dÃ©marrage
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

jenkins:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # CONFIGURATION SYSTÃˆME
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  systemMessage: |
    ğŸš€ Jenkins RHDemo - Serveur CI/CD (Controller)
    ConfigurÃ© automatiquement avec Jenkins Configuration as Code
    Le master ne fait que du pilotage. Les builds sont exÃ©cutÃ©s sur l'agent "builder".

  # Le master ne doit pas exÃ©cuter de builds (sÃ©curitÃ©)
  numExecutors: 0
  mode: EXCLUSIVE

  quietPeriod: 5
  scmCheckoutRetryCount: 3

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # AGENT DE BUILD
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  nodes:
    - permanent:
        name: "builder"
        labelString: "builder"
        numExecutors: 2
        mode: NORMAL
        remoteFS: "/home/jenkins/agent"
        retentionStrategy: "always"
        launcher:
          jnlp:
            webSocket: true
        nodeProperties:
          - envVars:
              env:
                - key: "JAVA_HOME"
                  value: "/opt/java/temurin-25"
                - key: "MAVEN_HOME"
                  value: "/opt/maven"
                - key: "PATH+EXTRA"
                  value: "/opt/java/temurin-25/bin:/opt/maven/bin"
  
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # SÃ‰CURITÃ‰
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  securityRealm:
    local:
      allowsSignup: false
      users:
        - id: "admin"
          password: "${JENKINS_ADMIN_PASSWORD:-admin123}"
          name: "Administrator"
          description: "Jenkins Administrator"
  
  authorizationStrategy:
    loggedInUsersCanDoAnything:
      allowAnonymousRead: false
  
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # VARIABLES GLOBALES (hÃ©ritÃ©es par tous les noeuds)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  globalNodeProperties:
    - envVars:
        env:
          - key: "NOTIFICATION_EMAIL"
            value: "${SMTP_USER}"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONFIGURATION DES OUTILS (JDK, Maven, etc.)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
tool:
  # JDK 25 (Eclipse Temurin, installÃ© dans l'image Docker)
  jdk:
    installations:
      - name: "JDK25"
        home: "/opt/java/temurin-25"
  
  # Maven (dÃ©jÃ  installÃ© dans l'image Docker)
  maven:
    installations:
      - name: "Maven3"
        home: "/opt/maven"
  
  # Git (dÃ©jÃ  installÃ© sur le systÃ¨me)
  git:
    installations:
      - name: "Default"
        home: "git"

  # OWASP Dependency-Check
  dependency-check:
    installations:
      - name: "dependency-check-9.2.0"
        properties:
          - installSource:
              installers:
                - dependencyCheckInstaller:
                    id: "9.2.0"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CREDENTIALS
# âš ï¸  Les credentials sont gÃ©rÃ©s manuellement dans Jenkins UI
#     pour permettre la persistance entre les redÃ©marrages
#
# Liste des credentials Ã  crÃ©er manuellement :
#
# 1. sops-age-key (Secret file)
#    - Type: Secret file
#    - ID: sops-age-key
#    - File: Votre fichier de clÃ© AGE privÃ©e (~/.config/sops/age/keys.txt)
#    - Description: SOPS AGE Private Key for decrypting secrets
#
# 2. jenkins-sonar-token (Secret text - optionnel)
#    - Type: Secret text
#    - ID: jenkins-sonar-token
#    - Secret: ${SONAR_TOKEN}
#    - Description: SonarQube Authentication Token
#
# 3. nvd-api-key (Secret text - recommandÃ© pour OWASP Dependency-Check)
#    - Type: Secret text
#    - ID: nvd-api-key
#    - Secret: ${NVD_API_KEY}
#    - Description: NVD API Key for OWASP Dependency-Check
#    - Obtenir une clÃ© sur: https://nvd.nist.gov/developers/request-an-api-key
#  
# 4. kubeconfig-stagingkub
#    - Type: Secret file
#    - ID: kubeconfig-stagingkub
#    - Contient le token de connexion Jenkins Ã  l'environnement stagingkub (controles RBAC)
#    - Pointer sur rhDemo/infra/stagingkub/jenkins-kubeconfig/kubeconfig-jenkins-rbac.yaml


# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONFIGURATION GLOBALE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
unclassified:
  # Configuration SonarQube
  sonarGlobalConfiguration:
    installations:
      - name: "SonarQube"
        serverUrl: "${SONAR_URL:-http://sonarqube:9000}"
        credentialsId: "jenkins-sonar-token"

  # Configuration Email
  mailer:
    smtpHost: "${SMTP_HOST:-smtp.gmail.com}"
    smtpPort: "${SMTP_PORT:-587}"
    charset: "UTF-8"

  # Configuration Location
  location:
    url: "http://localhost:8080/"
    adminAddress: "jenkins@example.com"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# JOBS - Pipelines RHDemo
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # PIPELINE CI - IntÃ©gration Continue
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - script: |
      pipelineJob('RHDemo-CI') {
        displayName('RHDemo - CI (Build & Tests)')
        description('''Pipeline d\'IntÃ©gration Continue pour RHDemo

        Phases :
        â€¢ Build Maven + Tests unitaires
        â€¢ Analyse OWASP Dependency-Check
        â€¢ Build Docker
        â€¢ Tests Selenium + OWASP ZAP (ephemere Docker Compose)
        â€¢ Publication de l\'image sur le registry

        ğŸ“– Documentation : docs/PIPELINES_CI_CD.md''')

        parameters {
          booleanParam {
            name('RUN_SELENIUM_TESTS')
            defaultValue(true)
            description('ExÃ©cuter les tests Selenium')
          }
          booleanParam {
            name('RUN_SONAR')
            defaultValue(true)
            description('ExÃ©cuter l\'analyse SonarQube')
          }
          booleanParam {
            name('PUBLISH_IMAGE')
            defaultValue(true)
            description('Publier l\'image sur le registry aprÃ¨s validation')
          }
          string {
            name('IMAGE_TAG_SUFFIX')
            defaultValue('')
            description('Suffixe optionnel pour le tag (ex: -rc1, -hotfix)')
            trim(true)
          }
        }

        definition {
          cpsScm {
            scm {
              git {
                remote {
                  url('https://github.com/leuwen-lc/rhdemo.git')
                  // Pas de credentials nÃ©cessaire pour un repository public
                }
                branches('*/master')
                extensions {
                  // Clone superficiel pour accÃ©lÃ©rer le checkout
                  cloneOptions {
                    shallow(false)
                    depth(0)
                    honorRefspec(true)
                  }
                }
              }
            }
            scriptPath('rhDemo/Jenkinsfile-CI')
            lightweight(true)
          }
        }

        properties {
          buildDiscarder {
            strategy {
              logRotator {
                numToKeepStr('30')
                daysToKeepStr('90')
                artifactNumToKeepStr('10')
                artifactDaysToKeepStr('30')
              }
            }
          }
          disableConcurrentBuilds()
        }

        triggers {
          pollSCM {
            scmpoll_spec('H/15 * * * *')
            ignorePostCommitHooks(false)
          }
        }
      }

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # PIPELINE CD - DÃ©ploiement Continu
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - script: |
      pipelineJob('RHDemo-CD') {
        displayName('RHDemo - CD (Deploy Kubernetes)')
        description('''Pipeline de DÃ©ploiement Continu sur Kubernetes stagingkub

        Phases :
        â€¢ VÃ©rification de l\'image dans le registry
        â€¢ Configuration accÃ¨s Kubernetes (KinD)
        â€¢ Mise Ã  jour des secrets Kubernetes
        â€¢ DÃ©ploiement Helm sur stagingkub
        â€¢ Health checks et validation

        PrÃ©-requis :
        â€¢ Image publiÃ©e par le pipeline CI
        â€¢ Cluster KinD initialisÃ© (init-stagingkub.sh)

        ğŸ“– Documentation : docs/PIPELINES_CI_CD.md''')

        parameters {
          string {
            name('IMAGE_TAG')
            defaultValue('')
            description('Tag de l\'image Ã  dÃ©ployer (ex: 1.1.0-SNAPSHOT). Si vide, utilise pom.xml')
            trim(true)
          }
          booleanParam {
            name('FORCE_RECREATE_PODS')
            defaultValue(false)
            description('Forcer la recrÃ©ation des pods (rollout restart)')
          }
          booleanParam {
            name('SKIP_HEALTH_CHECK')
            defaultValue(false)
            description('Ne pas attendre les health checks (dÃ©ploiement plus rapide)')
          }
        }

        definition {
          cpsScm {
            scm {
              git {
                remote {
                  url('https://github.com/leuwen-lc/rhdemo.git')
                  // Pas de credentials nÃ©cessaire pour un repository public
                }
                branches('*/master')
                extensions {
                  // Clone superficiel pour accÃ©lÃ©rer le checkout
                  cloneOptions {
                    shallow(false)
                    depth(0)
                    honorRefspec(true)
                  }
                }
              }
            }
            scriptPath('rhDemo/Jenkinsfile-CD')
            lightweight(true)
          }
        }

        properties {
          buildDiscarder {
            strategy {
              logRotator {
                numToKeepStr('50')
                daysToKeepStr('90')
                artifactNumToKeepStr('10')
                artifactDaysToKeepStr('30')
              }
            }
          }
          disableConcurrentBuilds()
        }
      }

