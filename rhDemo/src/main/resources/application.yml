spring:
  application:
    name: rhdemoAPI

  # Virtual Threads (Java 21+, Spring Boot 4)
  # Améliore significativement la scalabilité pour les opérations I/O-bound
  threads:
    virtual:
      enabled: true

  # Import des secrets depuis fichiers externes
  # En dev local: créer secrets/secrets-rhdemo.yml depuis secrets.yml.template
  # En ephemere Docker: fichier monté dans /workspace/secrets/secrets-rhdemo.yml
  config:
    import:
      - optional:file:./secrets/secrets-rhdemo.yml
      - optional:file:./rhDemo/secrets/secrets-rhdemo.yml
      - optional:file:/workspace/secrets/secrets-rhdemo.yml

  # PostgreSQL (prod)
  datasource:
    url: jdbc:postgresql://localhost:5432/dbrhdemo
    username: dbrhdemo
    password: ${rhdemo.datasource.password.pg}
    driver-class-name: org.postgresql.Driver

    # Configuration HikariCP pour éviter les warnings de connexion fermée
    hikari:
      # Temps max qu'une connexion peut rester dans le pool (30 min)
      # Doit être < au timeout de PostgreSQL (souvent 60 min par défaut)
      max-lifetime: 600000  # 30 minutes en millisecondes

      # Temps max qu'une connexion peut rester inactive avant d'être fermée (10 min)
      idle-timeout: 300000   # 10 minutes

      # Taille du pool
      maximum-pool-size: 10
      minimum-idle: 2

      # Test de connexion avant utilisation
      connection-test-query: SELECT 1

      # Validation timeout
      validation-timeout: 5000

      # Temps d'attente max pour obtenir une connexion du pool
      connection-timeout: 30000

      # Keepalive pour détecter les connexions mortes
      keepalive-time: 120000
  
  # Evite l'ecrasement du schema data.sql par JPA
  jpa:
    hibernate:
      ddl-auto: validate
    # Désactivation explicite de open-in-view pour éviter le warning
    # (et éviter les requêtes lazy lors du rendu des vues)
    open-in-view: false
  
  # OAuth2 / Keycloak
  # Configuration pour développement local
  # Pour ephemere, voir application-ephemere.yml
  # Pour production, surcharger via variables d'environnement
  security:
    oauth2:
      client:
        registration:
          keycloak:
            client-id: RHDemo
            client-secret: ${rhdemo.client.registration.keycloak.client.secret}
            client-authentication-method: client_secret_post
            scope: openid
            authorization-grant-type: authorization_code
            redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
        provider:
          keycloak:
            # Environnement local: Keycloak sur localhost:6090 (docker-compose local)
            # Endpoints publics pour redirections navigateur
            authorization-uri: http://localhost:6090/realms/RHDemo/protocol/openid-connect/auth
            # Endpoints backend pour communication serveur (même URL en local)
            token-uri: http://localhost:6090/realms/RHDemo/protocol/openid-connect/token
            jwk-set-uri: http://localhost:6090/realms/RHDemo/protocol/openid-connect/certs
            user-name-attribute: preferred_username
      resourceserver:
        jwt:
          # JWK pour validation des tokens JWT
          jwk-set-uri: http://localhost:6090/realms/RHDemo/protocol/openid-connect/certs

server:
  port: 9000
  # Support des headers X-Forwarded-* si derrière un reverse proxy
  # En local direct, cette option est ignorée
  forward-headers-strategy: framework

# Niveau de log
logging:
  level:
    root: INFO
    fr.leuwen: INFO
    org.springframework.boot.web.embedded.tomcat: INFO
    org.springframework.boot.actuate: INFO
    org.springframework.security: INFO
  
  # Pattern de log avec timestamp
  pattern:
    console: '%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} -- %msg%n'
    file: '%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} -- %msg%n'

# Endpoints Actuator disponibles
management:
  endpoints:
    web:
      exposure:
        include: '*'
  endpoint:
    env:
      show-values:  ALWAYS  # Options: NEVER, WHEN_AUTHORIZED, ALWAYS
  metrics:
    distribution:
      percentiles-histogram:
        http:
          server:
            requests: true
        
# SpringDoc / Swagger
springdoc:
  api-docs:
    path: /api-docs/docs
  swagger-ui:
    path: /api-docs/swagger-ui

# Propriétés custom
fr:
  leuwen:
    rhdemoAPI:
      messagelancement: Lancement de l'application RH Demo
