pipeline {
    agent any
    
    tools {
        jdk 'JDK21'  // Nom configurÃ© dans Jenkins Global Tool Configuration
        maven 'Maven3' // Nom configurÃ© dans Jenkins Global Tool Configuration
    }
    
    environment {
        // Configuration du pipeline
        APP_NAME = 'rhdemo-api'
        APP_VERSION = '0.0.1-SNAPSHOT'
        JAR_FILE = "rhDemo/target/rhdemoAPI-${APP_VERSION}.jar"
        
        // Configuration Docker
        DOCKER_IMAGE_NAME = "rhdemo-api"
        DOCKER_IMAGE_TAG = "${APP_VERSION}"
        DOCKER_REGISTRY = "" // Laisser vide pour Docker Hub ou spÃ©cifier registry privÃ©
        
        // Configuration des tests
        TEST_PORT = '9000'
        TEST_PROJECT_PATH = 'rhDemoAPITestIHM'
        
        // Fichiers de secrets SOPS
        SECRETS_FILE = 'rhDemo/secrets/secrets-staging.yml'
        SECRETS_DECRYPTED = 'rhDemo/secrets/secrets-decrypted.yml'
    }
    
    parameters {
        choice(name: 'DEPLOY_ENV', choices: ['none', 'staging', 'production'], description: 'Environnement de dÃ©ploiement')
        booleanParam(name: 'RUN_SELENIUM_TESTS', defaultValue: true, description: 'ExÃ©cuter les tests Selenium')
        booleanParam(name: 'RUN_SONAR', defaultValue: false, description: 'ExÃ©cuter l\'analyse SonarQube')
        booleanParam(name: 'SKIP_MANUAL_APPROVAL', defaultValue: false, description: 'Ignorer l\'approbation manuelle pour la production')
    }
    
    stages {
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PHASE 1 : PRÃ‰PARATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        stage('ğŸ› ï¸ Checkout') {
            steps {
                script {
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo '  PHASE 1 : PRÃ‰PARATION'
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                }
                checkout scm
                sh 'git log -1 --pretty=format:"%h - %an : %s"'
            }
        }
        
        stage('ï¿½ DÃ©chiffrement Secrets SOPS') {
            steps {
                script {
                    echo 'â–¶ VÃ©rification SOPS et YQ...'
                }
                sh '''
                    sops --version
                    yq --version
                '''
                
                script {
                    echo 'â–¶ DÃ©chiffrement du fichier de secrets...'
                }
                
                // Utiliser le credential sops-age-key de maniÃ¨re sÃ©curisÃ©e
                withCredentials([file(credentialsId: 'sops-age-key', variable: 'SOPS_AGE_KEY_FILE')]) {
                    sh '''
                        # CrÃ©er le rÃ©pertoire secrets s'il n'existe pas
                        mkdir -p rhDemo/secrets
                        
                        # DÃ©chiffrer le fichier de secrets
                        echo "DÃ©chiffrement de ${SECRETS_FILE}..."
                        sops -d ${SECRETS_FILE} > ${SECRETS_DECRYPTED}
                        
                        # VÃ©rifier que le fichier a Ã©tÃ© dÃ©chiffrÃ©
                        if [ ! -f ${SECRETS_DECRYPTED} ]; then
                            echo "âŒ Ã‰chec du dÃ©chiffrement"
                            exit 1
                        fi
                        
                        echo "âœ… Secrets dÃ©chiffrÃ©s avec succÃ¨s"
                        
                        # Extraire les valeurs pour les variables d'environnement
                        # Exporter les secrets comme variables d'environnement pour les stages suivants
                        echo "export RHDEMO_DATASOURCE_PASSWORD_PG=$(yq eval '.rhdemo.datasource.password.pg' ${SECRETS_DECRYPTED})" > rhDemo/secrets/env-vars.sh
                        echo "export RHDEMO_DATASOURCE_PASSWORD_H2=$(yq eval '.rhdemo.datasource.password.h2' ${SECRETS_DECRYPTED})" >> rhDemo/secrets/env-vars.sh
                        echo "export RHDEMO_CLIENT_REGISTRATION_KEYCLOAK_CLIENT_SECRET=$(yq eval '.rhdemo.client.registration.keycloak.client.secret' ${SECRETS_DECRYPTED})" >> rhDemo/secrets/env-vars.sh
                        
                        # Exporter les URLs des serveurs si elles existent dans le fichier de secrets
                        if yq eval '.rhdemo.servers.staging' ${SECRETS_DECRYPTED} > /dev/null 2>&1; then
                            echo "export STAGING_SERVER=$(yq eval '.rhdemo.servers.staging' ${SECRETS_DECRYPTED})" >> rhDemo/secrets/env-vars.sh
                        fi
                        
                        if yq eval '.rhdemo.servers.production' ${SECRETS_DECRYPTED} > /dev/null 2>&1; then
                            echo "export PROD_SERVER=$(yq eval '.rhdemo.servers.production' ${SECRETS_DECRYPTED})" >> rhDemo/secrets/env-vars.sh
                        fi
                        
                        # Afficher (sans montrer les valeurs)
                        echo "âœ… Variables d'environnement prÃ©parÃ©es"
                    '''
                }
            }
            post {
                always {
                    script {
                        // Supprimer le fichier dÃ©chiffrÃ© pour la sÃ©curitÃ©
                        sh 'rm -f ${SECRETS_DECRYPTED} || true'
                    }
                }
            }
        }
        
        stage('ï¿½ğŸ” VÃ©rification Environnement') {
            steps {
                script {
                    echo 'â–¶ VÃ©rification de l\'environnement...'
                    // Charger les variables d'environnement depuis le fichier
                    sh '''
                        # Charger les secrets
                        . rhDemo/secrets/env-vars.sh
                        
                        echo "Java version:"
                        java -version
                        echo "\nMaven version:"
                        cd rhDemo && ./mvnw -version
                        echo "\nVariables d'environnement:"
                        env | grep RHDEMO || echo "Variables RHDEMO configurÃ©es"
                    '''
                }
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PHASE 2 : BUILD
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        stage('ğŸ“¦ Compilation Backend') {
            steps {
                script {
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo '  PHASE 2 : BUILD'
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo 'â–¶ Compilation du backend Spring Boot...'
                }
                sh '''
                    # Charger les secrets pour la compilation
                    . rhDemo/secrets/env-vars.sh
                    cd rhDemo && ./mvnw clean compile -DskipTests
                '''
            }
        }
        
        stage('ğŸ¨ Build Frontend Vue.js') {
            steps {
                script {
                    echo 'â–¶ Build du frontend Vue.js via Maven...'
                }
                sh '''
                    echo "Installation Node.js et build Vue.js automatique via frontend-maven-plugin"
                    cd rhDemo/frontend
                    ls -la node/ || echo "Node.js sera installÃ© par Maven"
                '''
            }
        }
        
        stage('ğŸ”¨ Build') {
            steps {
                script {
                    echo "ğŸ”¨ Compilation et packaging de l'application..."
                    sh """
                        . rhDemo/secrets/env-vars.sh
                        cd rhDemo && ./mvnw clean package -DskipTests
                    """
                }
            }
        }
        
        stage('ğŸ³ Build Docker Image (Paketo)') {
            steps {
                script {
                    echo "ğŸ³ Construction de l'image Docker avec Paketo Buildpacks..."
                    sh """
                        . rhDemo/secrets/env-vars.sh
                        cd rhDemo && ./mvnw spring-boot:build-image \
                            -Dspring-boot.build-image.imageName=${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} \
                            -DskipTests
                    """
                    
                    echo "âœ… Image Docker crÃ©Ã©e: ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"
                    
                    // Lister les images crÃ©Ã©es
                    sh "docker images | grep ${DOCKER_IMAGE_NAME} || true"
                }
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PHASE 3 : QUALITÃ‰ DU CODE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        stage('ğŸ§ª Tests Unitaires') {
            steps {
                script {
                    echo "ğŸ§ª ExÃ©cution des tests unitaires..."
                    sh """
                        . rhDemo/secrets/env-vars.sh
                        cd rhDemo && ./mvnw test
                    """
                }
            }
        }
        
        stage('ğŸ” Analyse SonarQube') {
            when {
                expression { params.RUN_SONAR == true }
            }
            steps {
                script {
                    echo 'â–¶ Analyse de qualitÃ© du code avec SonarQube...'
                }
                withSonarQubeEnv('SonarQube') {
                    sh '''
                        # Charger les secrets pour l'analyse
                        . rhDemo/secrets/env-vars.sh
                        cd rhDemo && ./mvnw sonar:sonar \
                            -Dsonar.projectKey=rhdemo-api \
                            -Dsonar.projectName="RHDemo API" \
                            -Dsonar.java.binaries=target/classes
                    '''
                }
            }
        }
        
        stage('ğŸ“Š Quality Gate') {
            when {
                expression { params.RUN_SONAR == true }
            }
            steps {
                script {
                    echo 'â–¶ Attente du Quality Gate SonarQube...'
                }
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate abortPipeline: true
                }
            }
        }
        
        stage('ğŸ“ˆ Couverture de Code') {
            steps {
                script {
                    echo 'â–¶ GÃ©nÃ©ration du rapport de couverture JaCoCo...'
                }
                sh '''
                    # Charger les secrets pour le rapport
                    . rhDemo/secrets/env-vars.sh
                    cd rhDemo && ./mvnw jacoco:report
                '''
                jacoco(
                    execPattern: '**/rhDemo/target/jacoco.exec',
                    classPattern: '**/rhDemo/target/classes',
                    sourcePattern: '**/rhDemo/src/main/java'
                )
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PHASE 4 : TESTS FONCTIONNELS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        stage('ğŸš€ DÃ©marrage App Test') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo '  PHASE 4 : TESTS FONCTIONNELS'
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo 'â–¶ DÃ©marrage de l\'application en mode test (Docker)...'
                    
                    // DÃ©marrage du container Docker
                    sh """
                        . rhDemo/secrets/env-vars.sh
                        
                        # ArrÃªter le container s'il existe dÃ©jÃ 
                        docker stop rhdemo-test 2>/dev/null || true
                        docker rm rhdemo-test 2>/dev/null || true
                        
                        # DÃ©marrer le container en arriÃ¨re-plan
                        docker run -d \
                            --name rhdemo-test \
                            -p ${TEST_PORT}:9000 \
                            -e SPRING_PROFILES_ACTIVE=test \
                            -e RHDEMO_DATASOURCE_PASSWORD_H2=\${RHDEMO_DATASOURCE_PASSWORD_H2} \
                            -e RHDEMO_CLIENT_REGISTRATION_KEYCLOAK_CLIENT_SECRET=\${RHDEMO_CLIENT_REGISTRATION_KEYCLOAK_CLIENT_SECRET} \
                            ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}
                        
                        # Sauvegarder le nom du container
                        echo "rhdemo-test" > app-test.container
                    """
                    
                    // Attente de disponibilitÃ©
                    sh '''
                        echo "Attente du dÃ©marrage de l'application..."
                        for i in {1..60}; do
                            if curl -s http://localhost:${TEST_PORT}/actuator/health > /dev/null; then
                                echo "âœ… Application dÃ©marrÃ©e avec succÃ¨s!"
                                exit 0
                            fi
                            echo "Tentative $i/60..."
                            sleep 2
                        done
                        echo "âŒ Ã‰chec du dÃ©marrage de l'application"
                        docker logs rhdemo-test
                        exit 1
                    '''
                }
            }
        }
        
        stage('ğŸŒ Tests Selenium IHM') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo 'â–¶ ExÃ©cution des tests Selenium...'
                }
                dir(TEST_PROJECT_PATH) {
                    sh '''
                        # Utilisation du wrapper Maven du projet principal
                        cd ${WORKSPACE}/rhDemo && ./mvnw clean test -f ../${TEST_PROJECT_PATH}/pom.xml \
                            -Dtest.baseurl=http://localhost:${TEST_PORT} \
                            -Dselenium.headless=true
                    '''
                }
            }
            post {
                always {
                    script {
                        // Archivage des screenshots en cas d'Ã©chec
                        dir(TEST_PROJECT_PATH) {
                            archiveArtifacts artifacts: '**/screenshots/**/*.png', allowEmptyArchive: true
                            junit '**/target/surefire-reports/*.xml'
                        }
                    }
                }
            }
        }
        
        stage('ğŸ›‘ ArrÃªt App Test') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo 'â–¶ ArrÃªt de l\'application test...'
                    sh '''
                        if [ -f app-test.container ]; then
                            CONTAINER=$(cat app-test.container)
                            echo "ArrÃªt du container: $CONTAINER"
                            docker stop $CONTAINER || echo "Container dÃ©jÃ  arrÃªtÃ©"
                            docker rm $CONTAINER || echo "Container dÃ©jÃ  supprimÃ©"
                            rm app-test.container
                        fi
                    '''
                }
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PHASE 5 : SÃ‰CURITÃ‰
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        stage('ğŸ”’ Scan VulnÃ©rabilitÃ©s') {
            steps {
                script {
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo '  PHASE 5 : SÃ‰CURITÃ‰'
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo 'â–¶ Analyse des vulnÃ©rabilitÃ©s des dÃ©pendances...'
                }
                sh '''
                    # Charger les secrets pour l'analyse de sÃ©curitÃ©
                    . rhDemo/secrets/env-vars.sh
                    cd rhDemo && ./mvnw org.owasp:dependency-check-maven:check
                '''
            }
            post {
                always {
                    publishHTML([
                        reportDir: 'rhDemo/target',
                        reportFiles: 'dependency-check-report.html',
                        reportName: 'OWASP Dependency Check',
                        allowMissing: true,
                        keepAll: true,
                        alwaysLinkToLastBuild: true
                    ])
                }
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PHASE 6 : ARCHIVAGE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        stage('ğŸ“š Archivage Artifacts') {
            steps {
                script {
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo '  PHASE 6 : ARCHIVAGE'
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo 'â–¶ Archivage du JAR et des rapports...'
                }
                archiveArtifacts artifacts: "${JAR_FILE}", fingerprint: true
                archiveArtifacts artifacts: '**/target/surefire-reports/**', allowEmptyArchive: true
            }
        }
        
        stage('ğŸ“ GÃ©nÃ©ration Rapports') {
            steps {
                script {
                    echo 'â–¶ Publication des rapports...'
                }
                publishHTML([
                    reportDir: 'target/site/jacoco',
                    reportFiles: 'index.html',
                    reportName: 'Code Coverage',
                    allowMissing: true,
                    keepAll: true,
                    alwaysLinkToLastBuild: true
                ])
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PHASE 7 : DÃ‰PLOIEMENT STAGING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        stage('ğŸ­ DÃ©ploiement Staging') {
            when {
                expression { params.DEPLOY_ENV == 'staging' || params.DEPLOY_ENV == 'production' }
            }
            steps {
                script {
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo '  PHASE 7 : DÃ‰PLOIEMENT STAGING'
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo 'â–¶ DÃ©ploiement sur l\'environnement de staging...'
                }
                sh '''
                    # Charger les secrets et URLs de serveurs
                    . rhDemo/secrets/env-vars.sh
                    
                    # DÃ©ploiement via SSH ou script de dÃ©ploiement
                    echo "Copie du JAR vers le serveur de staging..."
                    # scp ${JAR_FILE} user@${STAGING_SERVER}:/opt/rhdemo/
                    
                    echo "RedÃ©marrage de l'application sur staging..."
                    # ssh user@${STAGING_SERVER} "systemctl restart rhdemo-api"
                    
                    echo "âœ… DÃ©ploiement staging simulÃ© (dÃ©commenter les commandes SSH)"
                '''
            }
        }
        
        stage('ğŸ’¨ Tests de FumÃ©e Staging') {
            when {
                expression { params.DEPLOY_ENV == 'staging' || params.DEPLOY_ENV == 'production' }
            }
            steps {
                script {
                    echo 'â–¶ VÃ©rification du dÃ©ploiement staging...'
                }
                sh '''
                    # Charger les secrets et URLs de serveurs
                    . rhDemo/secrets/env-vars.sh
                    
                    echo "VÃ©rification du healthcheck..."
                    # curl -f http://${STAGING_SERVER}/actuator/health || exit 1
                    
                    echo "Test de l'authentification Keycloak..."
                    # Tests de base sur les endpoints critiques
                    
                    echo "âœ… Tests de fumÃ©e rÃ©ussis (dÃ©commenter pour activer)"
                '''
            }
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PHASE 8 : PRODUCTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        stage('âœ‹ Validation Manuelle') {
            when {
                expression { 
                    params.DEPLOY_ENV == 'production' && params.SKIP_MANUAL_APPROVAL == false 
                }
            }
            steps {
                script {
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo '  PHASE 8 : PRODUCTION'
                    echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                    echo 'â–¶ Approbation manuelle requise pour la production...'
                }
                timeout(time: 30, unit: 'MINUTES') {
                    input message: 'DÃ©ployer en production ?', 
                          ok: 'DÃ©ployer',
                          submitter: 'admin,deploy-team'
                }
            }
        }
        
        stage('ğŸ’¾ Backup Base de DonnÃ©es') {
            when {
                expression { params.DEPLOY_ENV == 'production' }
            }
            steps {
                script {
                    echo 'â–¶ Sauvegarde de la base de donnÃ©es de production...'
                }
                sh '''
                    # Charger les secrets
                    . rhDemo/secrets/env-vars.sh
                    
                    BACKUP_FILE="db-backup-$(date +%Y%m%d-%H%M%S).sql"
                    echo "CrÃ©ation du backup: ${BACKUP_FILE}"
                    # pg_dump -h ${PROD_SERVER} -U rhdemo rhdemo > ${BACKUP_FILE}
                    echo "âœ… Backup crÃ©Ã© (dÃ©commenter pour activer)"
                '''
            }
        }
        
        stage('ğŸŒ DÃ©ploiement Production') {
            when {
                expression { params.DEPLOY_ENV == 'production' }
            }
            steps {
                script {
                    echo 'â–¶ DÃ©ploiement en PRODUCTION...'
                    echo 'ğŸš€ DÃ©ploiement Blue-Green...'
                }
                sh '''
                    # Charger les secrets et URLs de serveurs
                    . rhDemo/secrets/env-vars.sh
                    
                    # StratÃ©gie Blue-Green deployment
                    echo "1. DÃ©ploiement sur le serveur Green..."
                    # scp ${JAR_FILE} user@${PROD_SERVER}-green:/opt/rhdemo/
                    
                    echo "2. DÃ©marrage du nouveau service..."
                    # ssh user@${PROD_SERVER}-green "systemctl start rhdemo-api"
                    
                    echo "3. VÃ©rification du healthcheck..."
                    # curl -f http://${PROD_SERVER}-green/actuator/health
                    
                    echo "4. Basculement du load balancer..."
                    # Commande pour basculer le trafic
                    
                    echo "5. ArrÃªt de l'ancien service (Blue)..."
                    # ssh user@${PROD_SERVER}-blue "systemctl stop rhdemo-api"
                    
                    echo "âœ… DÃ©ploiement production simulÃ© (dÃ©commenter pour activer)"
                '''
            }
        }
        
        stage('âœ… VÃ©rification Post-DÃ©ploiement') {
            when {
                expression { params.DEPLOY_ENV == 'production' }
            }
            steps {
                script {
                    echo 'â–¶ VÃ©rification du dÃ©ploiement production...'
                }
                sh '''
                    # Charger les secrets et URLs de serveurs
                    . rhDemo/secrets/env-vars.sh
                    
                    echo "Healthcheck application..."
                    # curl -f http://${PROD_SERVER}/actuator/health
                    
                    echo "VÃ©rification des mÃ©triques Prometheus..."
                    # curl -f http://${PROD_SERVER}/actuator/prometheus
                    
                    echo "Test des endpoints critiques..."
                    # Tests automatisÃ©s sur la production
                    
                    echo "âœ… Application en production fonctionnelle"
                '''
            }
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // POST-ACTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    post {
        always {
            script {
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                echo '  NETTOYAGE ET NOTIFICATIONS'
                echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
                echo 'Note: Le nettoyage du workspace se fait automatiquement entre les builds'
            }
        }
        
        success {
            script {
                def deployInfo = params.DEPLOY_ENV != 'none' ? " et dÃ©ployÃ© en ${params.DEPLOY_ENV}" : ""
                echo "âœ… Pipeline rÃ©ussi${deployInfo} !"
            }
            
            // Email de notification
            emailext(
                subject: "âœ… BUILD SUCCESS - RHDemo API #${env.BUILD_NUMBER}",
                body: """
                    Le build de RHDemo API a rÃ©ussi !
                    
                    Branch: ${env.BRANCH_NAME}
                    Commit: ${env.GIT_COMMIT}
                    DÃ©ploiement: ${params.DEPLOY_ENV}
                    
                    Voir les dÃ©tails: ${env.BUILD_URL}
                """,
                to: "${env.NOTIFICATION_EMAIL}"
            )
        }
        
        failure {
            script {
                echo "âŒ Pipeline Ã©chouÃ© !"
            }
            
            // Email d'alerte
            emailext(
                subject: "âŒ BUILD FAILED - RHDemo API #${env.BUILD_NUMBER}",
                body: """
                    âš ï¸ Le build de RHDemo API a Ã©chouÃ© !
                    
                    Branch: ${env.BRANCH_NAME}
                    Stage: ${env.STAGE_NAME}
                    
                    Voir les logs: ${env.BUILD_URL}console
                """,
                to: "${env.NOTIFICATION_EMAIL}",
                attachLog: true
            )
        }
        
        unstable {
            script {
                echo "âš ï¸ Pipeline instable (tests Ã©chouÃ©s mais build rÃ©ussi)"
            }
        }
    }
}
