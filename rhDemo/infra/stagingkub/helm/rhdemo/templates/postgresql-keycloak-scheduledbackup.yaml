{{- if and .Values.keycloak.cloudnativepg.enabled .Values.keycloak.cloudnativepg.backup.enabled .Values.keycloak.cloudnativepg.backup.schedule }}
apiVersion: postgresql.cnpg.io/v1
kind: ScheduledBackup
metadata:
  name: postgresql-keycloak-backup
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "postgresql-keycloak.labels" . | nindent 4 }}
    app: postgresql-keycloak
spec:
  # Planning des backups (cron format)
  schedule: {{ .Values.keycloak.cloudnativepg.backup.schedule | quote }}

  # Suspension des backups (utile pour maintenance)
  suspend: {{ .Values.keycloak.cloudnativepg.backup.suspend | default false }}

  # Immediate backup (déclenche immédiatement un backup)
  immediate: {{ .Values.keycloak.cloudnativepg.backup.immediate | default false }}

  # Référence au cluster PostgreSQL
  cluster:
    name: postgresql-keycloak

  # Méthode de backup
  {{- if .Values.keycloak.cloudnativepg.backup.barmanObjectStore }}
  # Backup via Barman Object Store (S3, MinIO, etc.)
  backupOwnerReference: self
  {{- else }}
  # Backup via VolumeSnapshot
  method: volumeSnapshot
  {{- end }}
{{- end }}
