{{- if and (index .Values "postgresql-rhdemo").cloudnativepg.enabled (index .Values "postgresql-rhdemo").cloudnativepg.backup.enabled (index .Values "postgresql-rhdemo").cloudnativepg.backup.schedule }}
apiVersion: postgresql.cnpg.io/v1
kind: ScheduledBackup
metadata:
  name: postgresql-rhdemo-backup
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "postgresql-rhdemo.labels" . | nindent 4 }}
    app: postgresql-rhdemo
spec:
  # Planning des backups (cron format)
  schedule: {{ (index .Values "postgresql-rhdemo").cloudnativepg.backup.schedule | quote }}

  # Suspension des backups (utile pour maintenance)
  suspend: {{ (index .Values "postgresql-rhdemo").cloudnativepg.backup.suspend | default false }}

  # Immediate backup (déclenche immédiatement un backup)
  immediate: {{ (index .Values "postgresql-rhdemo").cloudnativepg.backup.immediate | default false }}

  # Référence au cluster PostgreSQL
  cluster:
    name: postgresql-rhdemo

  # Méthode de backup
  {{- if (index .Values "postgresql-rhdemo").cloudnativepg.backup.barmanObjectStore }}
  # Backup via Barman Object Store (S3, MinIO, etc.)
  backupOwnerReference: self
  {{- else }}
  # Backup via VolumeSnapshot
  method: volumeSnapshot
  {{- end }}
{{- end }}
