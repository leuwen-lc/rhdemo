pipeline {
    agent any
    
    tools {
        jdk 'JDK21'  // Nom configur√© dans Jenkins Global Tool Configuration
        maven 'Maven3' // Nom configur√© dans Jenkins Global Tool Configuration
    }
    
    environment {
        // Configuration du pipeline
        APP_NAME = 'rhdemo-api'
        APP_VERSION = '0.0.1-SNAPSHOT'
        JAR_FILE = "rhDemo/target/rhdemoAPI-${APP_VERSION}.jar"

        // Configuration notifications email
        // √Ä configurer : remplacer par votre email ou utiliser Jenkins Credentials
        //NOTIFICATION_EMAIL = 'moi@monserveur.com'

        // Configuration Docker
        DOCKER_IMAGE_NAME = "rhdemo-api"
        DOCKER_IMAGE_TAG = "${APP_VERSION}"
        DOCKER_REGISTRY = "" // Laisser vide pour Docker Hub ou sp√©cifier registry priv√©

        // Versions des images Docker de base
        NGINX_IMAGE = "nginx:1.27-alpine"
        POSTGRES_IMAGE = "postgres:16-alpine"
        KEYCLOAK_IMAGE = "quay.io/keycloak/keycloak:26.4.2"
        
        // Configuration des tests
        TEST_PORT = '9000'
        TEST_PROJECT_PATH = 'rhDemoAPITestIHM'
        
        // Fichiers de secrets SOPS
        SECRETS_FILE = 'rhDemo/secrets/secrets-staging.yml'
        SECRETS_DECRYPTED = 'rhDemo/secrets/secrets-decrypted.yml'
        
        // Configuration environnement staging (Docker Compose)
        STAGING_INFRA_PATH = 'rhDemo/infra/staging'
        KEYCLOAK_INIT_PATH = 'rhDemoInitKeycloak'
        TEST_DOMAIN = 'rhdemo.staging.local'
        KEYCLOAK_DOMAIN = 'keycloak.staging.local'
        COMPOSE_PROJECT_NAME = "rhdemo-staging-${env.BUILD_NUMBER}"
        RHDEMO_IMAGE = "${DOCKER_IMAGE_NAME}:build-${env.BUILD_NUMBER}"
    }
    
    parameters {
        choice(name: 'DEPLOY_ENV', choices: ['staging', 'production', 'none'], description: 'Environnement de d√©ploiement (staging par d√©faut)')
        booleanParam(name: 'RUN_SELENIUM_TESTS', defaultValue: true, description: 'Ex√©cuter les tests Selenium')
        booleanParam(name: 'RUN_SONAR', defaultValue: false, description: 'Ex√©cuter l\'analyse SonarQube')
        booleanParam(name: 'SKIP_MANUAL_APPROVAL', defaultValue: false, description: 'Ignorer l\'approbation manuelle pour la production')
    }
    
    stages {
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 1 : PR√âPARATION
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('üõ†Ô∏è Checkout') {
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 1 : PR√âPARATION'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                }
                checkout scm
                sh 'git log -1 --pretty=format:"%h - %an : %s"'
                
                script {
                    echo '‚ñ∂ V√©rification du projet rhDemoInitKeycloak...'
                    // rhDemoInitKeycloak est dans le M√äME repo que rhDemo
                    // Le checkout SCM r√©cup√®re en principe tout le workspace
                }
                
                sh '''
                    if [ -d "rhDemoInitKeycloak" ]; then
                        echo "‚úÖ rhDemoInitKeycloak trouv√© dans le workspace"
                        ls -la rhDemoInitKeycloak
                    else
                        echo "‚ùå rhDemoInitKeycloak introuvable"
                        echo "Structure du workspace:"
                        ls -la
                        exit 1
                    fi
                '''
            }
        }
        
        stage(' D√©chiffrement Secrets SOPS') {
            steps {
                script {
                    echo '‚ñ∂ V√©rification SOPS et YQ...'
                }
                sh '''
                    sops --version
                    yq --version
                '''
                
                script {
                    echo '‚ñ∂ D√©chiffrement du fichier de secrets...'
                }
                
                // Utiliser le credential sops-age-key de mani√®re s√©curis√©e
                withCredentials([file(credentialsId: 'sops-age-key', variable: 'SOPS_AGE_KEY_FILE')]) {
                    sh '''
                        # Cr√©er le r√©pertoire secrets s'il n'existe pas
                        mkdir -p rhDemo/secrets
                        
                        # D√©chiffrer le fichier de secrets
                        echo "D√©chiffrement de ${SECRETS_FILE}..."
                        sops -d ${SECRETS_FILE} > ${SECRETS_DECRYPTED}
                        
                        # V√©rifier que le fichier a √©t√© d√©chiffr√©
                        if [ ! -f ${SECRETS_DECRYPTED} ]; then
                            echo "‚ùå √âchec du d√©chiffrement"
                            exit 1
                        fi
                        
                        echo "‚úÖ Secrets d√©chiffr√©s avec succ√®s"
                        
                        # Extraire les valeurs pour les variables d'environnement
                        # S√âCURIT√â: D√©sactiver l'√©cho des commandes pour ne pas exposer les secrets dans les logs
                        set +x

                        # Exporter les secrets comme variables d'environnement pour les stages suivants
                        # Utilisation de substitution de variables sans affichage dans stdout
                        {
                            echo "export RHDEMO_DATASOURCE_PASSWORD_PG=$(yq eval '.rhdemo.datasource.password.pg' ${SECRETS_DECRYPTED})"
                            echo "export RHDEMO_DATASOURCE_PASSWORD_H2=$(yq eval '.rhdemo.datasource.password.h2' ${SECRETS_DECRYPTED})"
                            echo "export RHDEMO_CLIENT_REGISTRATION_KEYCLOAK_CLIENT_SECRET=$(yq eval '.rhdemo.client.registration.keycloak.client.secret' ${SECRETS_DECRYPTED})"

                            # Mots de passe Keycloak pour environnement staging
                            echo "export KEYCLOAK_DB_PASSWORD=$(yq eval '.keycloak.db.password' ${SECRETS_DECRYPTED})"
                            echo "export KEYCLOAK_ADMIN_PASSWORD=$(yq eval '.keycloak.admin.password' ${SECRETS_DECRYPTED})"
                            echo "export KEYCLOAK_ADMIN_USER=$(yq eval '.keycloak.admin.user // "admin"' ${SECRETS_DECRYPTED})"

                            # Utilisateurs et mots de passe de test (chiffr√©s dans SOPS)
                            echo "export RHDEMO_TEST_ID_USER_ADMIN=$(yq eval '.rhdemo.test.iduseradmin' ${SECRETS_DECRYPTED})"
                            echo "export RHDEMO_TEST_PWD_USER_ADMIN=$(yq eval '.rhdemo.test.pwduseradmin' ${SECRETS_DECRYPTED})"
                            echo "export RHDEMO_TEST_ID_USER_MAJ=$(yq eval '.rhdemo.test.idusermaj' ${SECRETS_DECRYPTED})"
                            echo "export RHDEMO_TEST_PWD_USER_MAJ=$(yq eval '.rhdemo.test.pwdusermaj' ${SECRETS_DECRYPTED})"
                            echo "export RHDEMO_TEST_ID_USER_CONSULT=$(yq eval '.rhdemo.test.iduserconsult' ${SECRETS_DECRYPTED})"
                            echo "export RHDEMO_TEST_PWD_USER_CONSULT=$(yq eval '.rhdemo.test.pwduserconsult' ${SECRETS_DECRYPTED})"

                            # URLs des serveurs si elles existent
                            if yq eval '.rhdemo.servers.staging' ${SECRETS_DECRYPTED} > /dev/null 2>&1; then
                                echo "export STAGING_SERVER=$(yq eval '.rhdemo.servers.staging' ${SECRETS_DECRYPTED})"
                            fi

                            if yq eval '.rhdemo.servers.production' ${SECRETS_DECRYPTED} > /dev/null 2>&1; then
                                echo "export PROD_SERVER=$(yq eval '.rhdemo.servers.production' ${SECRETS_DECRYPTED})"
                            fi
                        } > rhDemo/secrets/env-vars.sh 2>&1

                        # R√©activer l'√©cho des commandes
                        set -x

                        # Afficher (sans montrer les valeurs)
                        echo "‚úÖ Variables d'environnement pr√©par√©es"
                    '''
                }
            }
            post {
                always {
                    script {
                        // Supprimer le fichier d√©chiffr√© pour la s√©curit√©
                        sh 'rm -f ${SECRETS_DECRYPTED} || true'
                    }
                }
            }
        }

        stage('üîê Extraction secrets rhDemo (moindre privil√®ge)') {
            steps {
                script {
                    echo '‚ñ∂ Cr√©ation du fichier secrets-rhdemo.yml pour rhDemo (uniquement les secrets n√©cessaires)...'
                    echo '   ‚ö†Ô∏è  Principe du moindre privil√®ge: rhDemo ne re√ßoit QUE ses propres secrets'
                    echo '   ‚úÖ Exclus: mots de passe admin Keycloak, secrets infra, etc.'
                }

                sh '''
                    # S√âCURIT√â: D√©sactiver l'√©cho des commandes
                    set +x

                    # Source les secrets
                    . rhDemo/secrets/env-vars.sh

                    # Cr√©er un fichier secrets-rhdemo.yml contenant UNIQUEMENT les secrets rhDemo
                    # Ce fichier sera mont√© dans le container Docker de rhDemo
                    cat > rhDemo/secrets/secrets-rhdemo.yml <<EOF
# Secrets pour l'application rhDemo (environnement staging)
# G√©n√©r√© automatiquement par Jenkins
# ‚ö†Ô∏è  Ce fichier ne contient QUE les secrets n√©cessaires √† rhDemo (moindre privil√®ge)

rhdemo:
  datasource:
    password:
      pg: ${RHDEMO_DATASOURCE_PASSWORD_PG}
      h2: ${RHDEMO_DATASOURCE_PASSWORD_H2}
  client:
    registration:
      keycloak:
        client:
          secret: ${RHDEMO_CLIENT_REGISTRATION_KEYCLOAK_CLIENT_SECRET}
EOF

                    # R√©activer l'√©cho
                    set -x

                    echo "‚úÖ Fichier rhDemo/secrets/secrets-rhdemo.yml cr√©√© (secrets limit√©s √† rhDemo uniquement)"
                    echo "   - datasource.password.pg: ‚úÖ"
                    echo "   - datasource.password.h2: ‚úÖ"
                    echo "   - client.registration.keycloak.client.secret: ‚úÖ"
                    echo "   - Keycloak admin password: ‚ùå (non inclus - s√©curit√©)"
                    echo "   - Keycloak DB password: ‚ùå (non inclus - s√©curit√©)"
                '''
            }
        }

        stage('üîß Configuration rhDemoInitKeycloak') {
            steps {
                script {
                    echo '‚ñ∂ G√©n√©ration de application-staging.yml pour rhDemoInitKeycloak...'
                    echo '   (Sera utilis√© directement via mvnw spring-boot:run, sans packaging JAR)'
                }
                
                sh '''
                    # S√âCURIT√â: D√©sactiver l'√©cho des commandes pour ne pas exposer les secrets
                    set +x

                    # Source les secrets d√©chiffr√©s
                    . rhDemo/secrets/env-vars.sh

                    # R√©activer l'√©cho pour les commandes non sensibles
                    set -x

                    # G√©n√©rer application-staging.yml (sera utilis√© directement par Maven)
                    CONFIG_FILE="rhDemoInitKeycloak/src/main/resources/application-staging.yml"
                    
                    # IMPORTANT: Sans guillemets sur YMLEOF pour que bash substitue les variables
                    cat > "${CONFIG_FILE}" << YMLEOF
# ========================================
# Configuration Keycloak Server - STAGING
# G√©n√©r√©e automatiquement par Jenkins CI/CD
# ========================================
keycloak:
  # URL interne HTTP pour rhDemoInitKeycloak (ex√©cut√© dans le r√©seau Docker)
  # Pas besoin de HTTPS car communication interne s√©curis√©e par le r√©seau isol√©
  server-url: http://keycloak-staging:8080
  
  admin:
    realm: master
    username: ${KEYCLOAK_ADMIN_USER}
    password: ${KEYCLOAK_ADMIN_PASSWORD}
  
  # ========================================
  # Configuration du Realm RHDemo
  # ========================================
  realm:
    name: RHDemo
    display-name: RHDemo Application
    enabled: true
    registration-allowed: false
    registration-email-as-username: false
    reset-password-allowed: true
    edit-username-allowed: false
    login-with-email-allowed: true
    duplicate-emails-allowed: false
    remember-me: true
    sso-session-idle-timeout: 1800
    sso-session-max-lifespan: 36000
    access-token-lifespan: 300
  
  # ========================================
  # Configuration du Client RHDemo
  # ========================================
  client:
    client-id: RHDemo
    name: RHDemo
    secret: ${RHDEMO_CLIENT_REGISTRATION_KEYCLOAK_CLIENT_SECRET}
    root-url: https://${TEST_DOMAIN}/
    base-url: ''
    admin-url: ''
    redirect-uris:
      - https://${TEST_DOMAIN}/*
      - http://localhost:9000/*
      - https://rhdemo.staging.local/*
      - https://keycloak.staging.local/*
    web-origins:
      - https://${TEST_DOMAIN}
      - http://localhost:9000
      - https://rhdemo.staging.local
      - https://keycloak.staging.local
    roles:
      - ROLE_admin
      - ROLE_consult
      - ROLE_MAJ
  
  # ========================================
  # Configuration des Utilisateurs de test
  # ========================================
  users:
    - username: ${RHDEMO_TEST_ID_USER_ADMIN}
      password: ${RHDEMO_TEST_PWD_USER_ADMIN}
      email: ${RHDEMO_TEST_ID_USER_ADMIN}@rhdemo.local
      first-name: Admin
      last-name: RHDemo
      roles:
        - ROLE_admin

    - username: ${RHDEMO_TEST_ID_USER_CONSULT}
      password: ${RHDEMO_TEST_PWD_USER_CONSULT}
      email: ${RHDEMO_TEST_ID_USER_CONSULT}@rhdemo.local
      first-name: Jean
      last-name: Consultant
      roles:
        - ROLE_consult

    - username: ${RHDEMO_TEST_ID_USER_MAJ}
      password: ${RHDEMO_TEST_PWD_USER_MAJ}
      email: ${RHDEMO_TEST_ID_USER_MAJ}@rhdemo.local
      first-name: Marie
      last-name: Manager
      roles:
        - ROLE_consult
        - ROLE_MAJ
YMLEOF
                    
                    echo "‚úÖ Configuration g√©n√©r√©e: ${CONFIG_FILE}"
                    
                    # V√©rifier que les variables sont bien substitu√©es (sans afficher les secrets)
                    echo ""
                    echo "üîç V√©rification de la configuration:"
                    echo "   Root URL:"
                    grep "root-url:" "${CONFIG_FILE}"
                    echo ""
                    echo "‚úÖ Configuration sensible cr√©√©e (secrets non affich√©s pour s√©curit√©)"
                    echo ""
                    
                    # V√©rifier qu'il n'y a pas de ${VAR} litt√©rales (non substitu√©es)
                    if grep -q '\${' "${CONFIG_FILE}"; then
                        echo "‚ùå ERREUR: Variables non substitu√©es d√©tect√©es!"
                        echo "   Variables trouv√©es:"
                        grep '\${' "${CONFIG_FILE}"
                        exit 1
                    fi
                    
                    echo "‚úÖ Configuration g√©n√©r√©e avec toutes les variables substitu√©es"
                '''
                
                script {
                    echo '‚úÖ rhDemoInitKeycloak configur√© (pr√™t pour ex√©cution via mvnw)'
                }
            }
        }
        
        stage('ÔøΩüîç V√©rification Environnement') {
            steps {
                script {
                    echo '‚ñ∂ V√©rification de l\'environnement...'
                    // Charger les variables d'environnement depuis le fichier
                    sh '''
                        # Charger les secrets
                        . rhDemo/secrets/env-vars.sh
                        
                        echo "Java version:"
                        java -version
                        echo "\nMaven version:"
                        cd rhDemo && ./mvnw -version
                        echo "\nVariables d'environnement:"
                        env | grep RHDEMO || echo "Variables RHDEMO configur√©es"
                    '''
                }
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 2 : BUILD
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('üì¶ Compilation Backend') {
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 2 : BUILD'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '‚ñ∂ Compilation du backend Spring Boot...'
                }
                sh '''
                    # Charger les secrets pour la compilation
                    . rhDemo/secrets/env-vars.sh
                    cd rhDemo && ./mvnw clean compile -DskipTests
                '''
            }
        }
        
        stage('üé® Build Frontend Vue.js') {
            steps {
                script {
                    echo '‚ñ∂ Build du frontend Vue.js via Maven...'
                }
                sh '''
                    echo "Installation Node.js et build Vue.js automatique via frontend-maven-plugin"
                    cd rhDemo/frontend
                    ls -la node/ || echo "Node.js sera install√© par Maven"
                '''
            }
        }
        
        stage('üî® Build') {
            steps {
                script {
                    echo "üî® Compilation et packaging de l'application..."
                    sh """
                        . rhDemo/secrets/env-vars.sh
                        cd rhDemo && ./mvnw clean package -DskipTests
                    """
                }
            }
        }

        stage('üîí Analyse S√©curit√© D√©pendances (OWASP)') {
            steps {
                script {
                    echo '‚ñ∂ Analyse des vuln√©rabilit√©s des d√©pendances (OWASP Dependency-Check)...'
                    echo '   ‚ö†Ô∏è  Le build √©chouera si vuln√©rabilit√©s CVSS ‚â• 7.0 (High/Critical)'
                }
                sh '''
                    # Charger les secrets pour l'analyse de s√©curit√©
                    . rhDemo/secrets/env-vars.sh
                    cd rhDemo && ./mvnw org.owasp:dependency-check-maven:check
                '''
            }
            post {
                always {
                    publishHTML([
                        reportDir: 'rhDemo/target',
                        reportFiles: 'dependency-check-report.html',
                        reportName: 'OWASP Dependency Check',
                        allowMissing: true,
                        keepAll: true,
                        alwaysLinkToLastBuild: true
                    ])
                }
            }
        }

        stage('üê≥ Build Docker Image (Paketo)') {
            steps {
                script {
                    echo "üê≥ Construction de l'image Docker avec Paketo Buildpacks..."
                    echo "‚ö†Ô∏è  Nettoyage complet: suppression cache Docker + target/ + images existantes..."
                    
                    // Supprimer les anciennes images Docker pour forcer reconstruction
                    sh """
                        docker rmi ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} 2>/dev/null || echo "Image n'existe pas encore"
                        docker system prune -f --filter "label=io.buildpacks.stack.id" || true
                    """
                    
                    // CRITIQUE: Supprimer PHYSIQUEMENT target/ avant build image Docker
                    // pour √©viter que Paketo r√©utilise un JAR avec ancienne configuration
                    sh """
                        echo "üóëÔ∏è  Suppression physique du target/ avant build image..."
                        cd rhDemo && rm -rf target/
                    """
                    
                    sh """
                        . rhDemo/secrets/env-vars.sh
                        cd rhDemo && ./mvnw clean spring-boot:build-image \
                            -Dspring-boot.build-image.imageName=${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} \
                            -Dspring-boot.build-image.pullPolicy=IF_NOT_PRESENT \
                            -Dspring-boot.build-image.publish=false \
                            -Dspring-boot.build-image.cleanCache=true \
                            -DskipTests
                    """
                    
                    echo "‚úÖ Image Docker cr√©√©e: ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG}"
                    
                    // Lister les images cr√©√©es
                    sh "docker images | grep ${DOCKER_IMAGE_NAME} || true"
                }
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 3 : QUALIT√â DU CODE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('üß™ Tests Unitaires et Int√©gration') {
            steps {
                script {
                    echo "üß™ Ex√©cution des tests unitaires et d'int√©gration..."
                    echo "   - Tests unitaires (Surefire)"
                    echo "   - Tests d'int√©gration (Failsafe)"
                    echo "   - G√©n√©ration du rapport JaCoCo agr√©g√© pour SonarQube"
                    sh """
                        . rhDemo/secrets/env-vars.sh
                        cd rhDemo && ./mvnw verify
                    """
                }
            }
        }
        
        stage('üîç Analyse SonarQube') {
            when {
                expression { params.RUN_SONAR == true }
            }
            steps {
                script {
                    echo '‚ñ∂ Analyse de qualit√© du code avec SonarQube...'
                    echo '   - Envoi des m√©triques de couverture (tests unitaires + int√©gration)'
                }
                withSonarQubeEnv('SonarQube') {
                    sh """
                        # Charger les secrets pour l'analyse
                        . rhDemo/secrets/env-vars.sh
                        cd rhDemo && ./mvnw sonar:sonar \\
                            -Dsonar.projectKey=rhdemo-api \\
                            -Dsonar.projectName="RHDemo API" \\
                            -Dsonar.java.binaries=target/classes \\
                            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
                    """
                }
            }
        }

        stage('üéØ Quality Gate SonarQube') {
            when {
                expression { params.RUN_SONAR == true }
            }
            steps {
                script {
                    echo '‚ñ∂ Attente du Quality Gate SonarQube...'
                    echo '   (Webhook configur√©: http://jenkins:8080/sonarqube-webhook/)'
                }
                timeout(time: 5, unit: 'MINUTES') {
                    script {
                        def qg = waitForQualityGate()
                        if (qg.status != 'OK') {
                            error "Pipeline aborted due to quality gate failure: ${qg.status}"
                        }
                        echo "‚úÖ Quality Gate passed: ${qg.status}"
                    }
                }
            }
        }
        
        stage('üìà Couverture de Code') {
            steps {
                script {
                    echo '‚ñ∂ G√©n√©ration du rapport de couverture JaCoCo...'
                }
                sh '''
                    # Charger les secrets pour le rapport
                    . rhDemo/secrets/env-vars.sh
                    cd rhDemo && ./mvnw jacoco:report
                '''
                jacoco(
                    execPattern: '**/rhDemo/target/jacoco.exec',
                    classPattern: '**/rhDemo/target/classes',
                    sourcePattern: '**/rhDemo/src/main/java'
                )
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 4 : ENVIRONNEMENT STAGING (DOCKER COMPOSE)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('‚öôÔ∏è Configuration Environnement Test') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 4 : ENVIRONNEMENT STAGING (DOCKER COMPOSE)'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '‚ñ∂ Configuration de l\'environnement de test Docker Compose...'
                    
                    // Nettoyer l'environnement pr√©c√©dent si existant
                    sh """
                        cd ${STAGING_INFRA_PATH}
                        
                        # Arr√™ter et supprimer les conteneurs du build pr√©c√©dent
                        docker-compose -p ${COMPOSE_PROJECT_NAME} down -v 2>/dev/null || true
                        
                        # Supprimer les volumes orphelins (cr√©√©s par builds pr√©c√©dents avec noms diff√©rents)
                        docker volume rm keycloak-staging-db-data rhdemo-staging-db-data rhdemo-staging-nginx-cache 2>/dev/null || true
                        
                        # IMPORTANT: Supprimer l'image nginx locale pour forcer sa recr√©ation
                        # √âvite les probl√®mes de layers corrompus o√π nginx.conf a √©t√© cr√©√© comme r√©pertoire
                        echo "üßπ Suppression image nginx pour √©viter layers corrompus..."
                        docker rmi ${NGINX_IMAGE} 2>/dev/null || true
                        
                        # Nettoyer les r√©seaux orphelins
                        docker network prune -f
                    """
                    
                    // Configuration du fichier hosts (si Jenkins tourne localement)
                    sh """
                        # V√©rifier si les entr√©es hosts existent
                        if ! grep -q "${TEST_DOMAIN}" /etc/hosts 2>/dev/null; then
                            echo "‚ö†Ô∏è  ATTENTION: Ajouter '127.0.0.1 ${TEST_DOMAIN} ${KEYCLOAK_DOMAIN}' √† /etc/hosts"
                        fi
                    """
                }
            }
        }
        
        stage('üîê G√©n√©ration Certificats SSL') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ñ∂ G√©n√©ration des certificats SSL auto-sign√©s...'
                }
                sh """
                    cd ${STAGING_INFRA_PATH}
                    ./generate-certs.sh --domain ${TEST_DOMAIN} --domain ${KEYCLOAK_DOMAIN}
                """
            }
        }
        
        stage('üè∑Ô∏è Tag Image Docker') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo "‚ñ∂ Tag de l'image Docker: ${RHDEMO_IMAGE}..."
                }
                sh """
                    docker tag ${DOCKER_IMAGE_NAME}:${DOCKER_IMAGE_TAG} ${RHDEMO_IMAGE}
                """
            }
        }
        
        stage('üê≥ D√©marrage Environnement Docker') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ñ∂ D√©marrage de l\'environnement Docker Compose (5 services)...'
                }
                sh """
                    # S√âCURIT√â: D√©sactiver l'√©cho des commandes pour ne pas exposer les secrets
                    set +x

                    # Source les secrets SOPS
                    . rhDemo/secrets/env-vars.sh

                    cd ${STAGING_INFRA_PATH}

                    # Variables d'environnement pour Docker Compose
                    # docker-compose.yml utilise image: rhdemo-api:\${APP_VERSION}
                    export APP_VERSION=build-${env.BUILD_NUMBER}
                    export WORKSPACE=\$(pwd)

                    # Export explicite des variables critiques (pour √©viter que .env les √©crase)
                    export RHDEMO_DB_PASSWORD="\${RHDEMO_DATASOURCE_PASSWORD_PG}"
                    export KEYCLOAK_DB_PASSWORD="\${KEYCLOAK_DB_PASSWORD}"
                    export KEYCLOAK_ADMIN_USER="\${KEYCLOAK_ADMIN_USER}"
                    export KEYCLOAK_ADMIN_PASSWORD="\${KEYCLOAK_ADMIN_PASSWORD}"
                    export RHDEMO_CLIENT_REGISTRATION_KEYCLOAK_CLIENT_SECRET="\${RHDEMO_CLIENT_REGISTRATION_KEYCLOAK_CLIENT_SECRET}"

                    # R√©activer l'√©cho APR√àS les exports de secrets
                    set -x

                    # Confirmation (sans afficher les secrets)
                    echo "‚úÖ Secrets export√©s avec succ√®s (secrets non affich√©s pour s√©curit√©)"
                    
                    # IMPORTANT: Nettoyage forc√© des conteneurs existants pour √©viter les conflits de noms
                    echo "üßπ Nettoyage des conteneurs staging existants..."
                    docker rm -f keycloak-staging-db rhdemo-staging-db keycloak-staging rhdemo-staging-app rhdemo-staging-nginx 2>/dev/null || true
                    echo "‚úÖ Conteneurs existants supprim√©s"
                    
                    # D√©marrer les conteneurs (plus besoin de docker-compose.jenkins.yml override)
                    echo "üöÄ D√©marrage des conteneurs Docker..."
                    docker-compose -f docker-compose.yml -p ${COMPOSE_PROJECT_NAME} up -d
                    
                    # Connecter Jenkins au r√©seau staging pour acc√®s direct aux services
                    echo "üîó Connexion de Jenkins au r√©seau staging..."
                    # Trouver le conteneur Jenkins principal (pas l'agent)
                    JENKINS_CONTAINER=\$(docker ps --filter "name=jenkins" --format "{{.Names}}" | grep -v agent | head -n 1)
                    echo "Conteneur Jenkins trouv√©: \$JENKINS_CONTAINER"
                    if [ -n "\$JENKINS_CONTAINER" ]; then
                        docker network connect rhdemo-staging-network \$JENKINS_CONTAINER 2>/dev/null || echo "‚ö†Ô∏è  Jenkins d√©j√† connect√© au r√©seau"
                        echo "‚úÖ Jenkins (\$JENKINS_CONTAINER) connect√© au r√©seau rhdemo-staging-network"
                    else
                        echo "‚ùå ERREUR: Conteneur Jenkins introuvable!"
                        docker ps --filter "name=jenkins"
                    fi
                    
                    # Attendre que les conteneurs d√©marrent (augment√© pour Keycloak)
                    echo "‚è≥ Attente d√©marrage conteneurs (20s)..."
                    sleep 20
                    
                    # Copier les configurations nginx et certificats SSL
                    echo "üìã Copie des configurations nginx..."
                    docker cp nginx/nginx.conf rhdemo-staging-nginx:/etc/nginx/nginx.conf
                    docker cp nginx/conf.d/. rhdemo-staging-nginx:/etc/nginx/conf.d/
                    
                    if [ -d "certs" ]; then
                        docker cp certs/. rhdemo-staging-nginx:/etc/nginx/ssl/
                        echo "‚úÖ Configurations nginx et certificats copi√©s"
                    else
                        echo "‚úÖ Configurations nginx copi√©es (certificats manquants)"
                    fi
                    
                    # Recharger la configuration nginx pour appliquer les changements
                    echo "üîÑ Rechargement de la configuration nginx..."
                    docker exec rhdemo-staging-nginx nginx -t  # Test de la config
                    docker exec rhdemo-staging-nginx nginx -s reload  # Reload
                    echo "‚úÖ Nginx recharg√© avec la nouvelle configuration HTTPS"
                    
                    # V√©rifier que nginx √©coute r√©ellement sur le port 443
                    echo "üîç V√©rification que nginx √©coute sur le port 443..."
                    if docker exec rhdemo-staging-nginx netstat -tuln | grep -q ':443'; then
                        echo "‚úÖ Nginx √©coute sur le port 443 (HTTPS)"
                    else
                        echo "‚ùå ERREUR: Nginx n'√©coute PAS sur le port 443!"
                        echo "Ports √©cout√©s par nginx:"
                        docker exec rhdemo-staging-nginx netstat -tuln
                        exit 1
                    fi
                    
                    echo "‚úÖ Environnement Docker op√©rationnel:"
                    docker-compose -p ${COMPOSE_PROJECT_NAME} ps
                """
            }
        }

        stage('üîê Injection secrets rhDemo dans container') {
            steps {
                script {
                    echo '‚ñ∂ Copie du fichier secrets-rhdemo.yml dans le container rhDemo...'
                    echo '   Ce fichier contient uniquement les secrets n√©cessaires √† rhDemo (moindre privil√®ge)'
                }
                sh """
                    cd ${STAGING_INFRA_PATH}

                    # Chemin du fichier secrets dans le workspace Jenkins
                    SECRETS_FILE="../../secrets/secrets-rhdemo.yml"

                    if [ ! -f "\$SECRETS_FILE" ]; then
                        echo "‚ùå Erreur: Fichier secrets-rhdemo.yml introuvable"
                        echo "Recherche dans le workspace:"
                        find ../../ -name "secrets-rhdemo.yml" || echo "Aucun fichier trouv√©"
                        exit 1
                    fi

                    echo "üìã Copie du fichier secrets dans le container..."

                    # Cr√©er le r√©pertoire en tant que root, puis changer le propri√©taire
                    # L'utilisateur CNB (Cloud Native Buildpacks) n'a pas les droits root
                    docker exec --user root rhdemo-staging-app mkdir -p /workspace/secrets
                    docker exec --user root rhdemo-staging-app chown cnb:cnb /workspace/secrets

                    # Copier le fichier
                    docker cp "\$SECRETS_FILE" rhdemo-staging-app:/workspace/secrets/secrets-rhdemo.yml

                    # D√©finir les permissions (read-only) et le propri√©taire en tant que root
                    docker exec --user root rhdemo-staging-app chown cnb:cnb /workspace/secrets/secrets-rhdemo.yml
                    docker exec --user root rhdemo-staging-app chmod 400 /workspace/secrets/secrets-rhdemo.yml

                    echo "‚úÖ Fichier secrets-rhdemo.yml copi√© dans le container"
                    echo "   Chemin: /workspace/secrets/secrets-rhdemo.yml"
                    echo "   Permissions: 400 (read-only, propri√©taire: cnb)"

                    # V√©rification (sans afficher le contenu pour s√©curit√©)
                    docker exec rhdemo-staging-app ls -lh /workspace/secrets/secrets-rhdemo.yml

                    # Red√©marrer l'application pour charger les secrets
                    # Spring Boot charge spring.config.import au d√©marrage uniquement
                    echo "üîÑ Red√©marrage de l'application pour charger les secrets..."
                    docker-compose -f docker-compose.yml -p ${COMPOSE_PROJECT_NAME} restart rhdemo-app
                    echo "‚úÖ Application red√©marr√©e (healthcheck dans le stage d√©di√©)"
                """
            }
        }

        stage('üíæ Initialisation Base de Donn√©es') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ñ∂ Initialisation de la base de donn√©es PostgreSQL...'
                }
                sh """
                    cd ${STAGING_INFRA_PATH}
                    
                    # Attendre que PostgreSQL soit pr√™t
                    echo "‚è≥ Attente PostgreSQL ready (30s max)..."
                    timeout=30
                    while [ \$timeout -gt 0 ]; do
                        if docker exec rhdemo-staging-db pg_isready -U rhdemo >/dev/null 2>&1; then
                            echo "‚úÖ PostgreSQL ready"
                            break
                        fi
                        sleep 2
                        timeout=\$((timeout - 2))
                    done
                    
                    if [ \$timeout -le 0 ]; then
                        echo "‚ùå Timeout: PostgreSQL n'est pas pr√™t apr√®s 30s"
                        docker logs --tail=20 rhdemo-staging-db
                        exit 1
                    fi
                    
                    # Copier et ex√©cuter le sch√©ma SQL
                    PGDDL_PATH="../../pgddl.sql"
                    if [ ! -f "\$PGDDL_PATH" ]; then
                        echo "‚ùå Erreur: Fichier pgddl.sql introuvable"
                        exit 1
                    fi
                    
                    echo "üìã Copie du sch√©ma SQL dans le container..."
                    docker cp "\$PGDDL_PATH" rhdemo-staging-db:/tmp/schema.sql
                    
                    echo "üîß Ex√©cution du sch√©ma SQL (DROP + CREATE + INSERT)..."
                    docker exec rhdemo-staging-db psql -U rhdemo -d rhdemo -f /tmp/schema.sql
                    
                    # V√©rifier le nombre d'employ√©s ins√©r√©s
                    EMPLOYEE_COUNT=\$(docker exec rhdemo-staging-db psql -U rhdemo -d rhdemo -t -c "SELECT COUNT(*) FROM employes;" | tr -d ' ')
                    
                    echo "‚úÖ Base de donn√©es initialis√©e"
                    echo "   üìä Nombre d'employ√©s: \$EMPLOYEE_COUNT"
                    
                    if [ "\$EMPLOYEE_COUNT" != "303" ]; then
                        echo "‚ö†Ô∏è  Attention: Attendu 303 employ√©s, trouv√© \$EMPLOYEE_COUNT"
                    fi
                """
            }
        }
        
        stage('üè• Healthcheck Keycloak') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ñ∂ Attente d√©marrage Keycloak...'
                }
                sh """
                    cd ${STAGING_INFRA_PATH}
                    
                    echo "‚è≥ Attente d√©marrage Keycloak (45s)..."
                    echo "   (Keycloak prend ~15s pour d√©marrer + init DB)"
                    sleep 45
                    
                    echo "‚è≥ V√©rification Keycloak (60s max)..."
                    timeout=60
                    while [ \$timeout -gt 0 ]; do
                        # Keycloak expose son endpoint health sur le port management (9000)
                        if curl -f http://keycloak-staging:9000/health/ready 2>/dev/null; then
                            echo "‚úÖ Keycloak ready"
                            break
                        fi
                        echo "   Tentative √©chou√©e, retry dans 2s... (reste \${timeout}s)"
                        sleep 2
                        timeout=\$((timeout - 2))
                    done
                    
                    if [ \$timeout -le 0 ]; then
                        echo "‚ùå Keycloak timeout apr√®s 60s"
                        echo "Logs Keycloak:"
                        docker logs --tail=20 keycloak-staging || true
                        exit 1
                    fi
                """
            }
        }
        
        stage('üîë Initialisation Keycloak') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ñ∂ Initialisation du realm Keycloak...'
                    echo 'Cr√©ation du realm RHDemo, client et utilisateurs'
                }
                sh """
                    # S√âCURIT√â: D√©sactiver l'√©cho des commandes pour ne pas exposer les secrets
                    set +x

                    # Source les secrets
                    . rhDemo/secrets/env-vars.sh

                    # R√©activer l'√©cho pour les commandes non sensibles
                    set -x

                    echo "üöÄ Ex√©cution de rhDemoInitKeycloak via Maven..."
                    echo "   (Utilise directement application-staging.yml g√©n√©r√©, sans packaging)"
                    
                    cd ${WORKSPACE}/rhDemoInitKeycloak
                    
                    # V√©rification que le fichier de config existe
                    CONFIG_FILE="src/main/resources/application-staging.yml"
                    if [ ! -f "\${CONFIG_FILE}" ]; then
                        echo "‚ùå Fichier de configuration manquant: \${CONFIG_FILE}"
                        exit 1
                    fi
                    
                    echo "ÔøΩ Configuration trouv√©e: \${CONFIG_FILE}"
                    echo ""
                    echo "‚úÖ Configuration Keycloak pr√©par√©e (secrets non affich√©s pour s√©curit√©)"
                    echo ""

                    # Ex√©cution directe via Maven Spring Boot plugin
                    if ./mvnw spring-boot:run -Dspring-boot.run.profiles=staging; then
                        echo ""
                        echo "‚úÖ Keycloak initialis√© avec succ√®s"
                        echo "   - Realm RHDemo cr√©√©"
                        echo "   - Client RHDemo configur√©"
                        echo "   - 3 utilisateurs cr√©√©s (admin, consultant, manager)"
                    else
                        echo ""
                        echo "‚ùå √âchec de l'initialisation Keycloak"
                        echo ""
                        echo "üìã Logs Keycloak pour diagnostic:"
                        docker logs --tail=30 keycloak-staging || true
                        exit 1
                    fi
                    
                    # Attendre propagation de la configuration
                    echo ""
                    echo "‚è≥ Attente propagation config Keycloak (10s)..."
                    sleep 10
                """
            }
        }
        
        stage('üè• Healthcheck Application RHDemo') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ñ∂ V√©rification sant√© de l\'application RHDemo...'
                }
                sh """
                    echo "‚è≥ V√©rification RHDemo App (90s max, healthcheck start_period=60s)..."
                    timeout=90
                    while [ \$timeout -gt 0 ]; do
                        # Utiliser le healthcheck Docker pour v√©rifier l'√©tat du conteneur
                        container_status=\$(docker inspect --format='{{.State.Health.Status}}' rhdemo-staging-app 2>/dev/null || echo "unknown")
                        
                        # Accepter "healthy" ou "starting" (pendant start_period)
                        if [ "\$container_status" = "healthy" ]; then
                            echo "‚úÖ RHDemo App ready (healthcheck passed)"
                            break
                        elif [ "\$container_status" = "starting" ]; then
                            # Pendant start_period, on peut aussi v√©rifier avec curl
                            http_code=\$(curl -s -o /dev/null -w "%{http_code}" http://rhdemo-staging-app:9000/front/ 2>/dev/null || echo "000")
                            if [ "\$http_code" = "302" ] || [ "\$http_code" = "301" ]; then
                                echo "‚úÖ RHDemo App ready (responding with HTTP \$http_code, healthcheck starting)"
                                break
                            fi
                        elif [ "\$container_status" = "unknown" ]; then
                            # Si pas de healthcheck, v√©rifier que le conteneur est au moins d√©marr√©
                            container_running=\$(docker inspect --format='{{.State.Running}}' rhdemo-staging-app 2>/dev/null || echo "false")
                            if [ "\$container_running" = "true" ]; then
                                echo "‚úÖ RHDemo App ready (container running)"
                                break
                            fi
                        fi
                        
                        echo "   Container status: \$container_status - retry dans 3s... (reste \${timeout}s)"
                        sleep 3
                        timeout=\$((timeout - 3))
                    done
                    
                    if [ \$timeout -le 0 ]; then
                        echo "‚ùå RHDemo App timeout apr√®s 90s"
                        echo "Container status final:"
                        docker inspect --format='Status={{.State.Status}} Health={{.State.Health.Status}}' rhdemo-staging-app || true
                        echo ""
                        echo "Logs RHDemo (derni√®res 50 lignes):"
                        docker logs --tail=50 rhdemo-staging-app || true
                        exit 1
                    fi
                    
                    echo "‚úÖ Application RHDemo op√©rationnelle"
                """
            }
        }
        
        stage('üåê Healthcheck Nginx HTTPS') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ñ∂ V√©rification de l\'acc√®s HTTPS via nginx (test end-to-end)...'
                }
                sh '''
                    echo "üîç Test acc√®s HTTPS depuis Jenkins (conditions r√©elles Selenium)..."
                    echo "   URL test√©e: https://rhdemo.staging.local/front/"
                    echo ""
                    
                    # Obtenir le conteneur Jenkins
                    JENKINS_CONTAINER=$(docker ps --filter "name=jenkins" --format "{{.Names}}" | grep -v "agent" | head -n 1)
                    
                    # Test depuis Jenkins (l√† o√π Firefox tourne)
                    timeout=30
                    while [ $timeout -gt 0 ]; do
                        HTTP_CODE=$(docker exec ${JENKINS_CONTAINER} curl -k -s -o /dev/null -w "%{http_code}" https://rhdemo.staging.local/front/ 2>/dev/null || echo "000")
                        
                        # Accepter 302 (redirect OAuth2) ou 200
                        if echo "${HTTP_CODE}" | grep -qE "^(200|302)$"; then
                            echo "‚úÖ Nginx HTTPS accessible depuis Jenkins (HTTP ${HTTP_CODE})"
                            echo "   Firefox pourra se connecter via HTTPS"
                            break
                        fi
                        
                        echo "   HTTP ${HTTP_CODE} - retry dans 2s... (reste ${timeout}s)"
                        sleep 2
                        timeout=$((timeout - 2))
                    done
                    
                    if [ $timeout -le 0 ]; then
                        echo "‚ùå ERREUR: Nginx HTTPS inaccessible apr√®s 30s"
                        echo ""
                        echo "üîç Diagnostics:"
                        echo ""
                        echo "1. √âtat du conteneur nginx:"
                        docker ps --filter "name=nginx"
                        echo ""
                        echo "2. Ports √©cout√©s par nginx:"
                        docker exec rhdemo-staging-nginx netstat -tuln | grep LISTEN
                        echo ""
                        echo "3. Configuration nginx charg√©e:"
                        docker exec rhdemo-staging-nginx nginx -T 2>&1 | grep -A 5 "listen.*443"
                        echo ""
                        echo "4. Logs nginx (derni√®res 20 lignes):"
                        docker logs --tail=20 rhdemo-staging-nginx
                        echo ""
                        echo "5. Test DNS depuis Jenkins:"
                        docker exec ${JENKINS_CONTAINER} getent hosts rhdemo.staging.local
                        echo ""
                        exit 1
                    fi
                    
                    echo ""
                    echo "‚úÖ Stack compl√®te op√©rationnelle et accessible via HTTPS"
                    echo "   Pr√™t pour les tests Selenium"
                '''
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 5 : TESTS FONCTIONNELS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('üåê Tests Selenium IHM') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 5 : TESTS FONCTIONNELS'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '‚ñ∂ Ex√©cution des tests Selenium sur environnement Docker Compose...'
                }
                
                dir(TEST_PROJECT_PATH) {
                    sh """
                        . \${WORKSPACE}/rhDemo/secrets/env-vars.sh
                        
                        # URLs via nginx dans le r√©seau Docker avec HTTPS
                        # Firefox dans Jenkins doit utiliser les network aliases DNS Docker
                        # Car Jenkins container est connect√© √† rhdemo-staging-network
                        # Les aliases rhdemo.staging.local et keycloak.staging.local sont r√©solus via DNS Docker
                        # HTTPS utilis√© pour tester en conditions r√©elles (certificat auto-sign√© accept√© par setAcceptInsecureCerts)
                        APP_URL="https://rhdemo.staging.local"
                        KEYCLOAK_URL="https://rhdemo.staging.local/realms/RHDemo"

                        # Credentials de test (user avec ROLE_consult + ROLE_MAJ pour tester toutes les op√©rations)
                        # Ces variables seront pass√©es via propri√©t√©s Maven √† TestConfig
                        # Username charg√© depuis secrets-staging.yml (pas de valeur en dur)
                        TEST_USERNAME="\${RHDEMO_TEST_ID_USER_MAJ}"
                        TEST_PASSWORD="\${RHDEMO_TEST_PWD_USER_MAJ}"

                        echo "üìç Configuration des tests Selenium:"
                        echo "   APP_URL: \${APP_URL}"
                        echo "   KEYCLOAK_URL: \${KEYCLOAK_URL}"
                        echo "   TEST_USERNAME: \${TEST_USERNAME} (ROLE_consult + ROLE_MAJ)"
                        echo "   Mode: Headless"
                        echo "   (Healthcheck HTTPS valid√© avant ce stage)"

                        # Lancement des tests avec TOUTES les configs via propri√©t√©s Maven
                        # TestConfig charge dans l'ordre: Maven properties > env vars > YAML
                        cd \${WORKSPACE}/rhDemo && ./mvnw clean test -f ../\${TEST_PROJECT_PATH}/pom.xml \\
                            -Dtest.baseurl=\${APP_URL} \\
                            -Dtest.keycloak.url=\${KEYCLOAK_URL} \\
                            -Dselenium.headless=true \\
                            -Dtest.username=\${TEST_USERNAME} \\
                            -Dtest.password=\${TEST_PASSWORD}
                    """
                }
            }
            post {
                always {
                    script {
                        // Archivage des screenshots en cas d'√©chec
                        dir(TEST_PROJECT_PATH) {
                            archiveArtifacts artifacts: '**/screenshots/**/*.png', allowEmptyArchive: true
                            junit '**/target/surefire-reports/*.xml'
                        }
                    }
                }
            }
        }
        
        stage('üõë Arr√™t App Test') {
            when {
                expression { params.RUN_SELENIUM_TESTS == true }
            }
            steps {
                script {
                    echo '‚ñ∂ Arr√™t de l\'application test...'
                    sh '''
                        if [ -f app-test.container ]; then
                            CONTAINER=$(cat app-test.container)
                            echo "Arr√™t du container: $CONTAINER"
                            docker stop $CONTAINER 2>/dev/null || echo "‚úÖ Container d√©j√† arr√™t√©"
                            docker rm $CONTAINER 2>/dev/null || echo "‚úÖ Container d√©j√† supprim√©"
                            rm app-test.container
                        else
                            echo "‚úÖ Pas de container de test √† nettoyer"
                        fi
                    '''
                }
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 6 : ARCHIVAGE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('üìö Archivage Artifacts') {
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 6 : ARCHIVAGE'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '‚ñ∂ Archivage du JAR et des rapports...'
                }
                archiveArtifacts artifacts: "${JAR_FILE}", fingerprint: true
                archiveArtifacts artifacts: '**/target/surefire-reports/**', allowEmptyArchive: true
            }
        }
        
        stage('üìù G√©n√©ration Rapports') {
            steps {
                script {
                    echo '‚ñ∂ Publication des rapports...'
                }
                publishHTML([
                    reportDir: 'rhDemo/target/site/jacoco',
                    reportFiles: 'index.html',
                    reportName: 'Code Coverage',
                    allowMissing: true,
                    keepAll: true,
                    alwaysLinkToLastBuild: true
                ])
            }
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PHASE 7 : PRODUCTION (Simulation)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        stage('‚úã Validation Manuelle') {
            when {
                expression { 
                    params.DEPLOY_ENV == 'production' && params.SKIP_MANUAL_APPROVAL == false 
                }
            }
            steps {
                script {
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '  PHASE 7 : PRODUCTION (Simulation)'
                    echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                    echo '‚ñ∂ Approbation manuelle requise pour la production...'
                }
                timeout(time: 30, unit: 'MINUTES') {
                    input message: 'D√©ployer en production (SIMULATION) ?', 
                          ok: 'D√©ployer',
                          submitter: 'admin,deploy-team'
                }
            }
        }
        
        stage('üíæ Backup Base de Donn√©es (SIMULATION)') {
            when {
                expression { params.DEPLOY_ENV == 'production' }
            }
            steps {
                script {
                    echo '‚ñ∂ Sauvegarde de la base de donn√©es de production (SIMULATION)...'
                }
                sh '''
                    # Charger les secrets
                    . rhDemo/secrets/env-vars.sh
                    
                    BACKUP_FILE="db-backup-$(date +%Y%m%d-%H%M%S).sql"
                    echo "Cr√©ation du backup: ${BACKUP_FILE}"
                    # pg_dump -h ${PROD_SERVER} -U rhdemo rhdemo > ${BACKUP_FILE}
                    echo "‚úÖ Backup cr√©√© (SIMULATION)"
                '''
            }
        }
        
        stage('üåê D√©ploiement Production (SIMULATION)') {
            when {
                expression { params.DEPLOY_ENV == 'production' }
            }
            steps {
                script {
                    echo '‚ñ∂ D√©ploiement en PRODUCTION (SIMULATION)...'
                    echo 'üöÄ D√©ploiement Blue-Green...'
                }
                sh '''
                    # Charger les secrets et URLs de serveurs
                    . rhDemo/secrets/env-vars.sh
                    
                    # Strat√©gie Blue-Green deployment
                    echo "1. D√©ploiement sur le serveur Green..."
                    # scp ${JAR_FILE} user@${PROD_SERVER}-green:/opt/rhdemo/
                    
                    echo "2. D√©marrage du nouveau service..."
                    # ssh user@${PROD_SERVER}-green "systemctl start rhdemo-api"
                    
                    echo "3. V√©rification du healthcheck..."
                    # curl -f http://${PROD_SERVER}-green/actuator/health
                    
                    echo "4. Basculement du load balancer..."
                    # Commande pour basculer le trafic
                    
                    echo "5. Arr√™t de l'ancien service (Blue)..."
                    # ssh user@${PROD_SERVER}-blue "systemctl stop rhdemo-api"
                    
                    echo "‚úÖ D√©ploiement production (SIMULATION)"
                '''
            }
        }
        
        stage('‚úÖ V√©rification Post-D√©ploiement (SIMULATION)') {
            when {
                expression { params.DEPLOY_ENV == 'production' }
            }
            steps {
                script {
                    echo '‚ñ∂ V√©rification du d√©ploiement production...'
                }
                sh '''
                    # Charger les secrets et URLs de serveurs
                    . rhDemo/secrets/env-vars.sh
                    
                    echo "Healthcheck application..."
                    # curl -f http://${PROD_SERVER}/actuator/health
                    
                    echo "V√©rification des m√©triques Prometheus..."
                    # curl -f http://${PROD_SERVER}/actuator/prometheus
                    
                    echo "Test des endpoints critiques..."
                    # Tests automatis√©s sur la production
                    
                    echo "‚úÖ Application en production fonctionnelle (SIMULATION)"
                '''
            }
        }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // POST-ACTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    post {
        always {
            script {
                echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                echo '  NETTOYAGE ET NOTIFICATIONS'
                echo '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'
                
                // Pas de nettoyage DNS n√©cessaire: les alias Docker network
                // sont automatiquement supprim√©s avec le docker-compose down
                echo '‚úÖ R√©solution DNS via Docker network aliases (pas de nettoyage n√©cessaire)'

                // S√âCURIT√â : Nettoyage des fichiers contenant des secrets
                echo '‚ñ∂ Nettoyage s√©curis√© des fichiers de secrets...'
                sh '''
                    # √âcraser puis supprimer les fichiers contenant des secrets
                    if [ -f "rhDemo/secrets/env-vars.sh" ]; then
                        # √âcraser avec des z√©ros avant suppression (s√©curit√© suppl√©mentaire)
                        shred -vfz -n 3 rhDemo/secrets/env-vars.sh 2>/dev/null || rm -f rhDemo/secrets/env-vars.sh
                        echo "‚úÖ env-vars.sh supprim√© de mani√®re s√©curis√©e"
                    fi

                    if [ -f "rhDemo/secrets/secrets-rhdemo.yml" ]; then
                        # Nettoyer aussi le fichier secrets-rhdemo.yml g√©n√©r√© pour rhDemo (contient secrets limit√©s)
                        shred -vfz -n 3 rhDemo/secrets/secrets-rhdemo.yml 2>/dev/null || rm -f rhDemo/secrets/secrets-rhdemo.yml
                        echo "‚úÖ secrets-rhdemo.yml (rhDemo) supprim√© de mani√®re s√©curis√©e"
                    fi

                    if [ -f "${SECRETS_DECRYPTED}" ]; then
                        shred -vfz -n 3 ${SECRETS_DECRYPTED} 2>/dev/null || rm -f ${SECRETS_DECRYPTED}
                        echo "‚úÖ secrets-decrypted.yml supprim√© de mani√®re s√©curis√©e"
                    fi

                    # Nettoyer aussi le fichier de config Keycloak g√©n√©r√©
                    if [ -f "rhDemoInitKeycloak/src/main/resources/application-staging.yml" ]; then
                        shred -vfz -n 3 rhDemoInitKeycloak/src/main/resources/application-staging.yml 2>/dev/null || \
                        rm -f rhDemoInitKeycloak/src/main/resources/application-staging.yml
                        echo "‚úÖ application-staging.yml supprim√© de mani√®re s√©curis√©e"
                    fi
                '''

                // Conservation de l'environnement Docker Compose pour tests manuels
                if (params.RUN_SELENIUM_TESTS == true) {
                    def buildResult = currentBuild.result ?: 'SUCCESS'

                    if (buildResult != 'SUCCESS') {
                        echo "üìã R√©cup√©ration des logs Docker (build ${buildResult})..."
                        sh """
                            cd ${STAGING_INFRA_PATH} || exit 0
                            docker-compose -p ${COMPOSE_PROJECT_NAME} logs --tail=100 || true
                        """
                    }

                    echo '‚úÖ Environnement staging conserv√© pour tests manuels'
                    echo 'üìç Acc√®s √† l\'environnement:'
                    echo '   - Application rhDemo : https://rhdemo.staging.local'
                    echo '   - Keycloak Admin     : https://keycloak.staging.local'
                    echo ''
                    echo 'üîß Commandes utiles:'
                    echo "   - Logs app     : docker logs -f rhdemo-staging-app"
                    echo "   - Logs Keycloak: docker logs -f keycloak-staging"
                    echo "   - Arr√™ter      : cd ${STAGING_INFRA_PATH} && docker-compose -p ${COMPOSE_PROJECT_NAME} down -v"
                    echo ''
                    echo '‚ö†Ô∏è  IMPORTANT: L\'environnement sera automatiquement nettoy√© au prochain build'
                    echo '   Le nettoyage se fait en d√©but de pipeline (stage "Configuration Environnement Test")'
                }

                echo 'Note: Le nettoyage du workspace et de Docker se fait automatiquement au d√©but du prochain build'
            }
        }
        
        success {
            script {
                def deployInfo = params.DEPLOY_ENV != 'none' ? " et d√©ploy√© en ${params.DEPLOY_ENV}" : ""
                echo "‚úÖ Pipeline r√©ussi${deployInfo} !"
            }
            
            // Email de notification
            emailext(
                subject: "‚úÖ BUILD SUCCESS - RHDemo API #${env.BUILD_NUMBER}",
                body: """
                    Le build de RHDemo API a r√©ussi !
                    
                    Branch: ${env.BRANCH_NAME}
                    Commit: ${env.GIT_COMMIT}
                    D√©ploiement: ${params.DEPLOY_ENV}
                    
                    Voir les d√©tails: ${env.BUILD_URL}
                """,
                to: "${env.NOTIFICATION_EMAIL}"
            )
        }
        
        failure {
            script {
                echo "‚ùå Pipeline √©chou√© !"
            }
            
            // Email d'alerte
            emailext(
                subject: "‚ùå BUILD FAILED - RHDemo API #${env.BUILD_NUMBER}",
                body: """
                    ‚ö†Ô∏è Le build de RHDemo API a √©chou√© !
                    
                    Branch: ${env.BRANCH_NAME}
                    Stage: ${env.STAGE_NAME}
                    
                    Voir les logs: ${env.BUILD_URL}console
                """,
                to: "${env.NOTIFICATION_EMAIL}",
                attachLog: true
            )
        }
        
        unstable {
            script {
                echo "‚ö†Ô∏è Pipeline instable (tests √©chou√©s mais build r√©ussi)"
            }
        }
    }
}
